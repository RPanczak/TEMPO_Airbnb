---
title: "Airbnb - TMR report"
subtitle: "Data analysis"
# author: "Radoslaw Panczak & Thomas Sigler"
author:
- Radoslaw Panczak & Thomas Sigler
- Queensland Centre for Population Research
date: "`r format(Sys.time(), '%d %B, %Y')`"
geometry: "left=2cm,right=2cm,top=2cm,bottom=2cm"
output:
  pdf_document: 
    fig_caption: yes
    highlight: haddock
    keep_tex: no
    number_sections: yes
    toc: yes
    toc_depth: 2
header-includes: 

- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}

---

<!-- ------------------------------------------------------------ --> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      cache = FALSE,
                      fig.align="center",
                      fig.pos="H",
                      dpi = 300)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

set.seed(12345)
options(scipen = 999)

library(pacman) 
p_load(tidyverse, magrittr, lubridate, scales, janitor, imputeTS,
       sf, tmap, tmaptools, 
       sjPlot, sjmisc, kableExtra, gghighlight)

tmap_mode("plot") 
```

<!-- ------------------------------------------------------------ --> 

```{r include=FALSE}
SA2 <- readRDS("TMR/data/SA2.Rds")
SA2_centr <- readRDS("TMR/data/SA2_centr.Rds")
STE <- readRDS("TMR/data/STE.Rds")
monthly_new_prep_tmr <- readRDS("TMR/data/monthly_new_prep_tmr.Rds")
```

<!-- ------------------------------------------------------------ --> 

\newpage

# Active Airbnb listings

Qld plus NNSW. State as of `2019-02-01`. SA2 aggregates.

```{r, include=FALSE}
temp <- monthly_new_prep_tmr %>% 
  group_by(SA2_MAIN16) %>% 
  summarize(mean_occupancy_rate = mean(occupancy_rate, na.rm = TRUE),
            median_occupancy_rate = median(occupancy_rate, na.rm = TRUE))

airbnb_sa2_occupancy_rate <- left_join(st_drop_geometry(SA2), temp) %>% 
  expand(SA2_MAIN16) %>% 
  filter(!is.na(SA2_MAIN16)) %>% 
  left_join(st_drop_geometry(SA2)) %>% 
  left_join(temp) %>% 
  mutate_if(is.factor, as.character) %>% 
  ungroup() %>% 
  arrange(SA2_MAIN16)

n <- monthly_new_prep_tmr %>% 
  filter(reporting_month == ymd("2019-02-01")) %>% 
  group_by(SA2_MAIN16) %>% 
  summarize(n = n())

airbnb_sa2_occupancy_rate %<>% 
  left_join(n) %>% 
  tidyr::replace_na(list(n = 0)) 

# summary(airbnb_sa2_occupancy_rate$mean_occupancy_rate)
# summary(airbnb_sa2_occupancy_rate$median_occupancy_rate)
stopifnot(nrow(SA2) == nrow(airbnb_sa2_occupancy_rate))

rm(temp, n)
```

```{r}
descr(airbnb_sa2_occupancy_rate$n,
      show = c("n", "mean", "sd", "md", "range", "skew")) %>% 
  kable()
```

```{r, fig.height = 3 , fig.width = 4}
airbnb_sa2_occupancy_rate %>%
  dplyr::select(n) %>%
  plot_frq(type = "hist", show.mean = TRUE, geom.size = 10, show.sd = TRUE,
           ylim = c(0, 200)) +
  xlab("Number of properties in SA2") +
  ylab("Number of SA2 areas")

```

\newpage

```{r, include=FALSE}
SA2_centr %<>% 
  left_join(select(airbnb_sa2_occupancy_rate, SA2_MAIN16,
                   n, mean_occupancy_rate, median_occupancy_rate))
```


```{r, fig.height = 8 , fig.width = 6 }
# for verision with grey polygons?
# tm_shape(SA2) +
#   tm_polygons(col = "grey70", border.col = "white", lwd = 0.5) +
#   tm_shape(STE) +
#   tm_borders(col = "grey40", lwd = 1.0) 

tm_shape(SA2) +
  tm_borders(lwd = 0.5) +
  tm_shape(STE) +
  tm_borders(col = "grey20", lwd = 1.0) +
  tm_shape(SA2_centr) +
  tm_bubbles(size = "n", scale = 2, alpha = .5,
             col = "darkorchid4", border.lwd = 0.1, border.col = "white",
             legend.size.is.portrait = TRUE,
             title.size = "Number of listings in SA2. \nState on 2019-02-01") +
  tm_credits("Geodata (c) ABS; data (c) Airdna", position=c("RIGHT", "BOTTOM"), size = 0.5) +
  tm_layout("Number of Airbnb listings",
            # legend.title.size = 1,
            # legend.text.size = 0.6,
            legend.position = c("right","top"),
            # legend.bg.color = "white",
            legend.bg.alpha = 1)
```

\newpage

```{r, fig.height = 8 , fig.width = 6 }
tm_shape(SA2) +
  tm_borders(lwd = 0.5) +
  tm_shape(STE) +
  tm_borders(lwd = 1.0) +
  tm_shape(SA2_centr) +
  tm_bubbles(size = "n", scale = 2, shape = 1, 
             border.lwd = 0.5, col = "darkorchid4",
             legend.size.is.portrait = TRUE,
             title.size = "Number of listings in SA2. \nState on 2019-02-01") +
  tm_credits("Geodata (c) ABS; data (c) Airdna", position=c("RIGHT", "BOTTOM"), size = 0.5) +
  tm_layout("Number of Airbnb listings",
            # legend.title.size = 1,
            # legend.text.size = 0.6,
            legend.position = c("right","top"),
            # legend.bg.color = "white",
            legend.bg.alpha = 1)
```

\newpage

```{r, fig.height = 8 , fig.width = 6 }
SA2_centr_zoom <- SA2_centr %>% 
  filter(GCC_NAME16 %in% c("Greater Brisbane", "Rest of NSW") | SA4_NAME16 == "Sunshine Coast")

SA2_zoom <- SA2 %>% 
  filter(GCC_NAME16 %in% c("Greater Brisbane", "Rest of NSW") | SA4_NAME16 == "Sunshine Coast")

tm_shape(SA2_zoom) +
  tm_borders(lwd = 0.5) +
  tm_shape(STE) +
  tm_borders(lwd = 1.0) +
  tm_shape(SA2_centr_zoom) +
  tm_bubbles(size = "n", 
             col = "darkorchid4", border.lwd = 0.1, border.col = "white",
             legend.size.is.portrait = TRUE,
             title.size = "Number of properties in SA2. \nState on 2019-02-01") +
  tm_credits("Geodata (c) ABS; data (c) Airdna", position=c("RIGHT", "BOTTOM"), size = 0.5) +
  tm_layout("Number of Airbnb listings",
            # legend.title.size = 1,
            # legend.text.size = 0.6,
            legend.position = c("left","bottom"),
            legend.bg.color = "white",
            legend.bg.alpha = 1)
```

\newpage
\blandscape

```{r, fig.height = 6 , fig.width = 8 }
SA2_centr_zoom <- SA2_centr %>% 
  filter(SA4_NAME16 == "Brisbane Inner City")

SA2_zoom <- SA2 %>% 
  filter(SA4_NAME16 == "Brisbane Inner City")

tm_shape(SA2_zoom) +
  tm_borders(lwd = 0.5) +
  tm_shape(STE) +
  tm_borders(lwd = 1.0) +
  tm_shape(SA2_centr_zoom) +
  tm_bubbles(size = "n", 
             col = "darkorchid4", border.lwd = 0.1, border.col = "white",
             legend.size.is.portrait = TRUE,
             title.size = "Number of properties in SA2. \nState on 2019-02-01"
  ) +
  tm_credits("Geodata (c) ABS; data (c) Airdna", position=c("RIGHT", "BOTTOM"), size = 0.5) +
  tm_layout("Number of Airbnb listings",
            # legend.title.size = 1,
            # legend.text.size = 0.6,
            legend.position = c("left","top"),
            legend.bg.color = "white",
            legend.bg.alpha = 1)
```

\elandscape

<!-- ------------------------------------------------------------ --> 

\newpage

# Mean occupancy of Airbnb listings

Average of individual listings in SA2 area; Qld plus NNSW; using data from `2016-01-01` to `2019-02-01` period.

```{r}
descr(airbnb_sa2_occupancy_rate$mean_occupancy_rate,
      show = c("n", "mean", "sd", "md", "range", "skew")) %>% 
  kable()
```

```{r, fig.height = 3 , fig.width = 4}
airbnb_sa2_occupancy_rate %>%
  dplyr::select(mean_occupancy_rate) %>%
  plot_frq(type = "hist", show.mean = TRUE, geom.size = 0.02, show.sd = TRUE,
           ylim = c(0, 100)) +
  xlab("Mean occupancy rate in SA2") +
  ylab("Number of SA2 areas")

```

\newpage

```{r, fig.height = 8 , fig.width = 6 }
tm_shape(SA2) +
  tm_borders(lwd = 0.5) +
  tm_shape(STE) +
  tm_borders(lwd = 1.0) +
  tm_shape(SA2_centr) +
  tm_bubbles(size = "n", 
             col = "mean_occupancy_rate", 
             n = 5, palette = "RdYlGn",
             border.lwd = 0.1, border.col = "white",
             legend.size.is.portrait = TRUE,
             title.size = "Number of listings (2019-02-01)",
             title.col = "Mean occupancy of listings in SA2. \nAverage from 2016-01-01 to 2019-02-01") +
  tm_credits("Geodata (c) ABS; data (c) Airdna", position=c("RIGHT", "BOTTOM"), size = 0.5) +
  tm_layout("Occupancy of Airbnb listings",
            # legend.title.size = 1,
            # legend.text.size = 0.6,
            legend.position = c("right","top"),
            # legend.bg.color = "white",
            legend.bg.alpha = 1)
```

\newpage

```{r, fig.height = 8 , fig.width = 6 }
SA2_centr_zoom <- SA2_centr %>% 
  filter(GCC_NAME16 %in% c("Greater Brisbane", "Rest of NSW") | SA4_NAME16 == "Sunshine Coast")

SA2_zoom <- SA2 %>% 
  filter(GCC_NAME16 %in% c("Greater Brisbane", "Rest of NSW") | SA4_NAME16 == "Sunshine Coast")

tm_shape(SA2_zoom) +
  tm_borders(lwd = 0.5) +
  tm_shape(STE) +
  tm_borders(lwd = 1.0) +
  tm_shape(SA2_centr_zoom) +
  tm_bubbles(size = "n", 
             col = "mean_occupancy_rate", 
             n = 5, palette = "RdYlGn",
             border.lwd = 0.1, border.col = "white",
             legend.size.is.portrait = TRUE,
             title.size = "Number of listings (2019-02-01)",
             title.col = "Mean occupancy of listings in SA2. \nAverage from 2016-01-01 to 2019-02-01") +
  tm_credits("Geodata (c) ABS; data (c) Airdna", position=c("RIGHT", "BOTTOM"), size = 0.5) +
  tm_layout("Occupancy of Airbnb listings",
            # legend.title.size = 1,
            # legend.text.size = 0.6,
            legend.position = c("left","bottom"),
            # legend.bg.color = "white",
            legend.bg.alpha = 1)
```

\newpage
\blandscape

```{r, fig.height = 6 , fig.width = 8 }
SA2_centr_zoom <- SA2_centr %>% 
  filter(SA4_NAME16 == "Brisbane Inner City")

SA2_zoom <- SA2 %>% 
  filter(SA4_NAME16 == "Brisbane Inner City")

tm_shape(SA2_zoom) +
  tm_borders(lwd = 0.5) +
  tm_shape(STE) +
  tm_borders(lwd = 1.0) +
  tm_shape(SA2_centr_zoom) +
  tm_bubbles(size = "n", 
             col = "mean_occupancy_rate", 
             n = 5, palette = "RdYlGn",
             border.lwd = 0.1, border.col = "white",
             legend.size.is.portrait = TRUE,
             title.size = "Number of listings (2019-02-01)",
             title.col = "Mean occupancy of listings in SA2. \nAverage from 2016-01-01 to 2019-02-01") + 
  tm_credits("Geodata (c) ABS; data (c) Airdna", position=c("RIGHT", "BOTTOM"), size = 0.5) +
  tm_layout("Number of Airbnb listings",
            # legend.title.size = 1,
            # legend.text.size = 0.6,
            legend.position = c("left","top"),
            # legend.bg.color = "white",
            legend.bg.alpha = 1)
```

\elandscape

<!-- ------------------------------------------------------------ --> 

\newpage

# Temporal trends

## Number of Airbnb listings

```{r, include=FALSE}
airbnb_sa2_month_agg <- monthly_new_prep_tmr %>% 
  group_by(reporting_month) %>% 
  summarize(supply = n(),
            mean_occupancy_rate = mean(occupancy_rate, na.rm = TRUE))
```

```{r}
descr(airbnb_sa2_month_agg$supply,
      show = c("n", "mean", "sd", "md", "range", "skew")) %>% 
  kable()
```

\blandscape

```{r, fig.height = 6 , fig.width = 8 }
airbnb_sa2_month_agg %>%
  ggplot(aes(reporting_month, supply)) + 
  geom_col() +
  ylab("Number of listings") +
  xlab("")
```

\elandscape

## Mean occupancy rate

Average value of SA2 area in given month constructed from all listings in this area. 

Monthly averages of SA2-level means:

```{r}
descr(airbnb_sa2_month_agg$mean_occupancy_rate,
      show = c("n", "mean", "sd", "md", "range", "skew")) %>% 
  kable()
```

\blandscape

```{r, fig.height = 6 , fig.width = 8 }
airbnb_sa2_month_agg %>%
  ggplot(aes(reporting_month, mean_occupancy_rate)) + 
  geom_col() +
  ylab("Mean occupancy rate of SA2 areas") +
  xlab("")
```

\elandscape

## Number of Airbnb listings by number of bedrooms

```{r, include=FALSE}
airbnb_sa2_month_bed_agg <- monthly_new_prep_tmr %>% 
  group_by(reporting_month, bedrooms) %>% 
  summarize(supply = n())
```

```{r}
airbnb_sa2_month_bed_agg %>% 
  group_by(bedrooms) %>% 
  summarize(n = n(),
            mean = mean(supply, na.rm = TRUE),
            SD = sd(supply, na.rm = TRUE),
            min = min(supply, na.rm = TRUE),
            max = max(supply, na.rm = TRUE)) %>% 
  kable()
```

\blandscape

```{r, fig.height = 6 , fig.width = 8 }
airbnb_sa2_month_bed_agg %>%
  ggplot(aes(reporting_month, supply, fill = as.factor(bedrooms))) + 
  geom_col(position = "dodge") +
  scale_fill_viridis_d(direction = -1) +
  ylab("Number of listings") +
  xlab("")  + labs(fill = "No of bedrooms")
```

\elandscape

## Number of Airbnb listings by listing type

```{r, include=FALSE}
airbnb_sa2_month_list_agg <- monthly_new_prep_tmr %>% 
  group_by(reporting_month, listing_type) %>% 
  summarize(supply = n())
```

```{r}
airbnb_sa2_month_list_agg %>% 
  group_by(listing_type) %>% 
  summarize(n = n(),
            mean = mean(supply, na.rm = TRUE),
            SD = sd(supply, na.rm = TRUE),
            min = min(supply, na.rm = TRUE),
            max = max(supply, na.rm = TRUE)) %>% 
  kable()
```

\blandscape

```{r, fig.height = 6 , fig.width = 8 }
airbnb_sa2_month_list_agg %>%
  ggplot(aes(reporting_month, supply, fill = as.factor(listing_type))) + 
  geom_col(position = "dodge") +
  scale_fill_viridis_d(direction = 1) +
  ylab("Number of listings") +
  xlab("")  + labs(fill = "Listing type")
```

\elandscape

## Number of Airbnb listings by listing type

```{r, include=FALSE}
airbnb_sa2_month_prop_agg <- monthly_new_prep_tmr %>% 
  group_by(reporting_month, property_type_new) %>% 
  summarize(supply = n()) %>% 
  mutate(property_type_new = ifelse(property_type_new == "Unit", "Apartment", property_type_new)) %>% 
  mutate(property_type_new = ifelse(property_type_new == "", "Other", property_type_new))

```

```{r}
airbnb_sa2_month_prop_agg %>% 
  group_by(property_type_new) %>% 
  summarize(n = n(),
            mean = mean(supply, na.rm = TRUE),
            SD = sd(supply, na.rm = TRUE),
            min = min(supply, na.rm = TRUE),
            max = max(supply, na.rm = TRUE)) %>% 
  kable()
```

\blandscape

```{r, fig.height = 6 , fig.width = 8 }
airbnb_sa2_month_prop_agg %>%
  ggplot(aes(reporting_month, supply, fill = as.factor(property_type_new))) + 
  geom_col(position = "dodge") +
  scale_fill_viridis_d(direction = 1) +
  ylab("Number of listings") +
  xlab("")  + labs(fill = "Property type")
```

\elandscape

## Number of Airbnb listings by SA4 area

```{r, include=FALSE}
airbnb_sa2_month_sa4_agg <- monthly_new_prep_tmr %>% 
  group_by(reporting_month, SA4_NAME16) %>% 
  summarize(supply = n()) %>% 
  ungroup()
```

```{r}
airbnb_sa2_month_sa4_agg %>% 
  group_by(SA4_NAME16) %>% 
  summarize(
    # n = n(),
    mean = mean(supply, na.rm = TRUE),
    SD = sd(supply, na.rm = TRUE),
    min = min(supply, na.rm = TRUE),
    max = max(supply, na.rm = TRUE)) %>% 
    dplyr::mutate_if(is.numeric, format, digits = 0, big.mark = ",") %>% 
  kableExtra::kable("latex", booktabs = T) %>% 
  kable_styling(latex_options = "striped")
```

\blandscape

```{r, fig.height = 6 , fig.width = 8 }
airbnb_sa2_month_sa4_agg %>%
  ggplot(aes(reporting_month, supply, color = as.factor(SA4_NAME16))) + 
  geom_line() +
  scale_color_viridis_d(direction = 1) +
  ylab("Number of listings in SA4") +
  xlab("")  + labs(colour = "SA4 name") +
  gghighlight(max(supply) > 900, label_key = SA4_NAME16)
```

\elandscape

## Number of Airbnb listings by SA2 area

```{r, include=FALSE}
airbnb_sa2_month_sa2_agg <- monthly_new_prep_tmr %>% 
  group_by(reporting_month, SA2_NAME16) %>% 
  summarize(supply = n()) %>% 
  ungroup()
```

```{r}
airbnb_sa2_month_sa2_agg %>% 
  group_by(SA2_NAME16) %>% 
  summarize(
    # n = n(),
    mean = mean(supply, na.rm = TRUE),
    SD = sd(supply, na.rm = TRUE),
    min = min(supply, na.rm = TRUE),
    max = max(supply, na.rm = TRUE)) %>% 
    dplyr::mutate_if(is.numeric, format, digits = 0, big.mark = ",") %>% 
  kableExtra::kable(format = "latex", longtable = T, booktabs = T) %>% 
  kable_styling(latex_options = "striped")
```

\blandscape

```{r, fig.height = 6 , fig.width = 8 }
airbnb_sa2_month_sa2_agg %>%
  ggplot(aes(reporting_month, supply, color = as.factor(SA2_NAME16))) + 
  geom_line() +
  scale_color_viridis_d(direction = 1) +
  ylab("Number of listings in SA2") +
  xlab("")  + labs(colour = "SA4 name") +
  gghighlight(max(supply) > 600, label_key = SA2_NAME16)
```

\elandscape

# Data export

```{r, include=FALSE}
# Bedrooms
temp <- monthly_new_prep_tmr %>% 
  filter(reporting_month == ymd("2019-02-01")) %>% 
  group_by(SA2_MAIN16, bedrooms) %>% 
  summarize(supply = n()) %>% 
  ungroup() %>% 
  mutate(bedrooms = paste0("bedrooms_", bedrooms)) %>% 
  pivot_wider(names_from = bedrooms, values_from = supply) %>% 
  replace(is.na(.), 0)

airbnb_sa2_tmr_export <- airbnb_sa2_occupancy_rate %>% 
  left_join(temp) %>% 
  tidyr::replace_na(list(bedrooms_0 = 0, bedrooms_1 = 0, bedrooms_2 = 0, bedrooms_3 = 0, bedrooms_4 = 0)) 

# House & units
temp <- monthly_new_prep_tmr %>% 
  filter(reporting_month == ymd("2019-02-01")) %>% 
  filter(property_type_new != "") %>% 
  group_by(SA2_MAIN16, property_type_new) %>% 
  summarize(supply = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = property_type_new, values_from = supply) %>% 
  replace(is.na(.), 0) %>% 
  rename(house = House, unit = Unit)

airbnb_sa2_tmr_export %<>% 
  left_join(temp) %>% 
  tidyr::replace_na(list(house = 0, unit = 0)) 

stopifnot(airbnb_sa2_tmr_export$n >= as.integer(airbnb_sa2_tmr_export$house) + as.integer(airbnb_sa2_tmr_export$unit))

# Entire & room/shared
temp <- monthly_new_prep_tmr %>% 
  filter(reporting_month == ymd("2019-02-01")) %>% 
  group_by(SA2_MAIN16, listing_type) %>% 
  summarize(supply = n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = listing_type, values_from = supply) %>% 
  replace(is.na(.), 0) %>% 
  rename(entire_home_apt = `Entire home/apt`,
         private_room = `Private room`,
         shared_room = `Shared room`)

airbnb_sa2_tmr_export %<>% 
  left_join(temp) %>% 
  tidyr::replace_na(list(entire_home_apt = 0, private_room = 0, shared_room = 0)) 

write_csv(airbnb_sa2_tmr_export, "TMR/data/airbnb_sa2_tmr_export.csv", na = "NA")
```

Exported data file has following structure:

```{r}
glimpse(airbnb_sa2_tmr_export)
```

Variables from `SA2_MAIN16` to `STE_NAME16` describe SA2 areas as per ASGS standards.

`mean_occupancy_rate` - mean occupancy rate of all listings in the SA2 calculated using `2016-01-01` to `2019-02-01` data; missing if zero properties in area

`median_occupancy_rate`- mean occupancy rate of all listings in the SA2 calculated using `2016-01-01` to `2019-02-01` data; missing if zero properties in area

`n`
`bedrooms_0` - number of listings classified as studios in the SA2 calculated using `2019-02-01` data

`bedrooms_1` - number of listings classified as 1 bedroom in the SA2 calculated using `2019-02-01` data

`bedrooms_2`- number of listings classified as 2 bedrooms in the SA2 calculated using `2019-02-01` data

`bedrooms_3`- number of listings classified as 3 bedrooms in the SA2 calculated using `2019-02-01` data

`bedrooms_4`- number of listings classified as 4 or more bedrooms in the SA2 calculated using `2019-02-01` data

`house`- number of listings classified as houses in the SA2 calculated using `2019-02-01` data

`unit`- number of listings classified as units in the SA2 calculated using `2019-02-01` data

`entire_home_apt`- number of listings classified as entire home/apartment in the SA2 calculated using `2019-02-01` data

`private_room`- number of listings classified as private rooms in the SA2 calculated using `2019-02-01` data

`shared_room`- number of listings classified as shared rooms in the SA2 calculated using `2019-02-01` data
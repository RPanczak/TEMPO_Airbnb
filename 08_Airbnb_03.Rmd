---
title: "Airbnb data 03"
author: "Radoslaw Panczak"
date: "`r format(Sys.time(), '%d %B, %Y')`"
mainfont: DejaVu Sans
output: 
  html_document: 
    # css: custom.css
    toc: true
    toc_depth: 4
    toc_float: true
    number_sections: true
    theme: united 
    highlight: pygments 
---

<!-- ------------------------------------------------------------ --> 
<!-- ------------------------------------------------------------ --> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width=8, fig.height=6, dpi=300, out.width="800px", out.height="600px")

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

set.seed(12345)
options(scipen = 999)

library(pacman) 
p_load(tidyverse, magrittr, sf, tmap, skimr, summarytools, kableExtra, naniar, janitor)

tmap_mode("view") # makes map interactive

```

```{r geodata_prep, eval=FALSE}
SA1_2016_join_new <- read_csv("./data/airdna/raw/Spatial_join/SA1_2016_join_new.csv") %>% 
  dplyr::rename(property_id = PROPERTY_ID) %>% 
  select(-XCoord, -YCoord)

saveRDS(SA1_2016_join_new, file = "./data/airdna/clean/SA1_2016_join_new.rds")

POA_2016_join_new <- read_csv("./data/airdna/raw/Spatial_join/POA_2016_join_new.csv") %>% 
  select(PROPERTY_ID, POA_CODE16) %>% 
  dplyr::rename(property_id = PROPERTY_ID) # %>% mutate(POA_CODE16 = as.numeric(POA_CODE16))

saveRDS(POA_2016_join_new, file = "./data/airdna/clean/POA_2016_join_new.rds")
```


<!-- ------------------------------------------------------------ --> 
<!-- ------------------------------------------------------------ --> 

# Summary 

This is an overview of **raw** second `Airdna` dataset. 

Separate preparation is done for 'properties' and 'monthly_new' datasets. 

<!-- ------------------------------------------------------------ --> 
<!-- ------------------------------------------------------------ --> 

# Properties

```{r, include=FALSE}
property_new_raw <- read_csv("./data/airdna/raw/Australia_Airbnb_property_2019-02-01.csv")

# any(duplicated(property_new_raw$`property_new ID`))
# length(unique(property_new_raw$`property_new ID`))
# any(duplicated(property_new_raw$`Host ID`))
# length(unique(property_new_raw$`Host ID`))
```


## General

```{r, include=FALSE}
property_new <- property_new_raw %>% 
  clean_names() %>%
  remove_empty(c("rows", "cols")) %>% 
  select(-country) %>% 
  mutate(latitude = ifelse(property_id == 1476936, latitude*-1, latitude))

SA1_2016_join_new <- readRDS("./data/airdna/clean/SA1_2016_join_new.rds") %>% 
  dplyr::select(property_id, starts_with("SA1"), starts_with("SA2"), starts_with("SA3"), starts_with("SA4"), starts_with("STE"))

property_new %<>% left_join(SA1_2016_join_new)
# table(is.na(property_new$SA1_MAIN16))
rm(property_new_raw, SA1_2016_join_new)
gc()
```

* All variable names were converted to lower caps
* Dots/gaps in the names were replaced by single underscores.
* One location with wrong coordinates (`property_id` == 1476936) was fixed (wrong hemmisphere!).
* Completely empty variables (`Zipcode` and `Metropolitan_Statistical_Area`) were dropped.
* Variable `Country` was droped. 
* Data was spatially linked to ABS geography with SA1 and above level variables added.

Raw dataset consists of `r nrow(property_new)` records of Austrlian Airbnb properties as scraped by Airdna. 

Dataset consists of `r ncol(property_new)` variables:

```{r}
names(property_new)
```

## Data structure

```{r, results='asis'}
# skim(property_new)
skim(property_new) %>% skimr::kable() 
```

## Missing data

```{r}
gg_miss_var(property_new, show_pct = TRUE)
```

## property_new type

```{r, include=FALSE}
property_new %<>%
  mutate(property_type_orig = property_type) %>% 
  mutate(property_type = ifelse(property_type == "Bed &amp; Breakfast", "Bed & Breakfast", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Heritage hotel (India)", "Heritage hotel", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Serviced apartment", "Apartment", property_type)) %>% 
  mutate(property_type = ifelse(grepl("Private room in", property_type), "Private room", property_type)) %>% 
  mutate(property_type = ifelse(grepl("Shared room in", property_type), "Shared room", property_type)) %>% 
  # mutate(Created_Date = as.Date(Created_Date)) %>% 
  # mutate(Last_Scraped_Date = as.Date(Last_Scraped_Date)) %>% 
  # mutate(Calendar_Last_Updated = as.Date(Calendar_Last_Updated)) %>% 
  mutate(property_type = str_replace_all(property_type, 'Entire ', '')) %>% 
  mutate(property_type = R.utils::capitalize(property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Bed & breakfast", "Bed & Breakfast", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Earth House", "Earth house", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Van", "Camper/RV", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Loft", "Apartment", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Condominium", "House", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Townhouse", "House", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Guesthouse", "House", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Holiday home", "House", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Villa", "House", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Vacation home", "House", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Hostel", "Hotels", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Heritage hotel", "Hotels", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Dorm", "Hotels", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Boutique hotel", "Hotels", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Bed & Breakfast", "Hotels", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Tent", "Tents", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Yurt", "Tents", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Tipi", "Tents", property_type)) %>% 
  mutate(property_type = ifelse(property_type == "Igloo", "Tents", property_type))

saveRDS(property_new, "./data/airdna/clean/property_new.Rds")

```

`property_new type` variable was simplified:

* `Bed & Breakfast` spelling & typo variations were cleaned
* `Serviced apartment` and `Loft` were merged to `Apartment`
* All the combinations of `Private room in ...` were replaced to `Private room` 
* Same for `Shared room in ...` 
* Places names labelled as `Entire ...` had this word removed (see below for entire issue) 
* `Van` was merged with `Camper/RV` category
* `Condominium`, `Townhouse`, `Guesthouse`, `Holiday home`, `Villa` and `Vacation home` were merged to form category **`House`**
* `Hostel`, `Heritage hotel`, `Dorm`, `Boutique hotel`, `Bed & Breakfast` were merged to form category **`Hotels`**
* `Tent`, `Yurt`, `Tipi`, `Igloo` were merged to form category **`Tents`**

TODO >> further simplify?
* Cottage?
* Chalet?
* Nature lodge?
* Casa particular?

Still quite few categories with small numbers: 

```{r, fig.width=8, fig.height=8, out.width="800px", out.height="800px"}
# frq(property_new, property_type)
ggplot(property_new, aes(property_type))+ 
  geom_bar() + coord_flip() + theme_minimal()
```


## Listing Type

```{r, fig.width=4, fig.height=3, out.width="400px", out.height="300px"}
# tab(property_new, Listing_Type)
# tab(property_new, property_type, Listing_Type)
# filter(property_new, !is.na(Listing_Type)) %>% 
# ggplot(aes(property_type))+ 
#   geom_bar() +
#   coord_flip() + 
#   facet_wrap(~Listing_Type, ncol = 3)
ggplot(property_new, aes(listing_type))+ 
  geom_bar() + coord_flip() + theme_minimal()
```


## Created Date

```{r}
ggplot(property_new, aes(created_date))+ 
  geom_bar() + theme_minimal()
```

## Occupancy Rate

```{r, fig.width=4, fig.height=3, out.width="400px", out.height="300px"}
property_new %>% 
  select(occupancy_rate_ltm) %>% 
  summarytools::descr(stats = c("mean", "med", "min", "max")) 

ggplot(property_new, aes(occupancy_rate_ltm)) +
  geom_histogram() + theme_minimal()
```

## Bedrooms

```{r, fig.width=4, fig.height=3, out.width="400px", out.height="300px"}
property_new %>% 
  select(bedrooms) %>% 
  summarytools::descr(stats = c("mean", "med", "min", "max")) 

ggplot(property_new, aes(bedrooms)) +
  geom_histogram(binwidth = 1) + theme_minimal()
```

## Max Guests

```{r, fig.width=4, fig.height=3, out.width="400px", out.height="300px"}
property_new %>% 
  select(max_guests) %>% 
  summarytools::descr(stats = c("mean", "med", "min", "max")) 

ggplot(property_new, aes(max_guests)) +
  geom_histogram(binwidth = 1) + theme_minimal()
```


```{r}
property_new_select <- property_new %>% 
  select(property_id, host_id, 
         property_type, listing_type, created_date, last_scraped_date,  
         bedrooms, bathrooms, max_guests, 
         latitude, longitude, listing_url,
         starts_with("SA1"), starts_with("SA2"), starts_with("SA3"), starts_with("SA4"), starts_with("STE"))

# write_csv(property_new_select, "./data/airdna/clean/property_new_select.csv")
saveRDS(property_new_select, "./data/airdna/clean/property_new_select.Rds")

# rm(property_new)
```


<!-- ------------------------------------------------------------ --> 
<!-- ------------------------------------------------------------ --> 

# Monthly

```{r, include=FALSE}
monthly_new_raw <- read_csv("./data/airdna/raw/Australia_Airbnb_Monthly_2019-03-22.csv")

# any(duplicated(monthly_new_raw$`property_new ID`))
# length(unique(monthly_new_raw$`property_new ID`))
# any(duplicated(monthly_new_raw$`Host ID`))
# length(unique(monthly_new_raw$`Host ID`))
```

Raw dataset consists of `r nrow(monthly_new_raw)` records of `monthly_new` statistics of Austrlian Airbnb properties scraped by Airdna. 

## General

```{r, include=FALSE}
# temp <- filter(monthly_new_raw, `Property ID` == 1476936)

monthly_new <- monthly_new_raw %>% 
  clean_names() %>%
  remove_empty(c("rows", "cols")) %>% 
  select(-country, -state, -city, -neighborhood) %>% 
  mutate(latitude = ifelse(property_id == 1476936, latitude*-1, latitude)) %>% 
  dplyr::rename(property_type_orig = property_type) %>% 
  arrange(property_id, reporting_month)

# monthly_new %>%
#   select(property_id, latitude, longitude) %>%
#   group_by(property_id) %>% 
#   summarise(latitude = first(latitude),
#             longitude = first(longitude)) %>% 
#   arrange(property_id) %>%
#   write_csv("./data/airdna/clean/property_new_geo.csv")

rm(monthly_new_raw)
gc()
```

* Dots\spaces in the names were replaced by (single) underscores.
* One location with wrong coordinates (`property_id` == 1476936) was fixed.
* Completely empty variables (`Zipcode` and `Metropolitan_Statistical_Area`) were dropped.
* Variable `Country` was droped. 
* Variables `State`, `City` and `Neighborhood` were droped (no clue how assigned; will be added from ABS data linked spatially by coordinates)

Dataset consists of `r nrow(monthly_new)` records in `r ncol(monthly_new)` variables:

```{r}
names(monthly_new)
```

## Data structure

```{r, results='asis'}
# skim(monthly_new)
skim(monthly_new) %>% skimr::kable()
```

## Missing data

```{r}
gg_miss_var(monthly_new, show_pct = TRUE)
```

## Reporting Month

```{r, fig.width=8, fig.height=8, out.width="800px", out.height="800px"}
# tab(property_new, property_type)
ggplot(monthly_new, aes(reporting_month)) + 
  geom_bar() + coord_flip() + theme_minimal()
```

Clearly not all propoerties have all months!

Number of months property has data on: 

```{r}
monthly_new %>% 
  group_by(property_id) %>% 
  summarise(Months = n()) %>% 
  ungroup() %>% 
  ggplot(aes(Months)) + 
  geom_bar() + theme_minimal()
```

**Clear peaks at certain periods?**

## Active

```{r, fig.width=4, fig.height=3, out.width="400px", out.height="300px"}
ggplot(monthly_new, aes(active))+ 
  geom_bar() + theme_minimal()
```

## Occupancy Rate

```{r, fig.width=4, fig.height=3, out.width="400px", out.height="300px"}
monthly_new %>% 
  select(occupancy_rate) %>% 
  summarytools::descr(stats = c("mean", "med", "min", "max")) 

ggplot(monthly_new, aes(occupancy_rate)) +
  geom_histogram() + theme_minimal()
```

## `revenue_native`

```{r, fig.width=4, fig.height=3, out.width="400px", out.height="300px"}
monthly_new %>% 
  select(revenue_native) %>% 
  summarytools::descr(stats = c("mean", "med", "min", "max")) 

# monthly_new %>% 
#   # filter(revenue_native > 0) %>% 
#   # filter(revenue_native < 1000000) %>% 
#   ggplot(aes(`Revenue_(Native)`)) +
#   geom_histogram() + theme_minimal()
```


```{r}
# write_csv(monthly_new, "./Data/Airbnb/clean/monthly_new.csv")
saveRDS(monthly_new, "./data/airdna/clean/monthly_new.Rds")

monthly_new_select <- monthly_new %>% 
  select(property_id, reporting_month, 
         number_of_reservations, occupancy_rate, reservation_days, available_days, blocked_days,
         revenue_usd, revenue_native, adr_usd, adr_native)

# write_csv(monthly_new_select, "./data/airdna/clean/monthly_new_select.csv")
saveRDS(monthly_new_select, "./data/airdna/clean/monthly_new_select.Rds")

# rm(monthly_new)
```

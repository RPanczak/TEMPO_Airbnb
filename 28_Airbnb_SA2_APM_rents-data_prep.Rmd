---
title: "Airbnb"
subtitle: "APM rents on SA2 level"
author: "Radoslaw Panczak"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    highlight: pygments
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 4
    toc_float: yes
---

<!-- ------------------------------------------------------------ --> 
<!-- ------------------------------------------------------------ --> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      fig.width=8, fig.height=6, 
                      out.width="800px", out.height="600px", 
                      dpi=300)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
set.seed(12345)
options(scipen = 999)

library(pacman) 
p_load(tidyverse, magrittr, lubridate, scales, readxl, janitor, imputeTS,
       sf, tmap, tmaptools, 
       ggridges, skimr, summarytools, sjmisc, kableExtra, naniar)

tmap_mode("view") # makes map interactive
```

# SA2 areas

```{r include=FALSE}
SA2_raw <- st_read("./data/geo/1270055001_sa2_2016_aust_shape/SA2_2016_AUST.shp", 
                   stringsAsFactors = FALSE)
```

There are `r comma(nrow(SA2_raw))` SA2 areas in Australia. We excluded areas with no physical location (including `r comma(nrow(filter(SA2_raw, grepl("Migratory - Offshore - Shipping", SA2_NAME16))))` `Migratory–Offshore–Shipping` and `r comma(nrow(filter(SA2_raw, grepl("No usual address", SA2_NAME16))))` `No usual address` codes for each State and Territory). And `r comma(nrow(filter(SA2_raw, SA2_5DIG16 %in% c("91001", "91002", "91004", "11161"))))` remote areas: 

```{r}
SA2_raw %>% 
  filter(SA2_5DIG16 %in% c("91001", "91002", "91004", "11161")) %>% 
  select(SA2_NAME16, STE_NAME16) %>% 
  st_drop_geometry()
```

```{r geodata_load, include=FALSE}
# SA2
SA2 <- readRDS(file = "./data/geo/SA2_2016_AUST_clean.rds") %>% 
  # filter(SA4_CODE16 != "901") %>% 
  filter(! SA2_5DIG16 %in% c("91001", "91002", "91004", "11161")) %>% 
  select(-starts_with("SA3")) %>% 
  select(-starts_with("SA1")) %>% 
  select(-starts_with("GCC")) %>% 
  select(-AREASQKM16) %>% 
  mutate(STE_CODE16 = as.numeric(as.character(STE_CODE16))) %>% 
  mutate(SA2_MAIN16 = as.numeric(as.character(SA2_MAIN16))) %>% 
  mutate(SA2_5DIG16 = as.numeric(as.character(SA2_5DIG16))) %>% 
  mutate(SA4_CODE16 = as.numeric(as.character(SA4_CODE16))) %>% 
  mutate(SA4_GCC_CODE16 = case_when(
    SA4_CODE16 %in% c(402, 403, 404) ~ 401,
    SA4_CODE16 %in% c(302:305, 310, 311, 313, 314) ~ 301,
    SA4_CODE16 %in% c(207:214) ~ 206,
    SA4_CODE16 %in% c(503:507) ~ 502,
    SA4_CODE16 %in% c(115:128 ) ~ 102,
    TRUE ~ SA4_CODE16
  )
  ) %>% 
  mutate(SA4_GCC_NAME16 = case_when(
    SA4_GCC_CODE16 == 401 ~ "Greater Adelaide",
    SA4_GCC_CODE16 == 301 ~ "Greater Brisbane",
    SA4_GCC_CODE16 == 206 ~ "Greater Melbourne",
    SA4_GCC_CODE16 == 502 ~ "Greater Perth",
    SA4_GCC_CODE16 == 102 ~ "Greater Sydney",
    TRUE ~ SA4_NAME16
  )
  ) %>% 
  select(-SA4_CODE16, -SA4_NAME16)

# centroids from arcgis - with option 'inside'
SA2_centr <- st_read("./data/geo/1270055001_sa2_2016_aust_shape/SA2_2016_AUST_centr_inside.shp",
                     stringsAsFactors = FALSE) %>% 
  # filter(SA4_CODE16 != "901") %>% 
  filter(! SA2_5DIG16 %in% c("91001", "91002", "91004", "11161")) %>% 
  select(-starts_with("SA3")) %>% 
  select(-starts_with("SA1")) %>% 
  select(-starts_with("GCC")) %>% 
  select(-AREASQKM16) %>% 
  mutate(STE_CODE16 = as.numeric(as.character(STE_CODE16))) %>% 
  mutate(SA2_MAIN16 = as.numeric(as.character(SA2_MAIN16))) %>% 
  mutate(SA2_5DIG16 = as.numeric(as.character(SA2_5DIG16))) %>% 
  mutate(SA4_CODE16 = as.numeric(as.character(SA4_CODE16))) %>% 
  mutate(SA4_GCC_CODE16 = case_when(
    SA4_CODE16 %in% c(402, 403, 404) ~ 401,
    SA4_CODE16 %in% c(302:305, 310, 311, 313, 314) ~ 301,
    SA4_CODE16 %in% c(207:214) ~ 206,
    SA4_CODE16 %in% c(503:507) ~ 502,
    SA4_CODE16 %in% c(115:128 ) ~ 102,
    TRUE ~ SA4_CODE16
  )
  ) %>% 
  mutate(SA4_GCC_NAME16 = case_when(
    SA4_GCC_CODE16 == 401 ~ "Greater Adelaide",
    SA4_GCC_CODE16 == 301 ~ "Greater Brisbane",
    SA4_GCC_CODE16 == 206 ~ "Greater Melbourne",
    SA4_GCC_CODE16 == 502 ~ "Greater Perth",
    SA4_GCC_CODE16 == 102 ~ "Greater Sydney",
    TRUE ~ SA4_NAME16
  )
  ) %>% 
  select(-SA4_CODE16, -SA4_NAME16)

# STATES
STE <- readRDS(file = "./data/geo/STE_2016_AUST_clean.rds") %>%  
  mutate(STE_CODE16 = as.numeric(as.character(STE_CODE16))) %>% 
  filter(STE_CODE16 != 9) 

# qtm(STE)

stopifnot(nrow(SA2) == 
            nrow(SA2_raw) - 
            nrow(filter(SA2_raw, grepl("Migratory - Offshore - Shipping", SA2_NAME16))) -
            nrow(filter(SA2_raw, grepl("No usual address", SA2_NAME16))) -
            nrow(filter(SA2_raw, SA2_5DIG16 %in% c("91001", "91002", "91004", "11161")))
)

rm(SA2_raw)
gc()
```

That leaves the initial set of `r comma(nrow(SA2))` areas.

<!-- ------------------------------------------------------------ --> 

# APM data

```{r eval=FALSE, include=FALSE}
APM <-
  list.files(path = "data/APM/raw", full.names = TRUE, pattern = "*.csv") %>% 
  map_df(~read_csv(., na = "null")) %>% 
  select(sort(names(.))) %>% 
  dplyr::select(-SA22016ID, -SA22016Pid, 
                -EndDate, -State) %>% 
  dplyr::select(-dplyr::starts_with("Auction_Activity"), 
                # -dplyr::starts_with("For_rent"),
                -dplyr::starts_with("For_sale"),
                -dplyr::starts_with("Sold")) %>%
  dplyr::select(-dplyr::matches("Geometric", ignore.case = TRUE),
                -For_Rent_Home_Lease_TotalPrice, -For_Rent_Home_Lease_EventCount) %>%
  # dplyr::select(-dplyr::matches("Detailed", ignore.case = TRUE)) %>% 
  dplyr::select(dplyr::starts_with("SA2"), 
                PropertyCategorisation, DateMonth, DateYear,
                Gross_Rental_Yield, 
                For_Rent_Home_Lease_AveragePrice, For_Rent_Home_Lease_StandardDeviationPrice, 
                For_Rent_Home_Lease_MinimumPrice, For_Rent_Home_Lease_MaximumPrice, 
                For_Rent_Home_Lease_MedianPrice, For_Rent_Home_Lease_Position25Price, For_Rent_Home_Lease_Position75Price, 
                For_Rent_Home_Lease_DetailedPriceCalculationRecordCount,
                For_Rent_Home_Lease_PriceCalculationRecordCount, 
                # For_Rent_Home_Lease_EventCount,
                everything()) %>% 
  arrange(SA22016Code, PropertyCategorisation, DateYear, DateMonth)

# table(APM$For_Rent_Home_Lease_EventCount - APM$For_Rent_Home_Lease_DetailedPriceCalculationRecordCount)

# table(APM$For_Rent_Home_Lease_EventCount - APM$For_Rent_Home_Lease_PriceCalculationRecordCount)

# table(APM$For_Rent_Home_Lease_DetailedPosition50Price - APM$For_Rent_Home_Lease_MedianPrice)

table(APM$For_Rent_Home_Lease_PriceCalculationRecordCount - APM$For_Rent_Home_Lease_DetailedPriceCalculationRecordCount)

saveRDS(APM, "data/APM/clean/APM.Rds")

# p_load(openxlsx)
# write.xlsx(APM, "data/APM/clean/APM.xlsx")
# p_unload(openxlsx)
```

```{r}
APM <- readRDS("data/APM/clean/APM.Rds") %>% 
  rename(SA2_MAIN16 = SA22016Code,
         record_count = For_Rent_Home_Lease_DetailedPriceCalculationRecordCount,
         rent_50p = For_Rent_Home_Lease_MedianPrice,
         rent_25p = For_Rent_Home_Lease_Position25Price,
         rent_75p = For_Rent_Home_Lease_Position75Price,
         property_type = PropertyCategorisation) %>% 
  mutate(date = ymd(paste(DateYear, DateMonth, 1, sep = "-"))) %>% 
  select(SA2_MAIN16, date, record_count, property_type, starts_with("rent_")) %>% 
  filter(date >= ymd("2016-07-01")) %>% 
  arrange(SA2_MAIN16, property_type, date)

# temp <- APM %>% 
#   filter(SA2_MAIN16 >= 200000000) %>% 
#   filter(SA2_MAIN16 <  300000000) %>% 
#   filter(date >= ymd("2018-06-01")) %>% 
#   filter(date <= ymd("2019-02-01"))  
```

## Raw data 

Raw APM dataset consists of `r comma(nrow(APM))` monthly records of `r comma(length(unique(APM$SA2_MAIN16)))` SA2 areas for `r comma(length(unique(APM$date)))` months from `r min(unique(APM$date))`to `r max(unique(APM$date))`. 

Data are derived separately for houses and units. 

Selected rent related variables include:

```{r}
glimpse(APM)
```

## SA2 areas

```{r}
APM_mis <- 
  SA2 %>% 
  filter(! SA2_MAIN16 %in% unique(APM$SA2_MAIN16))
```

There are `r comma(nrow(APM_mis))` SA2 areas that do not exist in APM data at all

```{r}
APM_mis %>% 
  select(-SA2_MAIN16, -SA2_5DIG16, -STE_CODE16, -SA4_GCC_CODE16) %>% 
  tm_shape() +
  tm_polygons(col = "red", alpha = 0.5, lwd = 1)

rm(APM_mis)
```

Most seem legit as they mainly consists of natural or military areas, airports, etc. 
They were excluded from further analyses. 


```{r include=FALSE}
SA2_include <- 
  SA2 %>% 
  filter(SA2_MAIN16 %in% unique(APM$SA2_MAIN16))

SA2_centr_include <- 
  SA2_centr %>% 
  filter(SA2_MAIN16 %in% unique(APM$SA2_MAIN16))
```

## Missing data 

```{r, include=FALSE}
temp <- APM %>% 
  select(SA2_MAIN16, date, property_type) 

# frq(temp$date)
# frq(temp$property_type)
# descr(as.data.frame(table(temp$SA2_MAIN16))$Freq)

APM_sa2 <- left_join(st_drop_geometry(SA2_include), temp) %>% 
  expand(SA2_MAIN16, date, property_type) %>% 
  filter(!is.na(date)) %>% 
  filter(!is.na(property_type)) %>% 
  left_join(st_drop_geometry(SA2_include)) %>% 
  left_join(APM) %>% 
  mutate(ind_mis = ifelse(is.na(rent_50p), 1, NA)) %>% 
  group_by(SA2_MAIN16, property_type) %>% 
  mutate(sum_mis = sum(ind_mis, na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(record_count = as.integer(record_count),
         rent_50p = as.integer(round(rent_50p)),
         rent_25p = as.integer(round(rent_25p)),
         rent_75p = as.integer(round(rent_75p))) %>% 
  arrange(SA2_MAIN16, property_type, date)

# summarytools::freq(airbnb_sa2$reporting_month)
stopifnot(nrow(SA2_include) * length(unique(APM$date)) * 2 == nrow(APM_sa2))

APM_sa2 %<>%
  group_by(SA2_MAIN16, property_type, grp = with(rle(ind_mis), rep(seq_along(lengths), lengths))) %>%
  mutate(cum_mis = seq_along(grp)) %>%
  ungroup() %>%
  select(-grp, -ind_mis) %>% 
  group_by(SA2_MAIN16, property_type) %>%
  mutate(cum_mis = max(cum_mis)) %>%
  ungroup() %>% 
  mutate(cum_mis = ifelse(sum_mis == 0, 0, cum_mis)) %>% 
  arrange(SA2_MAIN16, property_type, date)


rm(APM, temp)
gc()
```

Not all SA2s have information for all months. `r comma(nrow(filter(APM_sa2, is.na(rent_50p))))` of the records (`r percent(nrow(filter(APM_sa2, is.na(rent_50p)))/nrow(APM_sa2))`) have missing information on monthly median rent. 

## Completely missing information 

### Houses 

```{r include=FALSE}
# time series length should be
length(unique(APM_sa2$date))

# APM_H_mis <- 
#   APM_sa2 %>% 
#   filter(property_type == "House") %>% 
#   filter(sum_mis == length(unique(APM_sa2$date)))

APM_H_mis <- 
  APM_sa2 %>% 
  filter(property_type == "House") %>% 
  filter(sum_mis == length(unique(APM_sa2$date))) %>% 
  group_by(SA2_MAIN16) %>% 
  filter(row_number() == 1) %>% 
  select(SA2_MAIN16, property_type) %>% 
  ungroup()

APM_mis <- 
  SA2 %>% 
  filter(SA2_MAIN16 %in% unique(APM_H_mis$SA2_MAIN16))
```

There are `r comma(nrow(APM_mis))` SA2 areas that do not have any APM data for houses

```{r}
APM_mis %>% 
  select(-SA2_MAIN16, -SA2_5DIG16, -STE_CODE16, -SA4_GCC_CODE16) %>% 
  tm_shape() +
  tm_polygons(col = "red", alpha = 0.5, lwd = 1)
```

```{r include=FALSE}
SA2_H_include <- 
  SA2_include %>% 
  filter(! SA2_MAIN16 %in% unique(APM_H_mis$SA2_MAIN16))

SA2_H_centr_include <- 
  SA2_centr_include %>% 
  filter(! SA2_MAIN16 %in% unique(APM_H_mis$SA2_MAIN16))
```

These areas are excluded.

### Units 

```{r}
APM_U_mis <- 
  APM_sa2 %>% 
  filter(property_type == "Unit") %>% 
  filter(sum_mis == length(unique(APM_sa2$date))) %>% 
  group_by(SA2_MAIN16) %>% 
  filter(row_number() == 1) %>% 
  select(SA2_MAIN16, property_type) %>% 
  ungroup()

APM_mis <- 
  SA2 %>% 
  filter(SA2_MAIN16 %in% unique(APM_U_mis$SA2_MAIN16))
```

There are `r comma(nrow(APM_mis))` SA2 areas that do not have any APM data for units

```{r}
APM_mis %>% 
  select(-SA2_MAIN16, -SA2_5DIG16, -STE_CODE16, -SA4_GCC_CODE16) %>% 
  tm_shape() +
  tm_polygons(col = "red", alpha = 0.5, lwd = 1)
```

```{r include=FALSE}
SA2_U_include <- 
  SA2_include %>% 
  filter(! SA2_MAIN16 %in% unique(APM_U_mis$SA2_MAIN16))

SA2_U_centr_include <- 
  SA2_centr_include %>% 
  filter(! SA2_MAIN16 %in% unique(APM_U_mis$SA2_MAIN16))
```

These areas are excluded.

```{r include=FALSE}
APM_sa2 %<>% 
  filter(sum_mis < length(unique(APM_sa2$date)))

rm(APM_mis, APM_H_mis, APM_U_mis, SA2_include, SA2_centr_include)
gc()
```

## Partly missing information 

### Houses 

```{r}
APM_H_mis <- 
  APM_sa2 %>% 
  filter(property_type == "House") %>% 
  filter(sum_mis >= 12 | cum_mis >= 6) %>% 
  group_by(SA2_MAIN16) %>% 
  filter(row_number() == 1) %>% 
  select(SA2_MAIN16, property_type) %>% 
  ungroup()

APM_mis <- 
  SA2 %>% 
  filter(SA2_MAIN16 %in% unique(APM_H_mis$SA2_MAIN16))
```

There are `r comma(nrow(APM_mis))` SA2 areas that have missing **12 or more** months of APM data **or** have **6 or more** consecutive months of APM data missing for houses

```{r}
APM_mis %>% 
  select(-SA2_MAIN16, -SA2_5DIG16, -STE_CODE16, -SA4_GCC_CODE16) %>% 
  tm_shape() +
  tm_polygons(col = "red", alpha = 0.5, lwd = 1)
```

```{r include=FALSE}
SA2_H_include %<>% 
  filter(! SA2_MAIN16 %in% unique(APM_H_mis$SA2_MAIN16))

SA2_H_centr_include %<>% 
  filter(! SA2_MAIN16 %in% unique(APM_H_mis$SA2_MAIN16))
```

These areas are excluded.

### Units 

```{r}
APM_U_mis <- 
  APM_sa2 %>% 
  filter(property_type == "Unit") %>% 
  filter(sum_mis >= 12 | cum_mis >= 6) %>% 
  group_by(SA2_MAIN16) %>% 
  filter(row_number() == 1) %>% 
  select(SA2_MAIN16, property_type) %>% 
  ungroup()

APM_mis <- 
  SA2 %>% 
  filter(SA2_MAIN16 %in% unique(APM_U_mis$SA2_MAIN16))
```

There are `r comma(nrow(APM_mis))` SA2 areas that have missing **12 or more** months of APM data **or** have **6 or more** consecutive months of APM data missing for units

```{r}
APM_mis %>% 
  select(-SA2_MAIN16, -SA2_5DIG16, -STE_CODE16, -SA4_GCC_CODE16) %>% 
  tm_shape() +
  tm_polygons(col = "red", alpha = 0.5, lwd = 1)
```

```{r include=FALSE}
SA2_U_include %<>% 
  filter(! SA2_MAIN16 %in% unique(APM_U_mis$SA2_MAIN16))

SA2_U_centr_include %<>% 
  filter(! SA2_MAIN16 %in% unique(APM_U_mis$SA2_MAIN16))
```

These areas are excluded.

```{r include=FALSE}
APM_sa2 %<>% 
  filter(sum_mis < 12) %>% 
  filter(cum_mis < 6)

rm(APM_mis, APM_H_mis, APM_U_mis)
gc()
```

## Outlier

```{r}
APM_sa2 %>% 
  filter(SA2_MAIN16 == 118011343, property_type == "House") %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = rent_50p), size = 1, col = "gray") +
  theme_minimal() + 
  labs(x = "", y = "Median rent", title = "Rent - houses in `Double Bay - Bellevue Hill`")
```

Data from `2018-12-01` are at the moment kept 'as is' (*note - based on 10 obs only!*)

```{r}
# APM_sa2 %<>% 
#   mutate(rent_50p = ifelse(SA2_MAIN16 == 118011343 & date == ymd("2018-12-01"), NA, rent_50p))
```

## Imputing time series

### Houses 

```{r}
APM_H_mis <- 
  APM_sa2 %>% 
  filter(property_type == "House") %>% 
  filter(sum_mis > 0) %>% 
  group_by(SA2_MAIN16) %>% 
  filter(row_number() == 1) %>% 
  select(SA2_MAIN16, property_type) %>% 
  ungroup()

APM_mis <- 
  SA2 %>% 
  filter(SA2_MAIN16 %in% unique(APM_H_mis$SA2_MAIN16))
```

There are `r comma(nrow(APM_mis))` SA2 areas that have some missing APM data for houses

```{r}
APM_mis %>% 
  select(-SA2_MAIN16, -SA2_5DIG16, -STE_CODE16, -SA4_GCC_CODE16) %>% 
  tm_shape() +
  tm_polygons(col = "red", alpha = 0.5, lwd = 1)
```

These areas have data imputed.

### Units 

```{r}
APM_U_mis <- 
  APM_sa2 %>% 
  filter(property_type == "Unit") %>% 
  filter(sum_mis > 0) %>% 
  group_by(SA2_MAIN16) %>% 
  filter(row_number() == 1) %>% 
  select(SA2_MAIN16, property_type) %>% 
  ungroup()

APM_mis <- 
  SA2 %>% 
  filter(SA2_MAIN16 %in% unique(APM_U_mis$SA2_MAIN16))
```

There are `r comma(nrow(APM_mis))` SA2 areas that have some missing APM data for units

```{r}
APM_mis %>% 
  select(-SA2_MAIN16, -SA2_5DIG16, -STE_CODE16, -SA4_GCC_CODE16) %>% 
  tm_shape() +
  tm_polygons(col = "red", alpha = 0.5, lwd = 1)
```

These areas have data imputed.

### Example

Data imputed using Stineman interpolation using `na_interpolation` function from `imputeTS` package.

```{r include=FALSE}
APM_sa2 %<>% 
  arrange(SA2_MAIN16, property_type, date) %>% 
  group_by(SA2_MAIN16, property_type) %>% 
  mutate(
    record_count_int = as.integer(round(na_interpolation(record_count, option = "stine"))),
    rent_50p_int = as.integer(round(na_interpolation(rent_50p, option = "stine"))),
    rent_25p_int = as.integer(round(na_interpolation(rent_25p, option = "stine"))),
    rent_75p_int = as.integer(round(na_interpolation(rent_75p, option = "stine")))
  ) %>% 
  ungroup()

# # much more computationally intensive
# APM_sa2 %<>% 
#   group_by(SA2_MAIN16, property_type) %>% 
#   mutate(rent_50p_int = as.integer(round(na_kalman(rent_50p, model = "auto.arima"))),
#          rent_25p_int = as.integer(round(na_kalman(rent_25p, model = "auto.arima"))),
#          rent_75p_int = as.integer(round(na_kalman(rent_75p, model = "auto.arima"))))

# # series is not periodic or has less than two periods
# APM_sa2 %<>% 
#   group_by(SA2_MAIN16, property_type) %>% 
#   mutate(rent_50p_int = as.integer(round(na_seadec(rent_50p, find_frequency=TRUE))),
#          rent_25p_int = as.integer(round(na_seadec(rent_25p, find_frequency=TRUE))),
#          rent_75p_int = as.integer(round(na_seadec(rent_75p, find_frequency=TRUE))))

rm(APM_mis, APM_H_mis, APM_U_mis)
```

```{r warning=FALSE}
APM_sa2 %>% 
  filter(SA2_NAME16 == "Dingley Village", property_type == "Unit") %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = rent_50p), size = 2, col = "red") +
  geom_line(aes(y = rent_50p_int)) +
  theme_minimal() + 
  labs(x = "", y = "Median rent", title = "Rent - units in Dingley Village")
```


```{r warning=FALSE}
APM_sa2 %>% 
  filter(SA2_NAME16 == "Calwell", property_type == "Unit") %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = rent_50p), size = 2, col = "red") +
  geom_line(aes(y = rent_50p_int)) +
  theme_minimal() + 
  labs(x = "", y = "Median rent", title = "Rent - units in Calwell")
```


```{r warning=FALSE}
APM_sa2 %>% 
  filter(SA2_NAME16 == "Christie Downs", property_type == "Unit") %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = rent_50p), size = 2, col = "red") +
  geom_line(aes(y = rent_50p_int)) +
  theme_minimal() + 
  labs(x = "", y = "Median rent", title = "Rent - units in Christie Downs")
```

```{r warning=FALSE}
APM_sa2 %>% 
  filter(SA2_NAME16 == "Somerset", property_type == "Unit") %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = rent_50p), size = 2, col = "red") +
  geom_line(aes(y = rent_50p_int)) +
  theme_minimal() + 
  labs(x = "", y = "Median rent", title = "Rent - units in Somerset")
```

Same was done for record count

```{r warning=FALSE}
APM_sa2 %>% 
  filter(SA2_NAME16 == "Somerset", property_type == "Unit") %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = record_count), size = 2, col = "red") +
  geom_line(aes(y = record_count_int)) +
  theme_minimal() + 
  labs(x = "", y = "Record count", title = "Record count - units in Somerset")
```


```{r}
# APM_sa2 %<>% 
#   select(-sum_mis, -cum_mis)

saveRDS(APM_sa2, "data/APM/clean/APM_sa2.Rds")
```

## Clean data 

Clean APM dataset consists of `r comma(nrow(filter(APM_sa2, property_type == "House")))` monthly records of house rents in`r comma(filter(APM_sa2, property_type == "House") %>% distinct(SA2_MAIN16) %>% nrow())` SA2 areas and `r comma(nrow(filter(APM_sa2, property_type == "Unit")))` monthly records of unit rents in`r comma(filter(APM_sa2, property_type == "Unit") %>% distinct(SA2_MAIN16) %>% nrow())` SA2 areas.

### Houses

```{r}
APM_sa2 %>% 
  filter(property_type == "House") %>% 
  ggplot(aes(x = date, y = rent_50p_int, group = SA2_MAIN16, colour = STE_NAME16)) + 
  geom_line(alpha = .5) + 
  coord_cartesian(ylim = c(0, 2500)) +
  theme_minimal() + 
  labs(x = "", y = "Median rent", title = "Rent - houses")
```

```{r}
APM_sa2 %>% 
  filter(property_type == "House") %>% 
  ggplot(aes(x = date, y = rent_50p_int, group = SA2_MAIN16)) + 
  facet_wrap(vars(STE_NAME16)) +
  geom_line(col = "darkorchid4", alpha = .5) + 
  coord_cartesian(ylim = c(0, 2500)) +
  theme_minimal() + 
  labs(x = "", y = "Median rent", title = "Rent - houses")
```

```{r}
APM_sa2 %>% 
  filter(property_type == "House") %>% 
  ggplot(aes(x = date, y = rent_50p_int, group = SA2_MAIN16)) + 
  geom_smooth(aes(group = STE_NAME16, colour = STE_NAME16), alpha = 0.5) + 
  theme_minimal() + 
  labs(x = "", y = "Median rent", title = "Rent - houses")
```

```{r}
APM_sa2 %>% 
  filter(property_type == "House") %>% 
  ggplot(aes(x = date, y = rent_50p_int, group = date)) + 
  geom_boxplot() + 
  theme_minimal() + 
  labs(x = "", y = "Median rent", title = "Rent - houses")
```

```{r}
APM_sa2 %>% 
  filter(property_type == "House") %>% 
  ggplot(aes(x = rent_50p_int, y = date, group = date)) + 
  stat_density_ridges(quantile_lines = TRUE) + 
  theme_ridges() + 
  labs(y = "", x = "Median rent", title = "Median rent distribution across time - houses")
```

State on `2019-07-01`

```{r}
SA2 %>% 
  left_join(filter(APM_sa2, property_type == "House" & date == ymd("2019-07-01"))) %>% 
  select(-SA2_MAIN16, -SA2_5DIG16, -starts_with("SA4"), -starts_with("STE"), -ends_with("p")) %>% 
  tm_shape() +
  tm_dots(size = "record_count", col = "rent_50p_int", palette = "YlOrRd", n = 7, 
          id = "SA2_NAME16", popup.vars = c("record_count", "rent_50p_int"))       
```

```{r eval=FALSE, include=FALSE}
APM_sa2 %>% 
  filter(property_type == "House") %>% 
  ggplot(aes(x = rent_50p_int)) + 
  geom_histogram(binwidth = 10) + 
  theme_minimal() + 
  labs(x = "Median rent", title = "Rent - houses")
```

### Units

```{r}
APM_sa2 %>% 
  filter(property_type == "Unit") %>% 
  ggplot(aes(x = date, y = rent_50p_int, group = SA2_MAIN16, colour = STE_NAME16)) + 
  geom_line(alpha = .5) + 
  theme_minimal() + 
  labs(x = "", y = "Median rent", title = "Rent - units")
```

```{r}
APM_sa2 %>% 
  filter(property_type == "Unit") %>% 
  ggplot(aes(x = date, y = rent_50p_int, group = SA2_MAIN16)) + 
  facet_wrap(vars(STE_NAME16)) +
  geom_line(col = "darkorchid4", alpha = .5) + 
  theme_minimal() + 
  labs(x = "", y = "Median rent", title = "Rent - units")
```

```{r}
APM_sa2 %>% 
  filter(property_type == "Unit") %>% 
  ggplot(aes(x = date, y = rent_50p_int, group = SA2_MAIN16)) + 
  geom_smooth(aes(group = STE_NAME16, colour = STE_NAME16), alpha = 0.5) + 
  theme_minimal() + 
  labs(x = "", y = "Median rent", title = "Rent - units")
```

```{r}
APM_sa2 %>% 
  filter(property_type == "Unit") %>% 
  ggplot(aes(x = date, y = rent_50p_int, group = date)) + 
  geom_boxplot() + 
  theme_minimal() + 
  labs(x = "", y = "Median rent", title = "Rent - units")
```

```{r}
APM_sa2 %>% 
  filter(property_type == "Unit") %>% 
  ggplot(aes(x = rent_50p_int, y = date, group = date)) + 
  stat_density_ridges(quantile_lines = TRUE) + 
  theme_ridges() + 
  labs(y = "", x = "Median rent", title = "Median rent distribution across time - units")
```

State on `2019-07-01`

```{r}
SA2 %>% 
  left_join(filter(APM_sa2, property_type == "Unit" & date == ymd("2019-07-01"))) %>% 
  select(-SA2_MAIN16, -SA2_5DIG16, -starts_with("SA4"), -starts_with("STE"), -ends_with("p")) %>% 
  tm_shape() +
  tm_dots(size = "record_count", col = "rent_50p_int", palette = "YlOrRd", n = 7, 
          id = "SA2_NAME16", popup.vars = c("record_count", "rent_50p_int"))       
```

```{r eval=FALSE, include=FALSE}
APM_sa2 %>% 
  filter(property_type == "Unit") %>% 
  ggplot(aes(x = rent_50p_int)) + 
  geom_histogram(binwidth = 10) + 
  theme_minimal() + 
  labs(x = "Median rent", title = "Rent - units")
```

### Victoria problem

High record count over three months???

```{r}
APM_sa2 %>% 
  filter(STE_NAME16 == "Victoria") %>% 
  ggplot(aes(x = date, y = record_count_int, group = date)) + 
  geom_boxplot() + 
  facet_wrap(vars(property_type)) +
  theme_minimal() + 
  coord_cartesian(ylim = c(0, 2500)) +
  labs(x = "", y = "record_count" #, title = "Rent - units"
  )
```

And lower counts in other states?

```{r}
APM_sa2 %>% 
  filter(STE_NAME16 == "New South Wales") %>% 
  ggplot(aes(x = date, y = record_count_int, group = date)) + 
  geom_boxplot() + 
  facet_wrap(vars(property_type)) +
  theme_minimal() + 
  coord_cartesian(ylim = c(0, 2500)) +
  labs(x = "", y = "record_count" #, title = "Rent - units"
  )
```

Comparing `Units` counts in two states:

```{r}
APM_sa2 %>% 
  filter(STE_NAME16 %in% c("Victoria", "New South Wales")) %>% 
  filter(property_type == "Unit") %>% 
  ggplot(aes(x = date, y = record_count_int, group = date)) + 
  geom_boxplot(outlier.shape = NA) + 
  coord_cartesian(ylim = c(0, 2000)) +
  facet_wrap(vars(STE_NAME16)) +
  theme_minimal() + 
  labs(x = "", y = "record_count" #, title = "Rent - units"
  )
```


```{r eval=FALSE, include=FALSE}
# ## Distribution of outcome
# 
# As continuous

p_load(fitdistrplus)

plotdist(APM_sa2$rent_50p_int, histo = TRUE, demp = TRUE)
# descdist(APM_sa2$rent_50p_int, boot = 1000)

# plotdist(APM_sa2$rent_25p_int, histo = TRUE, demp = TRUE)
# plotdist(APM_sa2$rent_75p_int, histo = TRUE, demp = TRUE)

p_unload(fitdistrplus)
```

<!-- ------------------------------------------------------------ --> 

# ABS data

## Selection 

Stocks of houses and units were derived from 2016 Census.

These were created counting dwellings that were 

- private: `Occupied private dwellings` and `Unoccupied private dwellings` from the `DWTD Dwelling Type` variable

- rented: `Rented` category from the `TEND Tenure Type` variable

And then divided into houses and apratments uing `STRD Dwelling Structure` variable with:

- `Separate house`, `Semi-detached, row or terrace house, townhouse etc. with one storey` and `Semi-detached, row or terrace house, townhouse etc. with two or more storeys` representing houses

- `Flat or apartment in a one or two storey block`, `Flat or apartment in a three storey block`, `Flat or apartment in a four or more storey block`, `Flat or apartment attached to a house` representing units

## Results 

```{r, include=FALSE}
SA2_H <- read_excel("data/ABS/misc/raw/SA2 H by TEND Tenure Type, DWTD Dwelling Type and STRD Dwelling Structure.xlsx", 
                    skip = 10) %>% 
  clean_names() %>%  remove_empty() %>% 
  rename(SA2_NAME16 = sa2, houses = x2) %>% 
  filter(! SA2_NAME16 %in% c("Total", "INFO")) %>% 
  filter(!grepl("Migratory - Offshore - Shipping", SA2_NAME16))  %>% 
  filter(!grepl("No usual", SA2_NAME16)) %>% 
  filter(!grepl("Data Source", SA2_NAME16)) %>% 
  filter(!grepl("Copyright", SA2_NAME16)) %>% 
  filter(!grepl("licensed", SA2_NAME16))


SA2_U <- read_excel("data/ABS/misc/raw/SA2 U by TEND Tenure Type, DWTD Dwelling Type and STRD Dwelling Structure.xlsx", 
                    skip = 10) %>% 
  clean_names() %>%  remove_empty() %>% 
  rename(SA2_NAME16 = sa2, units = x2) %>% 
  filter(! SA2_NAME16 %in% c("Total", "INFO")) %>% 
  filter(!grepl("Migratory - Offshore - Shipping", SA2_NAME16))  %>% 
  filter(!grepl("No usual", SA2_NAME16)) %>% 
  filter(!grepl("Data Source", SA2_NAME16)) %>% 
  filter(!grepl("Copyright", SA2_NAME16)) %>% 
  filter(!grepl("licensed", SA2_NAME16))
```

```{r}
SA2 %>% left_join(SA2_H) %>% left_join(SA2_U) %>% 
  tm_shape() +
  tm_dots(size = c("houses", "units"), n = 7, scale = 0.5,
          id = "SA2_NAME16", popup.vars = c("SA2_NAME16", "houses", "units")) + 
  tm_facets(free.scales = FALSE)
```

```{r, include=FALSE}
APM_sa2 %<>% 
  left_join(SA2_H) %>% 
  left_join(SA2_U)

APM_sa2 %>% 
  filter(property_type == "House") %>% 
  filter(houses == 0)

# Areas 
temp <- 
  APM_sa2 %>% 
  filter(property_type == "Unit") %>% 
  filter(units == 0) %>% 
  select(-SA2_MAIN16, -SA2_5DIG16, -STE_CODE16, 
         -starts_with("GCC"), -starts_with("SA4"), 
         - ends_with("p"), -rent_25p_int, -rent_75p_int)
```

## Discrepancies

Note: there are `r comma(length(unique(temp$SA2_NAME16)))` SA2s with zero ABS units, but available APM rental units!

```{r}
SA2 %>% 
  filter(SA2_NAME16 %in% unique(temp$SA2_NAME16)) %>% 
  select(-SA2_MAIN16, -SA2_5DIG16, -STE_CODE16, -SA4_GCC_CODE16) %>% 
  tm_shape() +
  tm_polygons(col = "red", alpha = 0.5, lwd = 1)
```

<!-- ------------------------------------------------------------ --> 

# Airbnb data

Data prep focusing on monthly income generated on SA2 level. 

```{r, include=FALSE}
monthly_new_select <- readRDS("./data/airdna/clean/monthly_new_select.Rds") 
```

Raw datasets consist of `r comma(length(unique(monthly_new_select$property_id)))` properties and 
`r comma(nrow(monthly_new_select))` monthly stats. 

## Selection

`r comma(nrow(filter(monthly_new_select, reporting_month < ymd("2016-01-01"))))` data points from before 2016-01-01 were excluded.

`r comma(nrow(filter(monthly_new_select, reporting_month >= ymd("2019-02-01"))))` data points from after 2019-02-01 were excluded.

`r comma(nrow(filter(monthly_new_select, listing_type == "Shared room")))` data points of `listing_type` "Shared room"  and `r comma(nrow(filter(monthly_new_select, listing_type == "Private room")))` data points of "Private room"  were excluded.


```{r, include=FALSE}
monthly_new_prep_rent <- monthly_new_select %>% 
  filter(reporting_month >= ymd("2016-01-01")) %>% 
  filter(reporting_month < ymd("2019-02-01")) %>% 
  filter(listing_type != "Shared room") %>% 
  filter(listing_type != "Private room") %>% 
  select(-listing_type)

# comma(length(unique(monthly_new_select$property_id)))
# comma(length(unique(monthly_new_prep_rent$property_id)))

rm(monthly_new_select)
gc()
```

```{r, include=FALSE}
#### Other Territories
OT <- monthly_new_prep_rent %>% 
  filter(SA2_5DIG16 %in% c("91001", "91002", "91004", "11161"))

monthly_new_prep_rent %<>% 
  filter(! SA2_5DIG16 %in% c("91001", "91002", "91004", "11161")) 


#### zero aud - convert to usd
zero_aud <- monthly_new_prep_rent %>% 
  dplyr::filter(revenue_native == 0 & revenue_usd > 0)

# sjmisc::descr(zero_aud, revenue_usd)

#### missing aud - convert to usd
mis_aud <- monthly_new_prep_rent %>% 
  dplyr::filter(is.na(revenue_native) & !is.na(revenue_usd))

# sjmisc::descr(mis_aud, revenue_usd)

monthly_new_prep_rent %<>% 
  mutate(revenue_native = ifelse(test = revenue_native == 0 & revenue_usd > 0, 
                                 yes = revenue_usd*1.4, 
                                 no = revenue_native)) %>% 
  mutate(revenue_native = ifelse(test = is.na(revenue_native) & !is.na(revenue_usd), 
                                 yes = revenue_usd*1.4, 
                                 no = revenue_native)) 
```

`r comma(nrow(OT))` records of `r comma(length(unique(OT$property_id)))` properties located in Other Teritories were excluded. 

Next, `r comma(nrow(zero_aud))` monthly records of `r comma(length(unique(zero_aud$property_id)))` properties that had zero AUD income but some information in USD had income recalculated using 1.4 exchange rate.

Next, `r comma(nrow(mis_aud))` monthly records of `r comma(length(unique(mis_aud$property_id)))` properties that had missing AUD income but some information in USD had income recalculated using 1.4 exchange rate.

```{r, include=FALSE}
rm(zero_aud, mis_aud, OT)
```

## Outliers

There are few ouliers in terms of monthly income

```{r}
temp <- monthly_new_prep_rent %>% 
  filter(revenue_native > 95000) %>% 
  arrange(desc(revenue_native)) %>% 
  # select(property_id, reporting_month, reservation_days, 
  #        starts_with("Revenue"), starts_with("ADR")) %>% 
  slice(1:36)

monthly_new_prep_rent %>% 
  arrange(desc(revenue_native)) %>% 
  select(property_id, reporting_month, reservation_days,
         starts_with("Revenue"), starts_with("ADR")) %>% 
  slice(1:36)

# View(filter(monthly_new_prep_rent, property_id == 14999741))
# Luxury 80ft Motor Yacht - 4 Bedroom
# $6,990.00 per night

# View(filter(monthly_new_prep_rent, property_id == 30109331))
# Kalinya Estate - Homestead & Lodge -26 p
# $3,200.00 per night
```

From the top monthly income values (with income above $95k) data with very high AUD income were corrected using USD values.

One very high value was replaced to average ADR * booked days from previous & next month from the same property.

```{r include=FALSE}
monthly_new_prep_rent %<>% 
  mutate(revenue_native = ifelse(test = revenue_native > 95000, 
                                 yes = revenue_usd*1.4, no = revenue_native))

```

Three very high monthly values were recalculated from more realistic ADR (in USD) indicators.

```{r include=FALSE}
# property_new <- readRDS(".data/airdna/clean/property_new.Rds")
# View(filter(property_new, property_id == 11926837))
# View(filter(monthly_new_prep_rent, property_id == 11926837))


monthly_new_prep_rent %<>% 
  mutate(revenue_native = ifelse(test = property_id == 23709347	&
                                   reporting_month == ymd("2018-04-01"), 
                                 yes = reservation_days*adr_usd*1.4, no = revenue_native))

monthly_new_prep_rent %<>% 
  mutate(revenue_native = ifelse(test = property_id == 22267809	&
                                   reporting_month == ymd("2018-05-01"), 
                                 yes = reservation_days*adr_usd*1.4, no = revenue_native))

monthly_new_prep_rent %<>% 
  mutate(revenue_native = ifelse(test = property_id == 11926837	&
                                   reporting_month == ymd("2016-06-01"), 
                                 yes = reservation_days*adr_usd*1.4, no = revenue_native))
```

## Inactive listings

Over third of monthly records is labelled as not active. 

```{r}
frq(monthly_new_prep_rent, active, sort.frq = "desc") 
```

```{r include=FALSE}
# temp <- monthly_new_prep_rent %>% 
#   filter(active == FALSE) %>% 
#   select(-active)

temp1 <- monthly_new_prep_rent %>% 
  filter(active == FALSE) %>% 
  select(-active) %>% 
  filter(!is.na(revenue_usd) | !is.na(revenue_native)) %>% 
  filter(revenue_usd > 0 | revenue_native > 0)

temp2 <- monthly_new_prep_rent %>% 
  filter(active == FALSE) %>% 
  select(-active) %>% 
  filter(available_days > 0 )
```

All of them were excluded. That also applied to records where there was some information about the revenue (either AUD or USD; n = `r comma(nrow(temp1))`) or number of available days was indicated to be > 0 (n = `r comma(nrow(temp2))`). For the former group, that could indicate some reshufling of money from previous months? For the latter group - this doesnt make sense but at least none of these records has any reservations and there are not much money involved.  

```{r include=FALSE}
monthly_new_prep_rent %<>% 
  filter(active == TRUE) %>% 
  select(-active)

rm(temp, temp1, temp2)
gc()
```

## 0 bedrooms

`r comma(nrow(monthly_new_prep_rent %>% filter(bedrooms == 0) %>% select(property_id) %>% distinct()))` roperties with 0 bedrooms were recoded to have 1 bedroom. 

```{r}
monthly_new_prep_rent %<>% 
  mutate(bedrooms = ifelse(bedrooms == 0, 1, bedrooms))

# temp <- monthly_new_prep_rent %>%
#   group_by(property_id) %>%
#   filter(row_number() == 1) %>%
#   ungroup() %>%
#   filter(!is.na(bedrooms)) %>%
#   mutate(bedrooms = ifelse(bedrooms >= 6, 6, bedrooms))
# 
# frq(temp, bedrooms)

```

## Type of properties

Classification of properties was simplified to `house` and `apartment` with few ambiguous records dropped. 

```{r}
frq(monthly_new_prep_rent, property_type, sort.frq = "desc") 
```




## Final Airbnb dataset

```{r include=FALSE}
saveRDS(monthly_new_prep_rent, 
        file = "./data/airdna/clean/monthly_new_prep_rent.rds")
```

Final dataset consists of `r comma(nrow(monthly_new_prep_rent))`
monthly records of `r comma(length(unique(monthly_new_prep_rent$property_id)))` properties in `r comma(length(unique(monthly_new_prep_rent$SA2_MAIN16)))` SA2 areas. 

## SA2 areas

Locations of Airbnb properties (points) were linked to ABS data of SA2 areas from 2016. Spatial join in ArcGIS was used with `CLOSEST` option to capture locations that did not overlap with polygons (see example here  https://www.airbnb.com/rooms/19103554 - due to privacy reasons, locations are not exact). 

`r nrow(filter(SA2, !SA2_MAIN16 %in% unique(monthly_new_prep_rent$SA2_MAIN16)))` SA2s (out of `r nrow(SA2)`) have no Airbnbs inside. 

```{r}
temp <- SA2 %>% 
  filter(!SA2_MAIN16 %in% unique(monthly_new_prep_rent$SA2_MAIN16))

temp %>% 
  select(-SA2_MAIN16, -SA2_5DIG16, -STE_CODE16, -SA4_GCC_CODE16) %>% 
  tm_shape() +
  tm_polygons(col = "red", alpha = 0.5)
```

Few of this areas have some info in APM data. 

Houses:

```{r}
SA2_H_include %>%
  filter(SA2_MAIN16 %in% temp$SA2_MAIN16) %>% 
  tm_shape() +
  tm_polygons(col = "red", alpha = 0.5)
```

Units:

```{r include=FALSE, eval=FALSE}
SA2_U_include %>%
  filter(SA2_MAIN16 %in% temp$SA2_MAIN16) %>% 
  tm_shape() +
  tm_polygons(col = "red", alpha = 0.5)

rm(temp)
```

So the number of Airbnbs and income from them will be fixed to zero in that locations. 

## Prepared dataset



#### `bedrooms`

6 `bedroooms` or more combined.

```{r}
frq(temp, bedrooms) 
```

#### `property_type`

```{r}
frq(temp, property_type, sort.frq = "desc") 
```

#### `property_type` vs `bedrooms`

```{r}
temp %>%
  tabyl(property_type, bedrooms) %>%
  adorn_totals(c("row", "col")) %>%
  adorn_percentages("col") %>%
  adorn_pct_formatting(digits = 0) %>%
  adorn_ns() %>%
  knitr::kable()
```

### Individual revenue

Each property has a trajectory of income data.  Not all months are available.. Not all months exist..

```{r}
monthly_new_prep_rent %>% 
  filter(property_id %in% c(1612, 24119801, 10803, 14935)) %>% 
  ggplot(aes(x=reporting_month, y=revenue_native, 
             color=as.factor(property_id), 
             group=property_id)) +
  geom_line(size = 1) +
  theme_minimal() + xlab("") + ylab("Revenue AUD")
```

### SA2 revenue

Data for Brisbane City SA2. Individual properties with smoothed trend:

```{r}
monthly_new_prep_rent %>% 
  filter(SA2_5DIG16 %in% c(31105)) %>% 
  ggplot(aes(x=reporting_month, y=revenue_native)) +
  geom_line(aes(group=property_id), alpha = .33) +
  geom_smooth(size = 1, se = FALSE) +
  theme_minimal() + xlab("") + ylab("Revenue AUD")
```

Same with monthly aggregates:

```{r}
monthly_new_prep_rent %>% 
  filter(SA2_5DIG16 %in% c(31105)) %>% 
  group_by(reporting_month) %>% 
  summarise(revenue_native = sum(revenue_native, na.rm = TRUE)) %>% 
  ggplot(aes(x=reporting_month, y=revenue_native)) +
  geom_col() +
  theme_minimal() + xlab("") + ylab("Revenue AUD")
```

#### 'Filling' time series

Areas where no income was reported during specific reporting month had those months filled with 0 AUD.  

```{r, include=FALSE}
temp <- monthly_new_prep_rent %>% 
  group_by(SA2_MAIN16, reporting_month) %>% 
  summarise(revenue = sum(revenue_native, na.rm = TRUE))

airbnb_sa2 <- left_join(st_drop_geometry(SA2), temp) %>% 
  expand(SA2_MAIN16, reporting_month) %>% 
  filter(!is.na(reporting_month)) %>% 
  left_join(st_drop_geometry(SA2)) %>% 
  left_join(temp) %>% 
  tidyr::replace_na(list(revenue = 0)) %>% 
  mutate(revenue = as.integer(round(revenue))) %>% 
  mutate_if(is.factor, as.character) %>% 
  ungroup() %>% 
  group_by(SA2_MAIN16) %>% arrange(reporting_month) %>% mutate(cumulative = cumsum(revenue)) %>% 
  ungroup() %>% 
  arrange(SA2_MAIN16, reporting_month)

# summarytools::freq(airbnb_sa2$reporting_month)
stopifnot(nrow(SA2) * length(unique(monthly_new_prep_rent$reporting_month)) == nrow(airbnb_sa2))

# table(is.na(monthly_new_prep_rent$SA1_7DIG16))

rm(temp)
gc()
```

Result is in the form of 'income curves' with `r nrow(airbnb_sa2)` data points of Airbnb revenue for `r nrow(SA2)` areas. 

#### Absolute monthly 

```{r}
ggplot(data=airbnb_sa2, 
       aes(x=reporting_month, y=revenue/1000000, 
           color=STE_NAME16, group=SA2_MAIN16)) +
  geom_line(alpha=0.5) +
  theme_minimal() + xlab("") + ylab("Airbnb revenue [*1,000,000]$")
```

#### Cumulative values

```{r}
ggplot(data=airbnb_sa2, 
       aes(x=reporting_month, y=cumulative/1000000, 
           color=STE_NAME16, group=SA2_MAIN16)) +
  geom_line(alpha=0.5) +
  theme_minimal() + xlab("") + ylab("Airbnb revenue [*1,000,000]$")
```


<!-- ------------------------------------------------------------ --> 
<!-- ------------------------------------------------------------ --> 

# Explanatory variables

## Remotness

Data are from *1270.0.55.005 - Australian Statistical Geography Standard (ASGS): Volume 5 - Remoteness Structure, July 2016* [info](https://www.abs.gov.au/AUSSTATS/abs@.nsf/DetailsPage/1270.0.55.005July%202016?OpenDocument).

`No usual address` and `Migratory - Offshore - Shipping` categories are excluded. 

Data are on SA1 level. Population of SA1 was used to find majority classification within each SA2.

```{r include=FALSE}
remote <- read_csv("data/ABS/1270055005_ra_2016_aust_csv/RA_2016_AUST.zip", 
                   col_types = cols(AREA_ALBERS_SQKM = col_skip(), 
                                    MB_CODE_2016 = col_skip(), RA_CODE_2016 = col_integer(), 
                                    STATE_CODE_2016 = col_skip(), STATE_NAME_2016 = col_skip())) %>% 
  rename(SA1_MAIN16 = SA1_MAINCODE_2016,
         SA1_7DIG16 = SA1_7DIGITCODE_2016) %>% 
  group_by(SA1_MAIN16) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  filter(!str_detect(RA_NAME_2016, "Migratory - Offshore - Shipping")) %>% 
  filter(!str_detect(RA_NAME_2016, "No usual address"))

pop_sa1 <- read_csv("data/ABS/2016 Census GCP Statistical Area 1 for AUST/2016Census_G01_AUS_SA1.csv.gz") %>% 
  select(SA1_7DIGITCODE_2016, Tot_P_P) %>% 
  rename(SA1_7DIG16 = SA1_7DIGITCODE_2016,
         pop_16 = Tot_P_P)

SA1 <- st_read("./data/geo/1270055001_sa1_2016_aust_shape/SA1_2016_AUST.shp", 
               stringsAsFactors = FALSE) %>% 
  st_drop_geometry() %>% 
  select(SA1_MAIN16, SA2_MAIN16, SA2_5DIG16, SA2_NAME16) %>% 
  mutate(SA1_MAIN16 = as.numeric(as.character(SA1_MAIN16))) %>% 
  mutate(SA2_MAIN16 = as.numeric(as.character(SA2_MAIN16))) %>% 
  mutate(SA2_5DIG16 = as.numeric(as.character(SA2_5DIG16)))

remote %<>% 
  left_join(pop_sa1) %>% 
  left_join(SA1)

remote %<>% 
  rename(pop_sa1_16 = pop_16) %>% 
  group_by(SA2_MAIN16) %>% 
  mutate(pop_sa2_16 = sum(pop_sa1_16)) %>% 
  ungroup() 
```

Original data

```{r}
remote %>% 
  frq(RA_NAME_2016)
```

SA2 assigned to majority

```{r}
remote_ra <- 
  remote %>% 
  group_by(SA2_MAIN16, RA_CODE_2016) %>% 
  mutate(pop_sa2_16_cat = sum(pop_sa1_16)) %>% 
  ungroup() %>% 
  mutate(pop_sa2_16_s = pop_sa2_16_cat/pop_sa2_16) %>% 
  arrange(SA2_MAIN16, desc(pop_sa2_16_s)) %>% 
  group_by(SA2_MAIN16, RA_CODE_2016) %>%
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  select(-SA1_MAIN16, -SA1_7DIG16, -pop_sa1_16) %>% 
  select(SA2_MAIN16, SA2_5DIG16, SA2_NAME16, everything())

remote_ra_one <- 
  remote_ra %>% 
  group_by(SA2_MAIN16) %>%
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  filter(! SA2_5DIG16 %in% c("91001", "91002", "91004", "11161"))
```

Share of majority category

```{r}
remote_ra_one %>% 
  descr(pop_sa2_16_s)

ggplot(remote_ra_one, aes(pop_sa2_16_s)) + 
  geom_histogram() +
  ylab("Number of SA2s") + xlab("Share of majority category") + theme_minimal()
```

Map 

```{r}
SA2 %>% 
  left_join(remote_ra_one) %>% 
  tm_shape() + 
  tm_polygons(col = "RA_NAME_2016", alpha = .5, border.col = NA, id = "SA3_NAME16")
```


<!-- ------------------------------------------------------------ --> 

## Level of urbanization

Data are from *1270.0.55.001 - Australian Statistical Geography Standard (ASGS): Volume 1 - Main Structure and Greater Capital City Statistical Areas, July 2016* [info](https://www.abs.gov.au/AUSSTATS/abs@.nsf/Lookup/1270.0.55.001Main+Features10018July%202016?OpenDocument)

`No usual address` and `Migratory - Offshore - Shipping` categories are excluded. 

Data are on SA1 level. Population of SA1 was used to find majority classification within each SA3.


```{r include=FALSE}
urban <- read_csv("data/ABS/1270055004_sa1_ucl_sosr_sos_2016_aust_csv/raw/SA1_UCL_SOSR_SOS_2016_AUST.zip", 
                  col_types = cols(AREA_ALBERS_SQKM = col_skip(), 
                                   SOSR_CODE_2016 = col_integer(), 
                                   SOS_CODE_2016 = col_integer(), 
                                   STE_CODE_2016 = col_skip(), STE_NAME_2016 = col_skip())) %>% 
  rename(SA1_MAIN16 = SA1_MAINCODE_2016,
         SA1_7DIG16 = SA1_7DIGITCODE_2016) %>% 
  select(-starts_with("UCL")) %>% 
  filter(!str_detect(SOSR_NAME_2016, "Migratory - Offshore - Shipping")) %>% 
  filter(!str_detect(SOSR_NAME_2016, "No usual address"))

urban %<>% 
  left_join(pop_sa1) %>% 
  left_join(SA1)

urban %<>% 
  rename(pop_sa1_16 = pop_16) %>% 
  group_by(SA2_MAIN16) %>% 
  mutate(pop_sa2_16 = sum(pop_sa1_16)) %>% 
  ungroup() 

rm(pop_sa1, SA1)
gc()
```

### Section of State Range (SOSR) 

Original data

```{r}
urban %>% 
  frq(SOSR_NAME_2016)
```

SA3 assigned to majority

```{r}
urban_sosr <- 
  urban %>% 
  select(-SOS_CODE_2016, -SOS_NAME_2016) %>% 
  group_by(SA2_MAIN16, SOSR_CODE_2016) %>% 
  mutate(pop_sa2_16_cat = sum(pop_sa1_16)) %>% 
  ungroup() %>% 
  mutate(pop_sa2_16_s = pop_sa2_16_cat/pop_sa2_16) %>% 
  arrange(SA2_MAIN16, desc(pop_sa2_16_s)) %>% 
  group_by(SA2_MAIN16, SOSR_CODE_2016) %>%
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  select(-SA1_MAIN16, -SA1_7DIG16, -pop_sa1_16) %>% 
  select(SA2_MAIN16, SA2_5DIG16, SA2_NAME16, everything())

urban_sosr_one <- 
  urban_sosr %>% 
  group_by(SA2_MAIN16) %>%
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  filter(! SA2_5DIG16 %in% c(90101, 90102, 90104, 10803))
```

Share of majority category

```{r}
urban_sosr_one %>% 
  descr(pop_sa2_16_s)

ggplot(urban_sosr_one, aes(pop_sa2_16_s)) + 
  geom_histogram() +
  ylab("Number of SA3") + xlab("Share of majority category") + theme_minimal()
```

Map 

```{r}
SA2 %>% 
  left_join(urban_sosr_one) %>% 
  tm_shape() + 
  tm_polygons(col = "SOSR_NAME_2016", alpha = .5, border.col = NA, id = "SA3_NAME16")
```

### Section of State (SOS)

Original data

```{r}
urban %>% 
  frq(SOS_NAME_2016)
```

SA2 assigned to majority

```{r}
urban_sos <- 
  urban %>% 
  select(-SOSR_CODE_2016, -SOSR_NAME_2016) %>% 
  group_by(SA2_MAIN16, SOS_CODE_2016) %>% 
  mutate(pop_sa2_16_cat = sum(pop_sa1_16)) %>% 
  ungroup() %>% 
  mutate(pop_sa2_16_s = pop_sa2_16_cat/pop_sa2_16) %>% 
  arrange(SA2_MAIN16, desc(pop_sa2_16_s)) %>% 
  group_by(SA2_MAIN16, SOS_CODE_2016) %>%
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  select(-SA1_MAIN16, -SA1_7DIG16, -pop_sa1_16) %>% 
  select(SA2_MAIN16, SA2_5DIG16, SA2_NAME16, everything())

urban_sos_one <- 
  urban_sos %>% 
  group_by(SA2_MAIN16) %>%
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  filter(! SA2_5DIG16 %in% c(90101, 90102, 90104, 10803))
```

Share of majority category

```{r}
urban_sos_one %>% 
  descr(pop_sa2_16_s)

ggplot(urban_sos_one, aes(pop_sa2_16_s)) + 
  geom_histogram() +
  ylab("Number of SA2s") + xlab("Share of majority category") + theme_minimal()
```

Map 

```{r}
SA2 %>% 
  left_join(urban_sos_one) %>% 
  tm_shape() + 
  tm_polygons(col = "SOS_NAME_2016", alpha = .5, border.col = NA, id = "SA3_NAME16")
```

<!-- ------------------------------------------------------------ --> 

## ABS Census 2016 data 

### HOSD Housing Suitability

*This variable is new to 2016 and is a measure of housing utilisation based on a comparison of the number of bedrooms in a dwelling with a series of household demographics, such as the number of usual residents, their relationship to each other, age and sex. The criteria are based on the Canadian National Occupancy Standard (CNOS). This variable can be used to identify if a dwelling is either under or over utilised.* 

(Info)[https://www.abs.gov.au/ausstats/abs@.nsf/Lookup/by%20Subject/2900.0~2016~Main%20Features~HOSD%20Household%20Suitability~10123]

```{r}
HOSD <- read_xlsx("data/ABS/misc/raw/SA2 by HOSD Housing Suitability.xlsx", skip = 8) %>% 
  clean_names() %>%
  remove_empty(c("rows", "cols")) %>% 
  dplyr::rename(SA2_NAME16 = `x2`) %>% 
  filter(!grepl("Migratory - Offshore - Shipping", SA2_NAME16)) %>% 
  filter(!grepl("Cells in this table", SA2_NAME16)) %>% 
  filter(! SA2_NAME16 %in% c("Christmas Island", "Cocos (Keeling) Islands", 
                             "Jervis Bay", "Norfolk Island", 
                             "SA2", "Total")) %>%  
  dplyr::mutate(four_needed = four_or_more_extra_bedrooms_needed / total,
                three_needed = three_extra_bedrooms_needed / total,
                two_needed = two_extra_bedrooms_needed / total,
                one_needed = one_extra_bedroom_needed / total,
                optimal = no_bedrooms_needed_or_spare / total,
                one_spare = one_bedroom_spare / total,
                two_spare = two_bedrooms_spare / total,
                three_spare = three_bedrooms_spare / total,
                four_spare = four_or_more_bedrooms_spare / total) %>% 
  dplyr::mutate(needed = (four_or_more_extra_bedrooms_needed  + 
                            three_extra_bedrooms_needed + 
                            two_extra_bedrooms_needed + 
                            one_extra_bedroom_needed) / total,
                spare = (one_bedroom_spare +
                           two_bedrooms_spare + 
                           three_bedrooms_spare + 
                           four_or_more_bedrooms_spare) / total)

# missing 
HOSD_sf <- SA2 %>% 
  left_join(HOSD)

# checking for airbnbs
airbnb_HOSD_mis <- monthly_new_prep_rent %>%
  filter(! SA2_NAME16 %in% HOSD$SA2_NAME16) %>% 
  distinct(property_id, SA2_NAME16) %>% 
  group_by(SA2_NAME16) %>% 
  summarise(count = n())
rm(airbnb_HOSD_mis)

```

```{r}
HOSD_sf %>% 
  tm_shape() +
  tm_polygons(c("needed", "spare"), 
              n = 7, palette = "RdYlBu", id = "SA3_NAME16") +
  tm_facets(free.scales.fill = FALSE)
```

## SEIFA

```{r}
SEIFA <- read_xls("data/ABS/SEIFA/raw/2033055001 - sa2 indexes.xls", 
                  sheet = "Table 1", skip = 5, na = "-") %>% 
  clean_names() %>%
  remove_empty(c("rows", "cols")) %>% 
  dplyr::rename(SA2_MAIN16 = `x1`, SA2_NAME16 = `x2`, 
                IRSD_s = `score_3`, IRSD_d = `decile_4`,
                IRSAD_s = `score_5`, IRSAD_d = `decile_6`, 
                IER_s = `score_7`, IER_d = `decile_8`, 
                IEO_s = `score_9`, IEO_d = `decile_10`, 
                URP = `x11`) %>% 
  dplyr::mutate(IRSD_d = as.integer(IRSD_d),
                IRSAD_d = as.integer(IRSAD_d),
                IER_d = as.integer(IER_d),
                IEO_d = as.integer(IEO_d)) %>% 
  filter(! SA2_NAME16 %in% c("Christmas Island", "Cocos (Keeling) Islands", 
                             "Jervis Bay", "Norfolk Island")) # Other Teritories


# missing all seifa
SEIFA_mis_sf <- SA2 %>% 
  anti_join(select(SEIFA, SA2_MAIN16, URP))

# checking for airbnbs
airbnb_SEIFA_mis <- monthly_new_prep_rent %>%
  filter(SA2_MAIN16 %in% unique(SEIFA_mis_sf$SA2_MAIN16))


# missing one of seifa
SEIFA_na <- anti_join(SEIFA, select(drop_na(SEIFA), SA2_MAIN16))

SEIFA_na_sf <- SA2 %>% 
  right_join(SEIFA_na)

# checking for airbnbs
airbnb_SEIFA_na <- monthly_new_prep_rent %>%
  filter(SA2_MAIN16 %in% unique(SEIFA_na$SA2_MAIN16))
```

### Areas with no SEIFA

`r nrow(SEIFA_mis_sf)` areas, usually non-residential or with no/low pop. 

There are `r comma(nrow(airbnb_SEIFA_mis))` records of `r comma(length(unique(airbnb_SEIFA_mis$property_id)))` propoerties in these areas. 

```{r}
SEIFA_mis_sf %>% 
  select(-SA2_MAIN16, -SA2_5DIG16, -STE_CODE16, -SA4_GCC_CODE16) %>% 
  tm_shape() +
  tm_polygons(col = "red", alpha = 0.5, lwd = 1)

# SA2 %<>% 
#   filter(!SA2_MAIN16 %in% SEIFA_mis_sf$SA2_MAIN16)
```

### Areas without one or more indices

`r nrow(SEIFA_na)` areas, usually with small pops. **Excluded from analyses!**.

There are `r number(nrow(airbnb_SEIFA_na))` records of `r number(length(unique(airbnb_SEIFA_na$property_id)))` propoerties in these areas. 

```{r}
SEIFA_na_sf %>% 
  select(-SA2_MAIN16, -SA2_5DIG16, -STE_CODE16, -SA4_GCC_CODE16) %>% 
  tm_shape() +
  tm_polygons(col = "red", alpha = 0.5, lwd = 1)
# SA2 %<>% 
#   filter(!SA2_MAIN16 %in% SEIFA_na$SA2_MAIN16)
```

```{r include=FALSE}
rm(SEIFA_na, SEIFA_na_sf, SEIFA_mis_sf, airbnb_SEIFA_na, airbnb_SEIFA_mis)
gc()
```


```{r}
# !!!
# airbnb_sa2 %<>% left_join(select(SEIFA, SA2_MAIN16, ends_with("_d")))
```

### IRSD

Index of Relative Socio-economic Disadvantage deciles 

```{r}
SEIFA_sa2_sf <- left_join(SA2, SEIFA)
rm(SEIFA)

tm_shape(SEIFA_sa2_sf) +
  tm_polygons(col = "IRSD_d", n = 10, palette = "BrBG", alpha = 0.5, lwd = 0)
```

### IRSAD

Index of Relative Socio-economic Advantage and Disadvantage deciles

```{r}
tm_shape(SEIFA_sa2_sf) +
  tm_polygons(col = "IRSAD_d", n = 10, palette = "BrBG", alpha = 0.5, lwd = 0)
```

### IER

Index of Economic Resources deciles

```{r}
tm_shape(SEIFA_sa2_sf) +
  tm_polygons(col = "IER_d", n = 10, palette = "BrBG", alpha = 0.5, lwd = 0)
```

### IEO

Index of Education and Occupation deciles

```{r}
tm_shape(SEIFA_sa2_sf) +
  tm_polygons(col = "IEO_d", n = 10, palette = "BrBG", alpha = 0.5, lwd = 0)
```

## Distance to coast

### Binary

Binary indicator has been created for costal proximity. SA2s that touch the coast have been flagged. Note: this is very crude proxy. Doesn't work well for large areas and in the areas with river estuaries.  

```{r}
coast_bin_sa2 <- read_csv("./data/airdna/raw/Spatial_join/coast_bin_sa2.zip",
                          col_types = cols(COAST = col_integer())) %>% 
  select(SA2_MAIN16, COAST) %>% 
  rename(coast_bin = COAST)

airbnb_sa2 %<>% left_join(coast_bin_sa2)

SA2 <- left_join(SA2, coast_bin_sa2)

rm(coast_bin_sa2)
```

```{r}
filter(airbnb_sa2, reporting_month == as.Date("2017-10-01")) %>% 
  frq(coast_bin)
```

```{r}
tm_shape(SA2) +
  tm_polygons(col = "coast_bin", n = 2, alpha = 0.5, lwd = 0.5)
```

### Average distance

Alternative solution is to calculate distance to coast for all properties and then average that over area. However that leaves the areas without properties without data.

```{r}
coast_near <- read_csv("./data/airdna/raw/Spatial_join/coast_near.zip") %>% 
  rename(property_id = Property_ID, coast_dist = NEAR_DIST) %>% 
  select(property_id, coast_dist)

coast_near %>% 
  select(coast_dist) %>% 
  summarytools::descr(stats = c("mean", "med", "min", "max")) 

SA1_2016_join_new <- readRDS("./data/airdna/clean/SA1_2016_join_new.Rds") %>% 
  dplyr::select(property_id, SA2_5DIG16)

coast_near <- left_join(coast_near, SA1_2016_join_new) %>% 
  group_by(SA2_5DIG16) %>% 
  summarise(cost_mean = mean(coast_dist),
            cost_median = median(coast_dist))

coast_near %>% 
  select(cost_mean, cost_median) %>% 
  summarytools::descr(stats = c("mean", "med", "min", "max")) 

SA2 <- left_join(SA2, coast_near)

rm(coast_near, SA1_2016_join_new)
```

```{r}
tm_shape(SA2) +
  tm_polygons(col = "cost_median", n = 5, alpha = 0.5, lwd = 0.5)
```

## Tourist accomodation

ABS dataset '8635.0 - Tourist Accommodation, Australia, 2015-16' [dataset](http://www.abs.gov.au/AUSSTATS/abs@.nsf/Lookup/8635.0Main+Features12015-16?OpenDocument) could be used to provide information on supply and deman of accomodation on SA2 level. Several indicators are available on **monthly basis for July 2015 - June 2016 period**:

Establishments 
Rooms 
Bed spaces 
Room nights occupied 
Room nights available 
Room occupancy rate
Guest nights occupied 
Guest nights available 
Bed occupancy rate
Takings from accommodation 
Average takings per room night occupied
Average takings per room night available

See external description for an example of 'Guest Nights Occupied' calculations.

```{r}
saveRDS(airbnb_sa2, file = "./data/airdna/clean/airbnb_sa2.rds")
# write_csv(airbnb_sa2, path = "./data/airdna/clean/airbnb_sa2.csv", 
#           na = "NA", append = FALSE, col_names = TRUE)
```

<!-- ------------------------------------------------------------ --> 
<!-- ------------------------------------------------------------ --> 

# Session info

```{r}
sessionInfo()
```

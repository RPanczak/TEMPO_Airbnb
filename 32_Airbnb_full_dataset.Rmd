---
title: "Airbnb"
subtitle: "Misc graphers for presentations"
author: "Radoslaw Panczak"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    highlight: pygments
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 4
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

<!-- ------------------------------------------------------------ --> 
<!-- ------------------------------------------------------------ --> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      fig.width=16, fig.height=10, 
                      out.height="1600px", out.width="1000px", 
                      dpi=320)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
set.seed(12345)
options(scipen = 999)

library(pacman) 
p_load(tidyverse, magrittr, lubridate, scales, readxl, janitor, imputeTS,
       sf, tmap, tmaptools, 
       treemap, ggridges, skimr, summarytools, sjmisc, kableExtra, naniar)

tmap_mode("view") # makes map interactive
```

<!-- ------------------------------------------------------------ --> 

```{r geodata_load, include=FALSE}
# SA2
SA2 <- readRDS(file = "./data/geo/SA2_2016_AUST_clean.rds") %>% 
  # filter(SA4_CODE16 != "901") %>% 
  filter(! SA2_5DIG16 %in% c("91001", "91002", "91004", "11161")) %>% 
  select(-starts_with("SA3")) %>% 
  select(-starts_with("SA1")) %>% 
  select(-starts_with("GCC")) %>% 
  select(-AREASQKM16) %>% 
  mutate(STE_CODE16 = as.numeric(as.character(STE_CODE16))) %>% 
  mutate(SA2_MAIN16 = as.numeric(as.character(SA2_MAIN16))) %>% 
  mutate(SA2_5DIG16 = as.numeric(as.character(SA2_5DIG16))) %>% 
  mutate(SA4_CODE16 = as.numeric(as.character(SA4_CODE16))) %>% 
  mutate(SA4_GCC_CODE16 = case_when(
    SA4_CODE16 %in% c(402, 403, 404) ~ 401,
    SA4_CODE16 %in% c(302:305, 310, 311, 313, 314) ~ 301,
    SA4_CODE16 %in% c(207:214) ~ 206,
    SA4_CODE16 %in% c(503:507) ~ 502,
    SA4_CODE16 %in% c(115:128 ) ~ 102,
    TRUE ~ SA4_CODE16
  )
  ) %>% 
  mutate(SA4_GCC_NAME16 = case_when(
    SA4_GCC_CODE16 == 401 ~ "Greater Adelaide",
    SA4_GCC_CODE16 == 301 ~ "Greater Brisbane",
    SA4_GCC_CODE16 == 206 ~ "Greater Melbourne",
    SA4_GCC_CODE16 == 502 ~ "Greater Perth",
    SA4_GCC_CODE16 == 102 ~ "Greater Sydney",
    TRUE ~ SA4_NAME16
  )
  ) %>% 
  mutate(STE_SHORT = case_when(
    STE_NAME16 == "Australian Capital Territory" ~ "ACT",
    STE_NAME16 == "New South Wales" ~ "NSW",
    STE_NAME16 == "Northern Territory" ~ "NT",
    STE_NAME16 == "Queensland" ~ "QLD",
    STE_NAME16 == "South Australia" ~ "SA",
    STE_NAME16 == "Tasmania" ~ "TAS",
    STE_NAME16 == "Victoria" ~ "VIC",
    STE_NAME16 == "Western Australia" ~ "WA"
  ))

# centroids from arcgis - with option 'inside'
SA2_centr <- st_read("./data/geo/1270055001_sa2_2016_aust_shape/SA2_2016_AUST_centr_inside.shp",
                     stringsAsFactors = FALSE) %>% 
  # filter(SA4_CODE16 != "901") %>% 
  filter(! SA2_5DIG16 %in% c("91001", "91002", "91004", "11161")) %>% 
  select(-starts_with("SA3")) %>% 
  select(-starts_with("SA1")) %>% 
  select(-starts_with("GCC")) %>% 
  select(-AREASQKM16) %>% 
  mutate(STE_CODE16 = as.numeric(as.character(STE_CODE16))) %>% 
  mutate(SA2_MAIN16 = as.numeric(as.character(SA2_MAIN16))) %>% 
  mutate(SA2_5DIG16 = as.numeric(as.character(SA2_5DIG16))) %>% 
  mutate(SA4_CODE16 = as.numeric(as.character(SA4_CODE16))) %>% 
  mutate(SA4_GCC_CODE16 = case_when(
    SA4_CODE16 %in% c(402, 403, 404) ~ 401,
    SA4_CODE16 %in% c(302:305, 310, 311, 313, 314) ~ 301,
    SA4_CODE16 %in% c(207:214) ~ 206,
    SA4_CODE16 %in% c(503:507) ~ 502,
    SA4_CODE16 %in% c(115:128 ) ~ 102,
    TRUE ~ SA4_CODE16
  )
  ) %>% 
  mutate(SA4_GCC_NAME16 = case_when(
    SA4_GCC_CODE16 == 401 ~ "Greater Adelaide",
    SA4_GCC_CODE16 == 301 ~ "Greater Brisbane",
    SA4_GCC_CODE16 == 206 ~ "Greater Melbourne",
    SA4_GCC_CODE16 == 502 ~ "Greater Perth",
    SA4_GCC_CODE16 == 102 ~ "Greater Sydney",
    TRUE ~ SA4_NAME16
  )
  ) %>% 
  mutate(STE_SHORT = case_when(
    STE_NAME16 == "Australian Capital Territory" ~ "ACT",
    STE_NAME16 == "New South Wales" ~ "NSW",
    STE_NAME16 == "Northern Territory" ~ "NT",
    STE_NAME16 == "Queensland" ~ "QLD",
    STE_NAME16 == "South Australia" ~ "SA",
    STE_NAME16 == "Tasmania" ~ "TAS",
    STE_NAME16 == "Victoria" ~ "VIC",
    STE_NAME16 == "Western Australia" ~ "WA"
  ))

# STATES
STE <- readRDS(file = "./data/geo/STE_2016_AUST_clean.rds") %>%  
  mutate(STE_CODE16 = as.numeric(as.character(STE_CODE16))) %>% 
  filter(STE_CODE16 != 9) %>% 
  mutate(STE_SHORT = case_when(
    STE_NAME16 == "Australian Capital Territory" ~ "ACT",
    STE_NAME16 == "New South Wales" ~ "NSW",
    STE_NAME16 == "Northern Territory" ~ "NT",
    STE_NAME16 == "Queensland" ~ "QLD",
    STE_NAME16 == "South Australia" ~ "SA",
    STE_NAME16 == "Tasmania" ~ "TAS",
    STE_NAME16 == "Victoria" ~ "VIC",
    STE_NAME16 == "Western Australia" ~ "WA"
  ))

# qtm(STE)
```

<!-- ------------------------------------------------------------ --> 

# Data preps

```{r, include=FALSE}
monthly_new_prep_eda <- readRDS("./data/airdna/clean/monthly_new_select.Rds") %>% 
  mutate(STE_CODE16 = as.numeric(as.character(STE_CODE16))) %>% 
  mutate(SA2_MAIN16 = as.numeric(as.character(SA2_MAIN16))) %>% 
  mutate(SA2_5DIG16 = as.numeric(as.character(SA2_5DIG16))) %>% 
  mutate(SA4_CODE16 = as.numeric(as.character(SA4_CODE16))) %>% 
  mutate(SA4_GCC_CODE16 = case_when(
    SA4_CODE16 %in% c(402, 403, 404) ~ 401,
    SA4_CODE16 %in% c(302:305, 310, 311, 313, 314) ~ 301,
    SA4_CODE16 %in% c(207:214) ~ 206,
    SA4_CODE16 %in% c(503:507) ~ 502,
    SA4_CODE16 %in% c(115:128 ) ~ 102,
    TRUE ~ SA4_CODE16
  )
  ) %>% 
  mutate(SA4_GCC_NAME16 = case_when(
    SA4_GCC_CODE16 == 401 ~ "Greater Adelaide",
    SA4_GCC_CODE16 == 301 ~ "Greater Brisbane",
    SA4_GCC_CODE16 == 206 ~ "Greater Melbourne",
    SA4_GCC_CODE16 == 502 ~ "Greater Perth",
    SA4_GCC_CODE16 == 102 ~ "Greater Sydney",
    TRUE ~ SA4_NAME16
  )
  ) %>% 
  mutate(STE_SHORT = case_when(
    STE_NAME16 == "Australian Capital Territory" ~ "ACT",
    STE_NAME16 == "New South Wales" ~ "NSW",
    STE_NAME16 == "Northern Territory" ~ "NT",
    STE_NAME16 == "Queensland" ~ "QLD",
    STE_NAME16 == "South Australia" ~ "SA",
    STE_NAME16 == "Tasmania" ~ "TAS",
    STE_NAME16 == "Victoria" ~ "VIC",
    STE_NAME16 == "Western Australia" ~ "WA"
  ))

```

## Selection

### Before 2016 >> still inside !!!

```{r, include=FALSE}
temp <- monthly_new_prep_eda %>% 
  filter(reporting_month < ymd("2016-01-01"))

frq(temp, SA4_NAME16, sort.frq = "desc") 

rm(temp)
gc()
```

### Inactive

```{r}
frq(monthly_new_prep_eda, active, sort.frq = "desc") 

monthly_new_prep_eda %<>% 
  filter(active == TRUE) %>%
  select(-active) 
```

### Remote

```{r}
monthly_new_prep_eda %>% 
  filter(SA2_5DIG16 %in% c("91001", "91002", "91004", "11161")) %>% 
  frq(SA2_NAME16)

monthly_new_prep_eda %<>% 
  filter(! SA2_5DIG16 %in% c("91001", "91002", "91004", "11161")) 
```

## Money issues

```{r include=FALSE}
monthly_new_prep_eda %<>% 
  tidyr::replace_na(list(revenue_native = 0))

# length(unique(monthly_new_prep_eda$property_id)) 
# length(unique(temp1$property_id))

# zero aud - convert to usd
# missing aud - convert to usd
monthly_new_prep_eda %<>% 
  mutate(revenue_native = ifelse(test = revenue_native == 0 & revenue_usd > 0, 
                                 yes = revenue_usd*1.4, 
                                 no = revenue_native)) %>% 
  mutate(revenue_native = ifelse(test = is.na(revenue_native) & !is.na(revenue_usd), 
                                 yes = revenue_usd*1.4, 
                                 no = revenue_native)) 

# monthly_new_prep_eda %>% 
#   arrange(desc(revenue_native)) %>% 
#   select(property_id, reporting_month, reservation_days,
#          starts_with("Revenue"), starts_with("ADR")) %>% 
#   print(n = 36)

monthly_new_prep_eda %<>% 
  mutate(revenue_native = ifelse(test = revenue_native > 95000, 
                                 yes = revenue_usd*1.4, no = revenue_native))

monthly_new_prep_eda %<>% 
  mutate(revenue_native = ifelse(test = property_id == 10045109 & reporting_month == "2016-02-01", 
                                 yes = mean(c(45.42, 48.11))*9, no = revenue_native))

monthly_new_prep_eda %<>% 
  mutate(revenue_native = ifelse(test = property_id == 11287673, 
                                 yes = reservation_days*28, no = revenue_native))

monthly_new_prep_eda %<>% 
  mutate(revenue_native = ifelse(test = property_id == 23709347	&
                                   reporting_month == ymd("2018-04-01"), 
                                 yes = reservation_days*adr_usd*1.4, no = revenue_native))

monthly_new_prep_eda %<>% 
  mutate(revenue_native = ifelse(test = property_id == 22267809	&
                                   reporting_month == ymd("2018-05-01"), 
                                 yes = reservation_days*adr_usd*1.4, no = revenue_native))

monthly_new_prep_eda %<>% 
  mutate(revenue_native = ifelse(test = property_id == 22536123	&
                                   reporting_month == ymd("2018-07-01"), 
                                 yes = reservation_days*adr_usd*1.4, no = revenue_native))
monthly_new_prep_eda %<>% 
  mutate(revenue_native = ifelse(test = property_id == 22536123	&
                                   reporting_month == ymd("2018-04-01"), 
                                 yes = reservation_days*adr_usd*1.4, no = revenue_native))

monthly_new_prep_eda %<>% 
  mutate(revenue_native = ifelse(test = property_id == 11926837	&
                                   reporting_month == ymd("2016-06-01"), 
                                 yes = reservation_days*adr_usd*1.4, no = revenue_native))

monthly_new_prep_eda %<>% 
  mutate(revenue_native = ifelse(test = property_id == 27554784	&
                                   reporting_month == ymd("2019-02-01"), 
                                 yes = reservation_days*adr_usd*1.4, no = revenue_native))


monthly_new_prep_eda %<>% 
  mutate(revenue_native = ifelse(test = property_id == 15206751	&
                                   reporting_month == ymd("2017-04-01"), 
                                 yes = reservation_days*adr_usd*1.4, no = revenue_native))

monthly_new_prep_eda %<>% 
  mutate(revenue_native = ifelse(test = property_id == 15206751	&
                                   reporting_month == ymd("2017-05-01"), 
                                 yes = reservation_days*adr_usd*1.4, no = revenue_native))

monthly_new_prep_eda %<>% 
  mutate(revenue_native = ifelse(test = property_id == 27554784	&
                                   reporting_month == ymd("2019-01-01"), 
                                 yes = reservation_days*adr_usd*1.4, no = revenue_native))

# monthly_new_prep_eda %>% 
#   arrange(desc(revenue_native)) %>% 
#   select(property_id, reporting_month, reservation_days,
#          starts_with("Revenue"), starts_with("ADR")) %>% 
#   print(n = 36)

# View(filter(property_select, property_id == 14999741))
# Luxury 80ft Motor Yacht - 4 Bedroom
# $6,990.00 per night

# View(filter(property_select, property_id == 30109331))
# Kalinya Estate - Homestead & Lodge -26 p
# $3,200.00 per night
```

## Bedrooms

```{r include=FALSE}
monthly_new_prep_eda %<>% 
  mutate(bedrooms_new = ifelse(bedrooms == 0, 1, bedrooms)) %>% 
  mutate(bedrooms_new = ifelse(bedrooms >= 6, 6, bedrooms))

frq(monthly_new_prep_eda, bedrooms)
frq(monthly_new_prep_eda, bedrooms_new)
```

## Property type

Analysed properties come in different flavours

```{r}
frq(monthly_new_prep_eda, property_type, sort.frq = "desc") 
```

```{r}
property_type <- readRDS("data/airdna/clean/property_type") %>% 
  select(property_type, property_type_new)

property_type %>% 
  knitr::kable()

monthly_new_prep_eda %<>% 
  left_join(property_type)

frq(monthly_new_prep_eda, property_type)
frq(monthly_new_prep_eda, property_type_new)
```

## Listing type

```{r}
frq(monthly_new_prep_eda, listing_type)
```

```{r include=FALSE}
saveRDS(monthly_new_prep_eda, "./data/airdna/clean/monthly_new_prep_eda.rds")

# monthly_new_prep_eda <- readRDS("./data/airdna/clean/monthly_new_prep_eda.rds")

```

# SA2 aggregates

`r nrow(filter(SA2, !SA2_MAIN16 %in% unique(monthly_new_prep_eda$SA2_MAIN16)))` SA2s (out of `r nrow(SA2)`) have no Airbnbs inside. 

**These areas were kept in analyses, unless excluded for reasons further down.**

```{r include=FALSE, eval=FALSE}
# SA2 %<>% 
#   filter(!SA2_MAIN16 %in% temp$SA2_MAIN16)
# 
# SA2_centr %<>% 
#   filter(!SA2_MAIN16 %in% temp$SA2_MAIN16)
# 
# rm(temp)

```

## Income time series

```{r, include=FALSE}
temp <- monthly_new_prep_eda %>% 
  group_by(SA2_MAIN16, reporting_month) %>% 
  summarise(revenue = sum(revenue_native, na.rm = TRUE)) %>% 
  ungroup()

income_sa2 <- left_join(st_drop_geometry(SA2), temp) %>% 
  expand(SA2_MAIN16, reporting_month) %>% 
  filter(!is.na(reporting_month)) %>% 
  left_join(st_drop_geometry(SA2)) %>% 
  left_join(temp) %>% 
  tidyr::replace_na(list(revenue = 0)) %>% 
  mutate(revenue = as.integer(round(revenue))) %>% 
  mutate_if(is.factor, as.character) %>% 
  group_by(SA2_MAIN16) %>% arrange(reporting_month) %>% mutate(cumulative = cumsum(revenue)) %>% 
  ungroup() %>% 
  arrange(SA2_MAIN16, reporting_month)

# summarytools::freq(airbnb_sa2$reporting_month)
stopifnot(nrow(SA2) * length(unique(monthly_new_prep_eda$reporting_month)) == nrow(income_sa2))

# table(is.na(monthly_new_prep_eda$SA1_7DIG16))
# frq(income_sa2, reporting_month)

```

## Property time series

```{r, include=FALSE}
temp <- monthly_new_prep_eda %>% 
  group_by(SA2_MAIN16, reporting_month) %>% 
  summarise(properties = n()) %>% 
  ungroup()

properties_sa2 <- left_join(st_drop_geometry(SA2), temp) %>% 
  expand(SA2_MAIN16, reporting_month) %>% 
  filter(!is.na(reporting_month)) %>% 
  left_join(st_drop_geometry(SA2)) %>% 
  left_join(temp) %>% 
  tidyr::replace_na(list(properties = 0)) %>% 
  mutate(properties = as.integer(round(properties))) %>% 
  mutate_if(is.factor, as.character) %>% 
  arrange(SA2_MAIN16, reporting_month)

# summarytools::freq(airbnb_sa2$reporting_month)
stopifnot(nrow(SA2) * length(unique(monthly_new_prep_eda$reporting_month)) == nrow(properties_sa2))

# table(is.na(monthly_new_prep_eda$SA1_7DIG16))
# frq(properties_sa2, reporting_month)

rm(temp)
gc()

```

<!-- ------------------------------------------------------------ --> 

# SA2 areas with no Airbnb data

`r nrow(filter(SA2, !SA2_MAIN16 %in% unique(monthly_new_prep$SA2_MAIN16)))` SA2s have no Airbnbs inside. 

```{r}
temp <- SA2 %>% 
  filter(!SA2_MAIN16 %in% unique(monthly_new_prep$SA2_MAIN16))
```

```{r}
temp %>%
  st_drop_geometry() %>% 
  select(SA2_NAME16, SA4_NAME16, GCC_NAME16) %>% 
  # knitr::kable()
  print()
```

```{r, fig.height = 8 , fig.width = 6 , fig.cap = "SA2 areaas with no Airbnb listings"}
tm_shape(STE) +
  tm_borders(col = "grey20", lwd = 1.5)  +
  tm_shape(temp) +
  tm_fill(col = "red", border.col = "white", alpha = 0.5, labels = "SA2_NAME16") +
  tm_shape(temp) +
  tm_text(size = 0.5, text = "SA2_NAME16", remove.overlap = TRUE)

```

<!-- ------------------------------------------------------------ --> 

# Cumulative income over time


```{r}


ggsave(anime, height = 1000, width = 1600)

```


<!-- ------------------------------------------------------------ --> 

# Monthly data availability

```{r}
temp <- monthly_new_prep %>% 
  group_by(property_id) %>% 
  summarize(number_monthly_records = n()) %>% 
  ungroup()
```

Listings have varying amount of monthly records. That can range from `r min(temp$number_monthly_records)` to `r max(temp$number_monthly_records)` with median number being `r number(median(temp$number_monthly_records))`

```{r}
frq(temp, number_monthly_records) 

descr(temp, number_monthly_records) 

ggplot(temp, aes(number_monthly_records)) + geom_histogram(binwidth = 1)
```
<!-- ------------------------------------------------------------ --> 

# Session info

```{r}
sessionInfo()
```

---
title: "Airbnb - TMR report"
subtitle: "Data preparation"
# author: "Radoslaw Panczak & Thomas Sigler"
author:
- Radoslaw Panczak & Thomas Sigler
- Queensland Centre for Population Research
date: "`r format(Sys.time(), '%d %B, %Y')`"
geometry: "left=2cm,right=2cm,top=2cm,bottom=2cm"
output:
  pdf_document:
    fig_caption: yes
    fig_crop: yes
    highlight: haddock
    number_sections: yes
    toc: yes
    toc_depth: 2
header-includes: 
- \usepackage{graphicx}
- \usepackage{float}
---

<!-- ------------------------------------------------------------ --> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      cache = FALSE,
                      fig.align="center",
                      fig.pos="H",
                      dpi = 300)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

set.seed(12345)
options(scipen = 999)

library(pacman) 
p_load(tidyverse, magrittr, lubridate, scales, janitor, imputeTS,
       sf, tmap, tmaptools, 
       sjmisc, kableExtra)

tmap_mode("plot")
```

<!-- ------------------------------------------------------------ --> 

\newpage

# SA2 areas

```{r geodata_load, include=FALSE}
# SA2
SA2 <- readRDS(file = "./data/geo/SA2_2016_AUST_clean.rds") %>% 
  filter(STE_NAME16 == "Queensland" | SA4_NAME16 == "Richmond - Tweed") %>% 
  select(-starts_with("SA3")) %>% 
  select(-starts_with("SA1")) %>% 
  select(-AREASQKM16) %>%
  mutate(STE_CODE16 = as.numeric(as.character(STE_CODE16))) %>% 
  mutate(SA2_MAIN16 = as.numeric(as.character(SA2_MAIN16))) %>% 
  mutate(SA2_5DIG16 = as.numeric(as.character(SA2_5DIG16))) %>% 
  mutate(SA4_CODE16 = as.numeric(as.character(SA4_CODE16))) 

# centroids from arcgis - with option 'inside'
SA2_centr <- st_read("./data/geo/1270055001_sa2_2016_aust_shape/SA2_2016_AUST_centr_inside.shp",
                     stringsAsFactors = FALSE) %>% 
  filter(STE_NAME16 == "Queensland" | SA4_NAME16 == "Richmond - Tweed") %>% 
  select(-starts_with("SA3")) %>% 
  select(-starts_with("SA1")) %>% 
  select(-AREASQKM16) %>%
  mutate(STE_CODE16 = as.numeric(as.character(STE_CODE16))) %>% 
  mutate(SA2_MAIN16 = as.numeric(as.character(SA2_MAIN16))) %>% 
  mutate(SA2_5DIG16 = as.numeric(as.character(SA2_5DIG16))) %>% 
  mutate(SA4_CODE16 = as.numeric(as.character(SA4_CODE16))) 

# STATES
STE <- readRDS(file = "./data/geo/STE_2016_AUST_clean.rds") %>%  
  mutate(STE_CODE16 = as.numeric(as.character(STE_CODE16))) %>% 
  filter(STE_NAME16 == "Queensland")

# qtm(STE)

saveRDS(SA2, "TMR/data/SA2.Rds")
saveRDS(SA2_centr, "TMR/data/SA2_centr.Rds")
saveRDS(STE, "TMR/data/STE.Rds")
```

The study area consists of `r comma(nrow(SA2))` SA2 areas. `r comma(nrow(filter(SA2, SA4_NAME16 == "Richmond - Tweed")))` of them are the areas from NSW corresponding to `Richmond - Tweed` SA4.

```{r, fig.height = 8 , fig.width = 6 , fig.cap = "Study area"}
tm_shape(SA2) +
  tm_borders(lwd = 0.5) +
  tm_shape(STE) +
  tm_borders(lwd = 1.0)  +
  tm_layout(title = "Study area",
            title.size = 0.66,
            title.position = c("right", "top")) +
  tm_credits("Geodata (c) ABS", position=c("RIGHT", "BOTTOM"), size = 0.5)
```


<!-- ------------------------------------------------------------ --> 

\newpage

# Airdna data

## Raw data

```{r, include=FALSE}
monthly_new_select <- readRDS("data/airdna/clean/monthly_new_select.Rds") 
```

Raw datasets for Australia consist of `r comma(length(unique(monthly_new_select$property_id)))` properties and `r comma(nrow(monthly_new_select))` monthly stats. 

## Starting in 2016-01-01

`r comma(nrow(filter(monthly_new_select, reporting_month < ymd("2016-01-01"))))` data points from before 2016-01-01 were excluded.

```{r}
monthly_new_select %<>% 
  filter(reporting_month >= ymd("2016-01-01"))
```

## Geographic coordinates

Locations of Airbnb properties (points) are specified by geographic coordinates. They were linked to [ABS data of SA2 areas from 2016](https://www.abs.gov.au/AUSSTATS/abs@.nsf/Lookup/1270.0.55.001Main+Features10018July%202016?OpenDocument). Spatial join in ArcGIS was used with `CLOSEST` option to capture locations that did not overlap with polygons (due to privacy reasons, locations are not exact). 

\begin{figure}[H]
\centering
\includegraphics[width=0.5\linewidth]{imprecise.PNG}
\caption{Example of coordinates outside of region boundaries.}
\end{figure}

## Listings in the study area

```{r include=FALSE}
monthly_new_prep_tmr <- monthly_new_select %>% 
  filter(STE_NAME16 == "Queensland" | SA4_NAME16 == "Richmond - Tweed") %>% 
  select(-starts_with("SA3")) %>% 
  select(-starts_with("SA1"))

rm(monthly_new_select)
gc()
```

Selection of records for the study are results in `r comma(length(unique(monthly_new_prep_tmr$property_id)))` properties and `r comma(nrow(monthly_new_prep_tmr))` monthly stats. 

## Inactive listings 1

Over third of monthly records is labelled as not active. 

```{r}
frq(monthly_new_prep_tmr, active, sort.frq = "desc") 
```

```{r include=FALSE}
# temp <- monthly_new_prep_tmr %>% 
#   filter(active == FALSE) %>% 
#   select(-active)

temp1 <- monthly_new_prep_tmr %>% 
  filter(active == FALSE) %>% 
  select(-active) %>% 
  filter(!is.na(revenue_usd) | !is.na(revenue_native)) %>% 
  filter(revenue_usd > 0 | revenue_native > 0)

temp2 <- monthly_new_prep_tmr %>% 
  filter(active == FALSE) %>% 
  select(-active) %>% 
  filter(available_days > 0 )
```

All of them were excluded. 

That also applied to records where there was some information about the revenue (either AUD or USD; n = `r comma(nrow(temp1))`) or number of available days was indicated to be > 0 (n = `r comma(nrow(temp2))`). For the former group, that could indicate some reshuffling of money from previous months? For the latter group - this doesn't make sense but at least none of these records has any reservations.  

```{r include=FALSE}
monthly_new_prep_tmr %<>% 
  filter(active == TRUE) %>%
  select(-active) %>%
  tidyr::replace_na(list(revenue_native = 0))

rm(temp1, temp2)
```

## Inactive listings 2

Less than tenth of remaining monthly records is labelled as active, but the variable `available_days` is equal zero suggesting inactivity. 

```{r}
monthly_new_prep_tmr %<>% 
  mutate(zero_days = ifelse(available_days == 0, TRUE, FALSE))

# frq(monthly_new_prep_tmr, available_days) 
frq(monthly_new_prep_tmr, zero_days, sort.frq = "desc") 
```

All such records were excluded.

```{r include=FALSE}
monthly_new_prep_tmr %<>% 
  filter(zero_days == FALSE) %>%
  select(-zero_days) 
```

## Missing information on number of bedrooms

`r comma(nrow(monthly_new_prep_tmr %>% filter(is.na(bedrooms))))` records of `r comma(nrow(monthly_new_prep_tmr %>% filter(is.na(bedrooms)) %>% select(property_id) %>% distinct()))` properties with missing information on number of bedrooms were excluded. Almost two thirds of them have missing information on `property_type` and many of the remaining belong to unusual catoegories of accomodation.

```{r}
temp <- monthly_new_prep_tmr %>%
  group_by(property_id) %>%
  filter(row_number() == 1) %>%
  ungroup() %>%
  filter(is.na(bedrooms))

frq(temp, property_type)

monthly_new_prep_tmr %<>% 
  filter(!is.na(bedrooms))
```

## Properties with 4+ bedrooms

`r comma(nrow(monthly_new_prep_tmr %>% filter(bedrooms >= 4)))` records of `r comma(nrow(monthly_new_prep_tmr %>% filter(bedrooms >= 4) %>% select(property_id) %>% distinct()))` properties with 4 or more bedrooms were combined  into one group

```{r}
monthly_new_prep_tmr %<>% 
  mutate(bedrooms = ifelse(bedrooms >= 4, 4, bedrooms))

temp <- monthly_new_prep_tmr %>%
  group_by(property_id) %>%
  filter(row_number() == 1) %>%
  ungroup() %>%
  filter(!is.na(bedrooms)) %>%
  mutate(bedrooms = ifelse(bedrooms >= 6, 6, bedrooms))

frq(temp, bedrooms)
```

## Listing type

```{r}
temp <- monthly_new_prep_tmr %>%
  group_by(property_id) %>%
  filter(row_number() == 1) %>%
  ungroup()

frq(temp, listing_type, sort.frq = "desc") 
```

## Property type

Analysed properties come in different flavours:

```{r}
frq(monthly_new_prep_tmr, property_type, sort.frq = "desc") 
```

Classification of properties was simplified to `House` and `Unit` whenever possible:

```{r eval=FALSE, include=FALSE}
p_load(googledrive, googlesheets4)

property_type <- read_sheet(drive_get("property_type")) %>% 
  filter(property_type != "NA") # saved as text here

saveRDS(property_type, "data/airdna/clean/property_type")

p_unload(googledrive, googlesheets4)
```

```{r}
property_type <- readRDS("data/airdna/clean/property_type") %>% 
  select(property_type, property_type_new) %>% 
  tidyr::replace_na(list(property_type_new = ""))

property_type %>% 
  print(n = Inf)

monthly_new_prep_tmr %<>% 
  left_join(property_type) %>% 
  tidyr::replace_na(list(property_type_new = ""))

```

Frequency of new classification:

```{r}
temp <- monthly_new_prep_tmr %>% 
  group_by(property_id) %>% 
  filter(row_number() == 1) %>% 
  ungroup()

frq(monthly_new_prep_tmr, property_type_new, sort.frq = "desc") 
```

```{r eval=FALSE, include=FALSE}
temp %>%
  tabyl(listing_type, property_type_new) %>%
  adorn_totals(c("row", "col")) %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 0) %>%
  adorn_ns() %>%
  knitr::kable()
```

```{r}
saveRDS(monthly_new_prep_tmr, "TMR/data/monthly_new_prep_tmr.Rds")
```

<!-- ------------------------------------------------------------ --> 

\newpage

# Combined data

## SA2 areas with no Airbnb data

`r nrow(filter(SA2, !SA2_MAIN16 %in% unique(monthly_new_prep_tmr$SA2_MAIN16)))` SA2s have no Airbnbs inside. 

```{r}
temp <- SA2 %>% 
  filter(!SA2_MAIN16 %in% unique(monthly_new_prep_tmr$SA2_MAIN16))
```

```{r}
temp %>%
  st_drop_geometry() %>% 
  select(SA2_NAME16, SA4_NAME16, GCC_NAME16) %>% 
  # knitr::kable()
  print()
```

```{r, fig.height = 8 , fig.width = 6 , fig.cap = "Study area"}
tm_shape(STE) +
  tm_borders() +
  tm_shape(temp) +
  tm_fill(col = "red", border.col = "white", alpha = 0.5, labels = "SA2_NAME16") +
  tm_shape(temp) +
  tm_text(size = 0.5, text = "SA2_NAME16", remove.overlap = TRUE)

```

## SA2 aggregation

### Occupancy rate

`occupancy_rate` was calculated for the entire time series for each region

```{r, include=FALSE}
temp <- monthly_new_prep_tmr %>% 
  group_by(SA2_MAIN16) %>% 
  summarize(mean_occupancy_rate = mean(occupancy_rate, na.rm = TRUE),
            median_occupancy_rate = median(occupancy_rate, na.rm = TRUE))

airbnb_sa2_occupancy_rate <- left_join(st_drop_geometry(SA2), temp) %>% 
  expand(SA2_MAIN16) %>% 
  filter(!is.na(SA2_MAIN16)) %>% 
  left_join(st_drop_geometry(SA2)) %>% 
  left_join(temp) %>% 
  mutate_if(is.factor, as.character) %>% 
  ungroup() %>% 
  arrange(SA2_MAIN16)

# summary(airbnb_sa2_occupancy_rate$mean_occupancy_rate)
# summary(airbnb_sa2_occupancy_rate$median_occupancy_rate)
stopifnot(nrow(SA2) == nrow(airbnb_sa2_occupancy_rate))

rm(temp)
```


```{r}
airbnb_sa2_occupancy_rate %>% 
  select(SA2_NAME16, mean_occupancy_rate)
```


### Monthly aggregations

Other aggregations were implemented for each region & month combination

```{r, include=FALSE}
temp <- monthly_new_prep_tmr %>% 
  group_by(SA2_MAIN16, reporting_month) %>% 
  summarize(supply = n())

airbnb_sa2_supply <- left_join(st_drop_geometry(SA2), temp) %>% 
  expand(SA2_MAIN16, reporting_month) %>% 
  filter(!is.na(reporting_month)) %>% 
  left_join(st_drop_geometry(SA2)) %>% 
  left_join(temp) %>% 
  tidyr::replace_na(list(supply = 0)) %>% 
  mutate(supply = as.integer(supply)) %>% 
  mutate_if(is.factor, as.character) %>% 
  ungroup() %>% 
  arrange(SA2_MAIN16, reporting_month)

# summary(airbnb_sa2_supply$supply)
stopifnot(nrow(SA2) * length(unique(monthly_new_prep_tmr$reporting_month)) == nrow(airbnb_sa2_supply))
```

```{r}
airbnb_sa2_supply %>% 
  select(SA2_NAME16, reporting_month, supply)
```

### Feb '19 aggregations

Finally, certain aggregations were implemented using latest available data for Feb 2019-02

```{r, include=FALSE}
temp <- monthly_new_prep_tmr %>% 
  filter(reporting_month == ymd("2019-02-01")) %>% 
  select(-reporting_month) %>% 
  group_by(SA2_MAIN16, bedrooms) %>% 
  summarize(supply_bedrooms = n())

airbnb_sa2_bedrooms <- left_join(st_drop_geometry(SA2), temp) %>% 
  expand(SA2_MAIN16, bedrooms) %>% 
  filter(!is.na(bedrooms)) %>% 
  left_join(st_drop_geometry(SA2)) %>% 
  left_join(temp) %>% 
  tidyr::replace_na(list(supply_bedrooms = 0)) %>% 
  mutate(supply_bedrooms = as.integer(supply_bedrooms)) %>% 
  mutate_if(is.factor, as.character) %>% 
  ungroup() %>% 
  arrange(SA2_MAIN16, bedrooms)

# summary(airbnb_sa2_supply$supply)
stopifnot(nrow(SA2) * length(unique(monthly_new_prep_tmr$bedrooms)) == nrow(airbnb_sa2_bedrooms))
```

```{r}
airbnb_sa2_bedrooms %>% 
  select(SA2_NAME16, bedrooms, supply_bedrooms)
```


---
title: "Airbnb - relation between rent & Airbnb revenue and supply on SA2 level"
subtitle: "EDA"
author: "Radoslaw Panczak"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    highlight: pygments
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 4
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

<!-- ------------------------------------------------------------ --> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      cache = FALSE,
                      fig.width=8, fig.height=6, 
                      out.width="800px", out.height="600px", 
                      dpi=300)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
set.seed(12345)
options(scipen = 999)

library(pacman) 
p_load(tidyverse, magrittr, lubridate, scales, readxl, janitor, imputeTS,
       sf, tmap, tmaptools, 
       ggridges, skimr, summarytools, sjmisc, kableExtra, naniar)

tmap_mode("view") # makes map interactive
```


```{r include=FALSE}
APM_sa2 <- readRDS("data/APM/clean/APM_sa2.Rds") %>% 
  mutate(awr_25p_int = 7*adr_25p_int,
         awr_50p_int = 7*adr_50p_int,
         awr_75p_int = 7*adr_75p_int) %>% 
  mutate(awr_25p_int = as.integer(round(adr_25p_int)),
         awr_50p_int = as.integer(round(adr_50p_int)),
         awr_75p_int = as.integer(round(adr_75p_int)))

SA2_U_include <- readRDS("data/APM/clean/SA2_U_include.Rds")
SA2_U_centr_include <- readRDS("data/APM/clean/SA2_U_centr_include.Rds")
SA2_H_include <- readRDS("data/APM/clean/SA2_H_include.Rds")
SA2_H_centr_include <- readRDS("data/APM/clean/SA2_H_centr_include.Rds")

SA2 <- readRDS(file = "./data/geo/SA2_2016_AUST_clean.rds") %>% 
  filter(! SA2_5DIG16 %in% c("91001", "91002", "91004", "11161")) %>% 
  select(-starts_with("SA3")) %>% 
  select(-starts_with("SA1")) %>% 
  select(-starts_with("GCC")) %>% 
  select(-AREASQKM16, -SA4_CODE16, -SA4_NAME16) %>% 
  mutate(STE_CODE16 = as.numeric(as.character(STE_CODE16))) %>% 
  mutate(SA2_MAIN16 = as.numeric(as.character(SA2_MAIN16))) %>% 
  mutate(SA2_5DIG16 = as.numeric(as.character(SA2_5DIG16))) 

STE <- readRDS(file = "./data/geo/STE_2016_AUST_clean.rds") %>%  
  mutate(STE_CODE16 = as.numeric(as.character(STE_CODE16))) %>% 
  filter(STE_CODE16 != 9) 

```

```{r fig.width=16, fig.height=10, out.width="1600px", out.height="1000px"}
APM_sa2 %>% 
  filter(property_type == "Unit") %>% 
  ggplot(aes(x = date, y = awr_50p_int*7)) + 
  geom_smooth(aes(group = STE_NAME16, 
                  # weight = n_listings_int, 
                  color = STE_NAME16), 
              alpha = 0.5, se = FALSE) +
  theme_minimal() + 
  labs(x = "", y = "Median AWR in SA2", title = "AWR - units")

APM_sa2 %>% 
  filter(property_type == "Unit") %>% 
  ggplot(aes(x = date, y = rent_50p_int)) + 
  geom_smooth(aes(group = STE_NAME16, 
                  # weight = n_listings_int, 
                  color = STE_NAME16), 
              alpha = 0.5, se = FALSE) +
  theme_minimal() + 
  labs(x = "", y = "Median AWR in SA2", title = "Rent - units")

APM_sa2 %>% 
  filter(property_type == "Unit") %>% 
  filter(date == ymd("2019-02-01")) %>% 
  ggplot(aes(x = awr_50p_int*7, y = rent_50p_int)) + 
  geom_point(alpha = 0.5) +
  geom_smooth(aes(group = STE_NAME16, 
                  # weight = n_listings_int, 
                  color = STE_NAME16), 
              alpha = 0.5, se = FALSE) +
  coord_cartesian(xlim = c(0, 17500)) + 
  theme_minimal() + 
  facet_wrap(~STE_NAME16) +
  labs(x = "Median AWR", y = "Median rent", 
       title = "SA2 rent vs. AWR - units (2019-02)")

```


<!-- ------------------------------------------------------------ --> 

# Time series of data

**All analyses are for areas with at elast 10 listings and 25 rental properites.**

```{r include=FALSE}
hist(APM_sa2$record_count)
summary(APM_sa2$record_count)

hist(APM_sa2$n_listings)
summary(APM_sa2$n_listings)

APM_sa2_cor <- 
  APM_sa2 %>%
  filter(!is.na(rent_50p_int)) %>%
  filter(!is.na(awr_50p_int)) %>%
  group_by(SA2_MAIN16, SA2_NAME16, property_type) %>% 
  summarize(
    min_apm = min(record_count, na.rm = TRUE),
    min_airbnb = min(n_listings, na.rm = TRUE),
    mean_apm = mean(record_count, na.rm = TRUE),
    mean_airbnb = mean(n_listings, na.rm = TRUE),
    cor_25 = cor(rent_25p_int, awr_25p_int),
    cor_50 = cor(rent_50p_int, awr_50p_int),
    cor_75 = cor(rent_75p_int, awr_75p_int)
  ) %>% 
  ungroup() %>% 
  filter(min_apm >= 25) %>%
  filter(min_airbnb >= 10)

summary(APM_sa2_cor$mean_airbnb)
summary(APM_sa2_cor$mean_apm)
summary(APM_sa2_cor$min_airbnb)
summary(APM_sa2_cor$min_apm)
```

## Same Y axis, split py property

```{r eval=FALSE, include=FALSE}
temp <- unique(APM_sa2_cor$SA2_NAME16)

overlap <- 
  select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  left_join(APM_sa2)

for (i in 1:length(temp)) {
  
  label_house <- APM_sa2_cor %>% 
    filter(SA2_NAME16 == temp[i]) %>% 
    filter(property_type == "House") 
  
  label_unit <- APM_sa2_cor %>% 
    filter(SA2_NAME16 == temp[i]) %>% 
    filter(property_type == "Unit") 
  
  if (nrow(label_house) > 0 & nrow(label_unit) > 0 ) {
    caption_text <- 
      paste0("Correlation of house prices = ", 
             number(label_house$cor_50, accuracy = .001), 
             "; unit prices = ", 
             number(label_unit$cor_50, accuracy = .001), ".\n",
             "Min units properties/listings = ", 
             number(label_unit$min_apm), "/", number(label_unit$min_airbnb),
             "; min houses properties/listings = ", 
             number(label_house$min_apm), "/", number(label_house$min_airbnb),
             "."
      )
  } else if (nrow(label_house) > 0 & nrow(label_unit) == 0 ) {
    caption_text <- 
      paste0("Correlation of house prices = ", 
             number(label_house$cor_50, accuracy = .001), 
             ".\n",
             "Min houses properties/listings = ", 
             number(label_house$min_apm), "/", number(label_house$min_airbnb),
             "."
      )
  } else if (nrow(label_house) == 0 & nrow(label_unit) > 0 ) {
    caption_text <- 
      paste0("Correlation of unit prices = ", 
             number(label_unit$cor_50, accuracy = .001), 
             ".\n",
             "Min units properties/listings = ", 
             number(label_unit$min_apm), "/", number(label_unit$min_airbnb),
             "."
      )
  }
  
  overlap %>%
    filter(SA2_NAME16 == temp[i]) %>% 
    ggplot(aes(x=date)) +
    geom_ribbon(aes(ymin=rent_25p_int, ymax=rent_75p_int), 
                fill = "#00AFBB", alpha = .33) +
    geom_line(aes(y=rent_50p_int, col = "Rent"), 
              size = 1) +
    geom_point(aes(y=rent_50p_int, size = record_count), 
               col = "#00AFBB", alpha = .50) + 
    geom_ribbon(aes(ymin=awr_25p_int, ymax=awr_75p_int), 
                fill = "#E7B800", alpha = .33) +
    geom_line(aes(y=awr_50p_int, col = "Airbnb"), size = 1) +
    geom_point(aes(y=awr_50p_int, size = n_listings), 
               col = "#E7B800", alpha = .50) + 
    scale_color_manual(name = "Prices", 
                       values = c("Rent" = "#00AFBB", "Airbnb" = "#E7B800")) +
    scale_size(
      limits = c(min(APM_sa2$record_count_int),
                 max(max(APM_sa2$record_count_int), max(APM_sa2$n_listings))), 
      range = c(1, 7)
    ) +
    scale_y_continuous(limits = c(0, NA)) +
    facet_wrap(~property_type, scales = "free_y") +
    theme_minimal() + xlab("") + ylab("Weekly median rent / AWR") + 
    labs(size = "Properites (rent) \nListings (AWR)",
         caption = caption_text,
         title = temp[i])
  
  path <- paste0("plot/apm/adr/", temp[i], ".png")
  
  ggsave(path, width = 8, height = 4.5, dpi = "retina")
  
}
```

Example data for one region

![](plot/apm/awr_1/Arncliffe - Bardwell Valley.png)

Separate Y axes!
Rest of areas on RDM.

## Separate Y axis

```{r eval=FALSE, include=FALSE}
temp <- unique(APM_sa2_cor$SA2_NAME16)

overlap <- 
  select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  left_join(APM_sa2)

for (i in 1:length(temp)) {
  
  label_house <- APM_sa2_cor %>% 
    filter(SA2_NAME16 == temp[i]) %>% 
    filter(property_type == "House") 
  
  label_unit <- APM_sa2_cor %>% 
    filter(SA2_NAME16 == temp[i]) %>% 
    filter(property_type == "Unit") 
  
  caption_house <- 
    paste0("Correlation of house prices = ", 
           number(label_house$cor_50, accuracy = .001), 
           ".",
           "Min houses properties/listings = ", 
           number(label_house$min_apm), "/", number(label_house$min_airbnb),
           ".")
  
  caption_unit <- 
    paste0("Correlation of unit prices = ", 
           number(label_unit$cor_50, accuracy = .001), 
           ".",
           "Min units properties/listings = ", 
           number(label_unit$min_apm), "/", number(label_unit$min_airbnb),
           ".")
  
  if (nrow(label_house) > 0) {
    
    bind_rows(
      
      overlap %>%
        filter(SA2_NAME16 == temp[i]) %>% 
        filter(property_type == "House") %>% 
        select(date, rent_25p_int, rent_50p_int, rent_75p_int, record_count) %>% 
        rename(p25 = rent_25p_int, p50 = rent_50p_int, 
               p75 = rent_75p_int, n = record_count) %>% 
        mutate(type = "Rent"),
      
      overlap %>%
        filter(SA2_NAME16 == temp[i]) %>% 
        filter(property_type == "House") %>% 
        select(date, awr_25p_int, awr_50p_int, awr_75p_int, n_listings) %>% 
        rename(p25 = awr_25p_int, p50 = awr_50p_int, 
               p75 = awr_75p_int, n = n_listings) %>% 
        mutate(type = "Airbnb") 
      
    ) %>% 
      ggplot(aes(x=date)) +
      geom_ribbon(aes(ymin=p25, ymax=p75, fill = type), alpha = .33) +
      geom_line(aes(y=p50, col = type), size = 1) +
      geom_point(aes(y=p50, size = n, col = type), alpha = .50) + 
      scale_color_manual(name = "Prices", 
                         values = c("Rent" = "#00AFBB", "Airbnb" = "#E7B800")) +
      scale_fill_manual(name = "Prices", 
                        values = c("Rent" = "#00AFBB", "Airbnb" = "#E7B800")) +
      scale_size(
        limits = c(min(APM_sa2$record_count_int),
                   max(max(APM_sa2$record_count_int), max(APM_sa2$n_listings))), 
        range = c(1, 7)
      ) +
      scale_y_continuous(limits = c(0, NA)) +
      facet_wrap(~type, scales = "free_y") +
      theme_minimal() + xlab("") + ylab("Weekly median rent / AWR") + 
      labs(size = "Properites (rent) \nListings (AWR)",
           caption = caption_house,
           title = paste0("Houses in ", temp[i]))
    
    path <- paste0("plot/apm/awr_2/", temp[i], " - house", ".png")
    
    ggsave(path, width = 8, height = 4.5, dpi = "retina")
    
  }
  
  if (nrow(label_unit) > 0) {
    
    bind_rows(
      
      overlap %>%
        filter(SA2_NAME16 == temp[i]) %>% 
        filter(property_type == "Unit") %>% 
        select(date, rent_25p_int, rent_50p_int, rent_75p_int, record_count) %>% 
        rename(p25 = rent_25p_int, p50 = rent_50p_int, 
               p75 = rent_75p_int, n = record_count) %>% 
        mutate(type = "Rent"),
      
      overlap %>%
        filter(SA2_NAME16 == temp[i]) %>% 
        filter(property_type == "Unit") %>% 
        select(date, awr_25p_int, awr_50p_int, awr_75p_int, n_listings) %>% 
        rename(p25 = awr_25p_int, p50 = awr_50p_int, 
               p75 = awr_75p_int, n = n_listings) %>% 
        mutate(type = "Airbnb") 
      
    ) %>% 
      ggplot(aes(x=date)) +
      geom_ribbon(aes(ymin=p25, ymax=p75, fill = type), alpha = .33) +
      geom_line(aes(y=p50, col = type), size = 1) +
      geom_point(aes(y=p50, size = n, col = type), alpha = .50) + 
      scale_color_manual(name = "Prices", 
                         values = c("Rent" = "#00AFBB", "Airbnb" = "#E7B800")) +
      scale_fill_manual(name = "Prices", 
                        values = c("Rent" = "#00AFBB", "Airbnb" = "#E7B800")) +
      scale_size(
        limits = c(min(APM_sa2$record_count_int),
                   max(max(APM_sa2$record_count_int), max(APM_sa2$n_listings))), 
        range = c(1, 7)
      ) +
      scale_y_continuous(limits = c(0, NA)) +
      facet_wrap(~type, scales = "free_y") +
      theme_minimal() + xlab("") + ylab("Weekly median rent / AWR") + 
      labs(size = "Properites (rent) \nListings (ADR)",
           caption = caption_unit,
           title = paste0("Units in ", temp[i]))
    
    path <- paste0("plot/apm/awr_2/", temp[i], " - unit", ".png")
    
    ggsave(path, width = 8, height = 4.5, dpi = "retina")
    
  }
  
}
```

Example data for one region

![](plot/apm/awr_2/Arncliffe - Bardwell Valley - house.png)

![](plot/apm/awr_2/Arncliffe - Bardwell Valley - unit.png)

Separate Y axes!
Rest of areas on RDM.

<!-- ------------------------------------------------------------ --> 

# Correlations

```{r}
cor_dat_text <- 
  APM_sa2_cor %>%
  mutate(
    mean_apm = number(mean_apm, big.mark = ","),
    mean_airbnb = number(mean_airbnb, big.mark = ","),
    cor_25 = number(cor_25, accuracy = 0.01),
    cor_50 = number(cor_50, accuracy = 0.01),
    cor_75 = number(cor_75, accuracy = 0.01)
  ) 
```

## Data - houses

```{r}
p_load(DT)

cor_dat_text %>% 
  filter(property_type == "House") %>% 
  select(-SA2_MAIN16, -property_type) %>% 
  datatable(options = list(pageLength = 10), filter = "top")
```

## Data - units

```{r}
cor_dat_text %>% 
  filter(property_type == "Unit") %>% 
  select(-SA2_MAIN16, -property_type) %>% 
  datatable(options = list(pageLength = 10), filter = "top")
```

## Typology

Types defined as 

cor_50 >=  0.50 & cor_50 <   0.75 ~ "+",
cor_50 >=  0.75 & cor_50 <=  1.00 ~ "++",
cor_50 <= -0.50 & cor_50 >  -0.75 ~ "-",
cor_50 <= -0.75 & cor_50 >= -1.00 ~ "--",
cor_50 <=  0.10 & cor_50 >= -0.10 ~ "OO",
otherwise "oo"

```{r}
APM_sa2_cor %>% 
  ggplot() +
  geom_histogram(aes(cor_50), binwidth = 0.1) + 
  facet_wrap(~property_type) +
  geom_vline(xintercept = c(-0.75, -0.5, -0.1, 0.1, 0.5, 0.75), col = "red")
```

```{r eval=FALSE, include=FALSE}
APM_sa2_cor %>% 
  ggplot() +
  geom_histogram(aes(cor_50), binwidth = 0.1) + 
  facet_wrap(~property_type) +
  geom_vline(xintercept = c(-0.66, -0.33, 0.33, 0.66), col = "red")
```

```{r }
APM_sa2_cor %<>% 
  mutate(cor_type = case_when(
    cor_50 >=  0.50 & cor_50 <   0.75 ~ "+",
    cor_50 >=  0.75 & cor_50 <=  1.00 ~ "++",
    cor_50 >  -0.75 & cor_50 <= -0.50 ~ "-",
    cor_50 >= -1.00 & cor_50 <= -0.75 ~ "--",
    cor_50 >= -0.10 & cor_50 <=  0.10 ~ "OO",
    TRUE ~ "oo"
  )
  )

# select(APM_sa2_cor, SA2_MAIN16, property_type, cor_type) %>%
#   left_join(APM_sa2) %>%
#   ggplot(aes(x = date)) +
#   geom_point(aes(x = rent_50p_int, y = awr_50p_int)) +
#   facet_grid(cor_type~property_type)

frq(APM_sa2_cor, cor_type)
```

### ++ type

```{r}
APM_sa2_cor %>% 
  filter(cor_type == "++") %>% 
  select(SA2_NAME16, property_type, cor_50) %>% 
  datatable(options = list(pageLength = 10), filter = "top")
```

```{r}
plot_data <- SA2 %>% 
  left_join(select(APM_sa2_cor, 
                   SA2_MAIN16, property_type, cor_type) ) %>%
  filter(!is.na(cor_type)) %>% 
  filter(cor_type %in% c("++"))

# tm_shape(STE) +
#   tm_polygons(col = "grey", border.col = "white") +
tm_shape(plot_data) +
  tm_dots() +
  # tm_polygons(col = "red", border.col = NA) +
  tm_facets(by = "property_type", ncol = 2, free.coords = FALSE) 

# tmap_save(tmap_last(), 
#        filename = "plot.png", 
#        width = 20, height = 60, units = "cm", dpi = 320)

```

### -- type

```{r}
APM_sa2_cor %>% 
  filter(cor_type == "--") %>% 
  select(SA2_NAME16, property_type, cor_50) %>% 
  datatable(options = list(pageLength = 10), filter = "top")
```

```{r}
plot_data <- SA2 %>% 
  left_join(select(APM_sa2_cor, 
                   SA2_MAIN16, property_type, cor_type) ) %>%
  filter(!is.na(cor_type)) %>% 
  filter(cor_type %in% c("--"))

# tm_shape(STE) +
#   tm_polygons(col = "grey", border.col = "white") +
tm_shape(plot_data) +
  tm_dots() +
  # tm_polygons(col = "red", border.col = NA) +
  tm_facets(by = "property_type", ncol = 2, free.coords = FALSE) 

# tmap_save(tmap_last(), 
#        filename = "plot.png", 
#        width = 20, height = 60, units = "cm", dpi = 320)

```

### OO type

```{r}
APM_sa2_cor %>% 
  filter(cor_type == "OO") %>% 
  select(SA2_NAME16, property_type, cor_50) %>% 
  datatable(options = list(pageLength = 10), filter = "top")
```

```{r}
plot_data <- SA2 %>% 
  left_join(select(APM_sa2_cor, 
                   SA2_MAIN16, property_type, cor_type) ) %>%
  filter(!is.na(cor_type)) %>% 
  filter(cor_type %in% c("OO"))

# tm_shape(STE) +
#   tm_polygons(col = "grey", border.col = "white") +
tm_shape(plot_data) +
  tm_dots() +
  # tm_polygons(col = "red", border.col = NA) +
  tm_facets(by = "property_type", ncol = 2, free.coords = FALSE) 

# tmap_save(tmap_last(), 
#        filename = "plot.png", 
#        width = 20, height = 60, units = "cm", dpi = 320)

```


## Viz

```{r}
APM_sa2 %>% 
  filter(property_type == "Unit") %>% 
  dplyr::select(SA2_MAIN16, rent_50p_int, record_count_int, 
                adr_50p_int, n_listings_int)


```

<!-- ------------------------------------------------------------ --> 

# Custering of one trajectory (ADR)

## Houses

```{r}
house_awr_50p_int_wide <- 
  select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  filter(property_type == "House") %>% 
  left_join(APM_sa2) %>% 
  select(SA2_MAIN16, date, awr_50p_int) %>% 
  arrange(SA2_MAIN16, date) %>% 
  group_by(SA2_MAIN16) %>% 
  mutate(time = row_number()) %>% 
  ungroup() %>% 
  select(time, everything(), -date) %>% 
  pivot_wider(names_from = time, 
              values_from = awr_50p_int,
              names_prefix = "awr_house_")
```

```{r}
p_load(kml)

# names(house_50p_wide[, 2])
# names(house_50p_wide[, 28])

cld_house_awr_50p_int_wide <- cld(as.data.frame(house_awr_50p_int_wide))

# cld_house_awr_50p_int_wide

kml(cld_house_awr_50p_int_wide, nbClusters = 2:10, nbRedrawing = 100)

# cld_house_awr_50p_int_wide

# choice(cld_house_awr_50p_int_wide)

res_house_50p <- 
  bind_cols(
    SA2_MAIN16 = house_awr_50p_int_wide$SA2_MAIN16,
    property_type = rep("House", nrow(house_awr_50p_int_wide)),
    clusters_2 = getClusters(cld_house_awr_50p_int_wide, 2),
    clusters_3 = getClusters(cld_house_awr_50p_int_wide, 3),
    clusters_4 = getClusters(cld_house_awr_50p_int_wide, 4),
    clusters_5 = getClusters(cld_house_awr_50p_int_wide, 5),
    clusters_6 = getClusters(cld_house_awr_50p_int_wide, 6),
    clusters_7 = getClusters(cld_house_awr_50p_int_wide, 7),
    clusters_8 = getClusters(cld_house_awr_50p_int_wide, 8),
    clusters_9 = getClusters(cld_house_awr_50p_int_wide, 9)
  )

frq(res_house_50p, clusters_7)

select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  filter(property_type == "House") %>% 
  left_join(APM_sa2) %>% 
  left_join(res_house_50p) %>% 
  select(SA2_MAIN16, date, awr_50p_int, rent_50p_int, clusters_7) %>% 
  pivot_longer(cols = c(awr_50p_int, rent_50p_int),
               names_to = "measure", values_to = "money") %>% 
  ggplot() + 
  geom_smooth(aes(x = date, y = money, 
                  group = measure, col = measure)) +
  facet_wrap(~clusters_7)

select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  filter(property_type == "House") %>% 
  left_join(APM_sa2) %>% 
  left_join(res_house_50p) %>% 
  select(SA2_MAIN16, date, awr_50p_int, rent_50p_int, clusters_7) %>% 
  ggplot() + 
  geom_line(aes(x = date, y = awr_50p_int, 
                group = SA2_MAIN16)) +
  geom_smooth(aes(x = date, y = awr_50p_int, 
                  group = clusters_7)) +
  facet_wrap(~clusters_7)

temp <- 
  select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  filter(property_type == "House") %>% 
  left_join(APM_sa2) %>% 
  left_join(res_house_50p) %>% 
  group_by(clusters_7, date) %>% 
  summarize(rent_50p_int = mean(rent_50p_int),
            awr_50p_int = mean(awr_50p_int)) 
```

## Units

```{r}
unit_awr_50p_int_wide <- 
  select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  filter(property_type == "Unit") %>% 
  left_join(APM_sa2) %>% 
  select(SA2_MAIN16, date, awr_50p_int) %>% 
  arrange(SA2_MAIN16, date) %>% 
  group_by(SA2_MAIN16) %>% 
  mutate(time = row_number()) %>% 
  ungroup() %>% 
  select(time, everything(), -date) %>% 
  pivot_wider(names_from = time, 
              values_from = awr_50p_int,
              names_prefix = "awr_unit_")
```

```{r}
# names(unit_50p_wide[, 2])
# names(unit_50p_wide[, 28])

cld_unit_awr_50p_int_wide <- cld(as.data.frame(unit_awr_50p_int_wide))

kml(cld_unit_awr_50p_int_wide, nbClusters = 2:10, nbRedrawing = 100)

# cld_unit_awr_50p_int_wide

# choice(cld_unit_awr_50p_int_wide)

res_unit_50p <- 
  bind_cols(
    SA2_MAIN16 = unit_awr_50p_int_wide$SA2_MAIN16,
    property_type = rep("Unit", nrow(unit_awr_50p_int_wide)),
    clusters_2 = getClusters(cld_unit_awr_50p_int_wide, 2),
    clusters_3 = getClusters(cld_unit_awr_50p_int_wide, 3),
    clusters_4 = getClusters(cld_unit_awr_50p_int_wide, 4),
    clusters_5 = getClusters(cld_unit_awr_50p_int_wide, 5),
    clusters_6 = getClusters(cld_unit_awr_50p_int_wide, 6),
    clusters_7 = getClusters(cld_unit_awr_50p_int_wide, 7),
    clusters_8 = getClusters(cld_unit_awr_50p_int_wide, 8),
    clusters_9 = getClusters(cld_unit_awr_50p_int_wide, 9)
  )

frq(res_unit_50p, clusters_6)
# frq(res_unit_50p, clusters_7)
# frq(res_unit_50p, clusters_8)


select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  filter(property_type == "Unit") %>% 
  left_join(APM_sa2) %>% 
  left_join(res_unit_50p) %>% 
  select(SA2_MAIN16, date, awr_50p_int, rent_50p_int, clusters_6) %>% 
  pivot_longer(cols = c(awr_50p_int, rent_50p_int),
               names_to = "measure", values_to = "money") %>% 
  ggplot() + 
  geom_smooth(aes(x = date, y = money, 
                  group = measure, col = measure)) +
  facet_wrap(~clusters_6)

select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  filter(property_type == "Unit") %>% 
  left_join(APM_sa2) %>% 
  left_join(res_unit_50p) %>% 
  select(SA2_MAIN16, date, awr_50p_int, rent_50p_int, clusters_6) %>% 
  ggplot() + 
  geom_line(aes(x = date, y = awr_50p_int, 
                group = SA2_MAIN16)) +
  geom_smooth(aes(x = date, y = awr_50p_int, 
                  group = clusters_6)) +
  facet_wrap(~clusters_6)

temp <- 
  select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  filter(property_type == "House") %>% 
  left_join(APM_sa2) %>% 
  left_join(res_unit_50p) %>% 
  group_by(clusters_6, date) %>% 
  summarize(rent_50p_int = mean(rent_50p_int),
            awr_50p_int = mean(awr_50p_int)) 
```

```{r include=FALSE}
file.remove("cld_unit_awr_50p_int_wide.Rdata")
file.remove("cld_house_awr_50p_int_wide.Rdata")
```

<!-- ------------------------------------------------------------ --> 

# Custering of two trajectories

## Houses

```{r}
house_50p_wide <- left_join(
  select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
    filter(property_type == "House") %>% 
    left_join(APM_sa2) %>% 
    select(SA2_MAIN16, date, rent_50p_int) %>% 
    arrange(SA2_MAIN16, date) %>% 
    group_by(SA2_MAIN16) %>% 
    mutate(time = row_number()) %>% 
    ungroup() %>% 
    select(time, everything(), -date) %>% 
    pivot_wider(names_from = time, 
                values_from = rent_50p_int,
                names_prefix = "rent_house_")
  ,
  select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
    filter(property_type == "House") %>% 
    left_join(APM_sa2) %>% 
    select(SA2_MAIN16, date, awr_50p_int) %>% 
    arrange(SA2_MAIN16, date) %>% 
    group_by(SA2_MAIN16) %>% 
    mutate(time = row_number()) %>% 
    ungroup() %>% 
    select(time, everything(), -date) %>% 
    pivot_wider(names_from = time, 
                values_from = awr_50p_int,
                names_prefix = "awr_house_")
)

```

```{r}
p_load(kml3d)

# names(house_50p_wide[, 2])
# names(house_50p_wide[, 28])
# names(house_50p_wide[, 29])
# names(house_50p_wide[, 55])

cld_house_50p <- cld3d(house_50p_wide, 
                       idAll = house_50p_wide$SA2_MAIN16, 
                       timeInData = list(rent = 2:28,
                                         adr = 29:55))

kml3d(cld_house_50p, nbClusters = 2:10, nbRedrawing = 100)

# cld_house_50p

# choice(cld_house_50p)

res_house_50p <- 
  bind_cols(
    SA2_MAIN16 = house_50p_wide$SA2_MAIN16,
    property_type = rep("House", nrow(house_50p_wide)),
    clusters_2 = getClusters(cld_house_50p, 2),
    clusters_3 = getClusters(cld_house_50p, 3),
    clusters_4 = getClusters(cld_house_50p, 4),
    clusters_5 = getClusters(cld_house_50p, 5),
    clusters_6 = getClusters(cld_house_50p, 6),
    clusters_7 = getClusters(cld_house_50p, 7),
    clusters_8 = getClusters(cld_house_50p, 8),
    clusters_9 = getClusters(cld_house_50p, 9)
  )

frq(res_house_50p, clusters_2)
# frq(res_house_50p, clusters_6)
# frq(res_house_50p, clusters_9)

select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  filter(property_type == "House") %>% 
  left_join(APM_sa2) %>% 
  left_join(res_house_50p) %>% 
  select(SA2_MAIN16, date, awr_50p_int, rent_50p_int, clusters_2) %>% 
  pivot_longer(cols = c(awr_50p_int, rent_50p_int),
               names_to = "measure", values_to = "money") %>% 
  ggplot() + 
  geom_smooth(aes(x = date, y = money, 
                  group = measure, col = measure)) +
  facet_wrap(~clusters_2)

temp <- 
  select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  filter(property_type == "House") %>% 
  left_join(APM_sa2) %>% 
  left_join(res_house_50p) %>% 
  group_by(clusters_2, date) %>% 
  summarize(rent_50p_int = mean(rent_50p_int),
            awr_50p_int = mean(awr_50p_int)) 

# select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
#   filter(property_type == "House") %>% 
#   left_join(APM_sa2) %>% 
#   left_join(res_house_50p) %>% 
#   select(SA2_MAIN16, date, awr_50p_int, rent_50p_int, clusters_6) %>% 
#   pivot_longer(cols = c(awr_50p_int, rent_50p_int),
#                names_to = "measure", values_to = "money") %>% 
#   ggplot() + 
#   geom_smooth(aes(x = date, y = money, 
#                   group = measure, col = measure)) +
#   facet_wrap(~clusters_6)
# 
# select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
#   filter(property_type == "House") %>% 
#   left_join(APM_sa2) %>% 
#   left_join(res_house_50p) %>% 
#   select(SA2_MAIN16, date, awr_50p_int, rent_50p_int, clusters_9) %>% 
#   pivot_longer(cols = c(awr_50p_int, rent_50p_int),
#                names_to = "measure", values_to = "money") %>% 
#   ggplot() + 
#   geom_smooth(aes(x = date, y = money, 
#                   group = measure, col = measure)) +
#   facet_wrap(~clusters_9)
```

## Units

```{r}
unit_50p_wide <- left_join(
  select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
    filter(property_type == "Unit") %>% 
    left_join(APM_sa2) %>% 
    select(SA2_MAIN16, date, rent_50p_int) %>% 
    arrange(SA2_MAIN16, date) %>% 
    group_by(SA2_MAIN16) %>% 
    mutate(time = row_number()) %>% 
    ungroup() %>% 
    select(time, everything(), -date) %>% 
    pivot_wider(names_from = time, 
                values_from = rent_50p_int,
                names_prefix = "rent_unit_")
  ,
  select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
    filter(property_type == "Unit") %>% 
    left_join(APM_sa2) %>% 
    select(SA2_MAIN16, date, awr_50p_int) %>% 
    arrange(SA2_MAIN16, date) %>% 
    group_by(SA2_MAIN16) %>% 
    mutate(time = row_number()) %>% 
    ungroup() %>% 
    select(time, everything(), -date) %>% 
    pivot_wider(names_from = time, 
                values_from = awr_50p_int,
                names_prefix = "awr_unit_")
)

```

```{r}
cld_unit_50p <- cld3d(unit_50p_wide, 
                      idAll = unit_50p_wide$SA2_MAIN16, 
                      timeInData = list(rent = 2:28,
                                        adr = 29:55))

kml3d(cld_unit_50p, nbClusters = 2:10, nbRedrawing = 100)

# cld_unit_50p

# choice(cld_unit_50p)

res_unit_50p <- 
  bind_cols(
    SA2_MAIN16 = unit_50p_wide$SA2_MAIN16,
    property_type = rep("Unit", nrow(unit_50p_wide)),
    clusters_2 = getClusters(cld_unit_50p, 2),
    clusters_3 = getClusters(cld_unit_50p, 3),
    clusters_4 = getClusters(cld_unit_50p, 4),
    clusters_5 = getClusters(cld_unit_50p, 5),
    clusters_6 = getClusters(cld_unit_50p, 6),
    clusters_7 = getClusters(cld_unit_50p, 7),
    clusters_8 = getClusters(cld_unit_50p, 8),
    clusters_9 = getClusters(cld_unit_50p, 9)
  )

frq(res_unit_50p, clusters_3)
# frq(res_unit_50p, clusters_6)
# frq(res_unit_50p, clusters_9)

select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  filter(property_type == "Unit") %>% 
  left_join(APM_sa2) %>% 
  left_join(res_unit_50p) %>% 
  select(SA2_MAIN16, date, awr_50p_int, rent_50p_int, clusters_3) %>% 
  pivot_longer(cols = c(awr_50p_int, rent_50p_int),
               names_to = "measure", values_to = "money") %>% 
  ggplot() + 
  geom_smooth(aes(x = date, y = money, 
                  group = measure, col = measure)) +
  facet_wrap(~clusters_3)

temp <- 
  select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  filter(property_type == "Unit") %>% 
  left_join(APM_sa2) %>% 
  left_join(res_unit_50p) %>% 
  group_by(clusters_3, date) %>% 
  summarize(rent_50p_int = mean(rent_50p_int),
            awr_50p_int = mean(awr_50p_int)) 

# select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
#   filter(property_type == "Unit") %>% 
#   left_join(APM_sa2) %>% 
#   left_join(res_unit_50p) %>% 
#   select(SA2_MAIN16, date, awr_50p_int, rent_50p_int, clusters_6) %>% 
#   pivot_longer(cols = c(awr_50p_int, rent_50p_int),
#                names_to = "measure", values_to = "money") %>% 
#   ggplot() + 
#   geom_smooth(aes(x = date, y = money, 
#                   group = measure, col = measure)) +
#   facet_wrap(~clusters_6)
# 
# select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
#   filter(property_type == "Unit") %>% 
#   left_join(APM_sa2) %>% 
#   left_join(res_unit_50p) %>% 
#   select(SA2_MAIN16, date, awr_50p_int, rent_50p_int, clusters_9) %>% 
#   pivot_longer(cols = c(awr_50p_int, rent_50p_int),
#                names_to = "measure", values_to = "money") %>% 
#   ggplot() + 
#   geom_smooth(aes(x = date, y = money, 
#                   group = measure, col = measure)) +
#   facet_wrap(~clusters_9)
```


```{r include=FALSE}
file.remove("cld_unit_50p.Rdata")
file.remove("cld_house_50p.Rdata")
```

<!-- ------------------------------------------------------------ --> 

# Animation

```{r}
# using full dataset again
APM_sa2 <- readRDS("data/APM/clean/APM_sa2.Rds") %>% 
  mutate(awr_25p_int = 7*adr_25p_int,
         awr_50p_int = 7*adr_50p_int,
         awr_75p_int = 7*adr_75p_int) %>% 
  mutate(awr_25p_int = as.integer(round(adr_25p_int)),
         awr_50p_int = as.integer(round(adr_50p_int)),
         awr_75p_int = as.integer(round(adr_75p_int)))

# https://www.r-graph-gallery.com/271-ggplot2-animated-gif-chart-with-gganimate.html
p_load(gganimate)
# options(gganimate.dev_args = list(width = 12, height = 10, 
#                                   units = 'in', res=320))

max <- max(max(APM_sa2$rent_50p_int), max(APM_sa2$awr_50p_int))

summary(APM_sa2$record_count_int)

anime <- APM_sa2 %>% 
  # filter(date == ymd("2019-02-01")) %>%
  ggplot(aes(rent_50p_int, awr_50p_int, 
             size = record_count_int, 
             color = STE_NAME16)) +
  geom_point(alpha = 0.5) +
  scale_size(range = c(4, 10)) +
  scale_x_sqrt(limits = c(0, max)) +
  scale_y_sqrt(limits = c(0, max)) +
  coord_fixed() +
  guides(colour = guide_legend(title = "State",
                               override.aes = list(size = 10)),
         size = guide_legend(title = "No of properties")) +  
  theme_bw(base_size = 22) +
  labs(title = 'Year: {frame_time}', 
       x = 'Median rent', 
       y = 'Median AWR') +
  transition_time(date) +
  ease_aes('linear')

animate(anime, height = 1000, width = 1200)
anim_save("./plot/apm_rent_animated.gif")

# devtools::install_github("thomasp85/transformr")

anime <- APM_sa2 %>% 
  # filter(date == ymd("2019-02-01")) %>%
  ggplot(aes(rent_50p_int, awr_50p_int, 
             size = record_count_int, 
             color = STE_NAME16)) +
  geom_point(alpha = 0.5) +
  geom_smooth(aes(weight = record_count_int), 
              se = FALSE, col = "black") +
  facet_wrap(~STE_NAME16) +
  scale_x_sqrt(limits = c(0, max)) +
  scale_y_sqrt(limits = c(0, max)) +
  coord_fixed() +
  guides(colour = guide_legend(title = "State",
                               override.aes = list(size = 10)),
         size = guide_legend(title = "No of properties")) +  
  theme_bw(base_size = 22) +
  labs(title = 'Year: {frame_time}', 
       x = 'Median rent', 
       y = 'Median AWR') +
  transition_time(date) +
  ease_aes('linear')

animate(anime, height = 1000, width = 1200)
anim_save("./plot/apm_rent_animated_facet.gif")
```

<!-- ------------------------------------------------------------ --> 

# Session info

```{r}
sessionInfo()
```
---
title: "Airbnb - relation between rent & Airbnb revenue and supply on SA2 level"
subtitle: "Models"
author: "Radoslaw Panczak"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    highlight: pygments
    number_sections: yes
    theme: united
    toc: yes
    toc_depth: 4
    toc_float: yes
---

<!-- ------------------------------------------------------------ --> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      message = TRUE, 
                      warning = TRUE, 
                      cache = FALSE,
                      fig.width=8, fig.height=6, 
                      out.width="800px", out.height="600px", 
                      dpi=300)

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
set.seed(12345)
options(scipen = 999)

library(pacman) 
p_load(tidyverse, magrittr, lubridate, scales, readxl, janitor, imputeTS,
       sf, tmap, tmaptools, 
       ggridges, skimr, summarytools, sjmisc, kableExtra, naniar
)

tmap_mode("view") # makes map interactive
```


```{r include=FALSE}
APM_sa2 <- readRDS("data/APM/clean/APM_sa2.Rds") %>% 
  mutate(adr_25p_int = 7*adr_25p_int,
         adr_50p_int = 7*adr_50p_int,
         adr_75p_int = 7*adr_75p_int) %>% 
  mutate(adr_25p_int = as.integer(round(adr_25p_int)),
         adr_50p_int = as.integer(round(adr_50p_int)),
         adr_75p_int = as.integer(round(adr_75p_int)))

SA2 <- readRDS(file = "./data/geo/SA2_2016_AUST_clean.rds") %>% 
  filter(! SA2_5DIG16 %in% c("91001", "91002", "91004", "11161")) %>% 
  select(-starts_with("SA3")) %>% 
  select(-starts_with("SA1")) %>% 
  select(-starts_with("GCC")) %>% 
  select(-AREASQKM16, -SA4_CODE16, -SA4_NAME16) %>% 
  mutate(STE_CODE16 = as.numeric(as.character(STE_CODE16))) %>% 
  mutate(SA2_MAIN16 = as.numeric(as.character(SA2_MAIN16))) %>% 
  mutate(SA2_5DIG16 = as.numeric(as.character(SA2_5DIG16))) 

SA2_U_include <- readRDS("data/APM/clean/SA2_U_include.Rds")
SA2_U_centr_include <- readRDS("data/APM/clean/SA2_U_centr_include.Rds")

SA2_H_include <- readRDS("data/APM/clean/SA2_H_include.Rds")
SA2_H_centr_include <- readRDS("data/APM/clean/SA2_H_centr_include.Rds")

STE <- readRDS(file = "./data/geo/STE_2016_AUST_clean.rds") %>%  
  mutate(STE_CODE16 = as.numeric(as.character(STE_CODE16))) %>% 
  filter(STE_CODE16 != 9) 

```

<!-- ------------------------------------------------------------ --> 

# Selection

```{r include=FALSE}
hist(APM_sa2$record_count)
summary(APM_sa2$record_count)

hist(APM_sa2$n_listings)
summary(APM_sa2$n_listings)

APM_sa2_cor <- 
  APM_sa2 %>%
  filter(!is.na(rent_50p_int)) %>%
  filter(!is.na(adr_50p_int)) %>%
  group_by(SA2_MAIN16, SA2_NAME16, property_type) %>% 
  summarize(
    min_apm = min(record_count, na.rm = TRUE),
    min_airbnb = min(n_listings, na.rm = TRUE),
    mean_apm = mean(record_count, na.rm = TRUE),
    mean_airbnb = mean(n_listings, na.rm = TRUE),
    cor_25 = cor(rent_25p_int, adr_25p_int),
    cor_50 = cor(rent_50p_int, adr_50p_int),
    cor_75 = cor(rent_75p_int, adr_75p_int)
  ) %>% 
  ungroup() %>% 
  filter(min_apm >= 25) %>%
  filter(min_airbnb >= 10)

summary(APM_sa2_cor$mean_airbnb)
summary(APM_sa2_cor$mean_apm)

summary(APM_sa2_cor$min_airbnb)
summary(APM_sa2_cor$min_apm)

SA2_H_include %<>% 
  inner_join(APM_sa2_cor %>% 
               filter(property_type == "House") %>% select(SA2_MAIN16))
SA2_H_centr_include %<>% 
  inner_join(APM_sa2_cor %>% 
               filter(property_type == "House") %>% select(SA2_MAIN16))

SA2_U_include %<>% 
  inner_join(APM_sa2_cor %>% 
               filter(property_type == "Unit") %>% select(SA2_MAIN16))
SA2_U_centr_include %<>% 
  inner_join(APM_sa2_cor %>% 
               filter(property_type == "Unit") %>% select(SA2_MAIN16))

```

<!-- ------------------------------------------------------------ --> 

# Data

**Houses, WA & NSW only**

```{r}
data <- 
  select(APM_sa2_cor, SA2_MAIN16, property_type) %>% 
  filter(property_type == "House") %>% 
  left_join(APM_sa2) %>% 
  # filter(STE_NAME16 == "New South Wales") %>%
  # filter(STE_NAME16 == "Western Australia") %>%
  filter(STE_NAME16 %in% c("New South Wales", "Western Australia")) %>%
  group_by(SA2_MAIN16) %>% 
  mutate(time = row_number()) %>% 
  ungroup() %>% 
  select(-property_type)

data %>% select(SA2_MAIN16) %>% distinct() %>% nrow()

ggplot(data, aes(x = date, y = rent_50p_int)) +
  geom_line(aes(group = SA2_MAIN16), alpha = .5) +
  # geom_smooth(method = "lm", se = FALSE) + 
  geom_smooth(aes(weight = record_count)) +
  theme_minimal() + 
  facet_wrap(~STE_NAME16)

ggplot(data, aes(x = date, y = adr_50p_int)) +
  geom_line(aes(group = SA2_MAIN16), alpha = .5) +
  # geom_smooth(method = "lm", se = FALSE) + 
  geom_smooth(aes(weight = n_listings_int)) +
  theme_minimal() + 
  facet_wrap(~STE_NAME16)


ggplot(data, aes(x = rent_50p_int, y = adr_50p_int)) +
  geom_point(aes(size = n_listings_int)) +
  # geom_smooth(aes(weight = n_listings_int), method = "lm", se = FALSE)
  geom_smooth(aes(weight = n_listings_int)) +
  theme_minimal() + 
  facet_wrap(~STE_NAME16)


ggplot(data, aes(x = rent_50p_int, y = adr_50p_int)) +
  # geom_point(aes(size = n_listings_int, col = STE_NAME16)) +
  # geom_smooth(aes(weight = n_listings_int), method = "lm", se = FALSE) +
  geom_smooth(aes(weight = n_listings_int, col = STE_NAME16)) +
  facet_wrap(~time) +
  theme_minimal() +
  theme(strip.text.x = element_blank()) 

length(unique(data$SA2_MAIN16))

data %>% 
  # filter(SA2_NAME16 %in% c("Sydney - Haymarket - The Rocks", "Margaret River")) %>%
  ggplot(aes(x = time, y = rent_50p_int)) +
  # annotate("text", x = 0, y = 200, label = unique(data$SA2_NAME16)) +
  # geom_point(aes(size = record_count), alpha = 0.3) +
  geom_smooth(aes(group = interaction(SA2_NAME16, STE_NAME16),
                  weight = n_listings_int,
                  col = STE_NAME16), 
              method = "lm", weight = record_count_int, se = FALSE) +
  # geom_smooth(aes(group = interaction(SA2_NAME16, STE_NAME16),
  #                 weight = n_listings_int,
  #                 col = STE_NAME16), se = FALSE) +
  facet_wrap(STE_NAME16~SA2_NAME16) +
  theme_minimal() +
  theme(strip.text.x = element_blank()) 

ggplot(data, aes(x = time, y = adr_50p_int, group = SA2_NAME16)) +
  # annotate("text", x = 0, y = 200, label = unique(data$SA2_NAME16)) +
  # geom_point(aes(size = n_listings_int), alpha = 0.3) +
  # geom_smooth(aes(group = interaction(SA2_NAME16, STE_NAME16),
  #                 col = STE_NAME16), 
  #             weight = n_listings_int, 
  #             method = "lm", se = FALSE) +
  geom_smooth(aes(group = interaction(SA2_NAME16, STE_NAME16),
                  weight = n_listings_int, 
                  col = STE_NAME16), se = FALSE) +
  facet_wrap(STE_NAME16~SA2_NAME16) +
  theme_minimal() +
  theme(strip.text.x = element_blank()) 

```


<!-- ------------------------------------------------------------ --> 

# Models

## random region + cat state

```{r}
p_load(nlme, sjPlot, ggeffects, performance)

m1 <- lme(rent_50p_int ~ adr_50p_int + time + STE_NAME16, 
          random = ~ 1 | SA2_MAIN16, 
          data = data)

summary(m1)

data$m1_fit <- fitted(m1)

ggplot(data, aes(x = rent_50p_int)) +
  geom_point(aes(y = m1_fit, size = n_listings_int), 
             alpha = 0.3) +
  geom_line(aes(y = rent_50p_int), col = "darkorchid4") +
  facet_wrap(~STE_NAME16) +
  theme_minimal() + xlab("Rent") + ylab("Predicted") 

```

## random region + random state

```{r}
m2 <- lme(rent_50p_int ~ adr_50p_int + time, 
          random = ~ 1 | STE_NAME16/SA2_MAIN16, 
          data = data)

summary(m2)

data$m2_fit <- fitted(m2)

ggplot(data, aes(x = rent_50p_int)) +
  geom_point(aes(y = m2_fit, size = n_listings_int), 
             alpha = 0.3) +
  geom_line(aes(y = rent_50p_int), col = "darkorchid4") +
  facet_wrap(~STE_NAME16) +
  theme_minimal() + xlab("Rent") + ylab("Predicted") 

plot(ggpredict(m2, "time"))

plot(ggpredict(m2, terms = "adr_50p_int"))

```

## random time region

```{r}
m3 <- lme(rent_50p_int ~ adr_50p_int + time, 
          random = ~ time | STE_NAME16/SA2_MAIN16, 
          data = data)

summary(m3)

anova(m2, m3) 

data$m3_fit <- fitted(m3)

ggplot(data, aes(x = rent_50p_int)) +
  geom_point(aes(y = m3_fit, size = n_listings_int), 
             alpha = 0.3) +
  geom_line(aes(y = rent_50p_int), col = "darkorchid4") +
  facet_wrap(~STE_NAME16) +
  theme_minimal() + xlab("Rent") + ylab("Predicted") 

plot(ggpredict(m3, "time"))
# plot(ggpredict(m3, terms = c("time", "STE_NAME16")))

plot(ggpredict(m3, terms = "adr_50p_int"))
# plot(ggpredict(m3, terms = c("adr_50p_int", "STE_NAME16")))

```

## random region AR1

```{r}
m4 <- lme(rent_50p_int ~ adr_50p_int + time, 
          random = ~ 1 | STE_NAME16/SA2_MAIN16, 
          correlation = corAR1(), 
          data = data)

summary(m4)

anova(m3, m4) 

data$m4_fit <- fitted(m4)

ggplot(data, aes(x = rent_50p_int)) +
  geom_point(aes(y = m1_fit, size = n_listings_int), 
             alpha = 0.3) +
  geom_line(aes(y = rent_50p_int), col = "darkorchid4") +
  facet_wrap(~STE_NAME16) +
  theme_minimal() + xlab("Rent") + ylab("Predicted") 

plot(ggpredict(m4, "time"))

plot(ggpredict(m3, terms = "adr_50p_int"))

# fixef(m4)
# ranef(m4)
# plot(ACF(m4), alpha = 0.05)
```

## random time region AR1

```{r}
m5 <- lme(rent_50p_int ~ adr_50p_int + time, 
          random = ~ time | STE_NAME16/SA2_MAIN16, 
          correlation = corAR1(form = ~ time | STE_NAME16/SA2_MAIN16), 
          data = data)

# summary(m5)
# 
# anova(m4, m5) 
# 
# data$m5_fit <- fitted(m5)
# 
# ggplot(data, aes(x = rent_50p_int)) +
#   geom_point(aes(y = m1_fit, size = n_listings_int), 
#              alpha = 0.3) +
#   geom_line(aes(y = rent_50p_int), col = "darkorchid4") +
#   facet_wrap(~STE_NAME16) +
#   theme_minimal() + xlab("Rent") + ylab("Predicted") 
# 
# plot(ggpredict(m5, "time"))
# 
# plot(ggpredict(m5, terms = "adr_50p_int"))

# fixef(m5)
# ranef(m5)
# plot(ACF(m5), alpha = 0.05)
```

## Comparison

```{r}
compare_performance(m2, m3, m4)
```

## Prediction

### WA 

```{r}
data %>% 
  filter(SA2_NAME16 %in% 
           c("Busselton", 
             "Margaret River", 
             "City Beach")) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = m3_fit, group = SA2_NAME16), 
            col = "darkorchid4") +
  geom_point(aes(y = rent_50p_int, size = record_count), 
             col = "#00AFBB", alpha = 0.3) +
  # geom_point(aes(y = adr_50p_int, size = n_listings_int), 
  #            col = "#E7B800", alpha = 0.33) +
  theme_minimal() + 
  xlab("Rent") + ylab("Fitted") + 
  facet_wrap(~SA2_NAME16, scales = "free_y")
```

### NSW

```{r}
data %>% 
  filter(SA2_NAME16 %in% 
           c("Byron Bay", 
             "Huskisson - Vincentia", 
             "Avalon - Palm Beach")) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = m3_fit, group = SA2_NAME16), 
            col = "darkorchid4") +
  geom_point(aes(y = rent_50p_int, size = record_count_int), 
             col = "#00AFBB", alpha = 0.3) +
  # geom_point(aes(y = adr_50p_int, size = n_listings_int), 
  #            col = "#E7B800", alpha = 0.33) +
  theme_minimal() + 
  xlab("") + ylab("Rent / fitted") + 
  facet_wrap(~SA2_NAME16, scales = "free_y")
```

## ST outliers

```{r}
data$diff <- (data$rent_50p_int - data$m3_fit) / data$rent_50p_int
```

### WA 

```{r}
data %>% 
  filter(SA2_NAME16 %in% 
           c("Floreat", 
             "Mosman Park - Peppermint Grove", 
             "City Beach")) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = m3_fit, group = SA2_NAME16), 
            col = "darkorchid4") +
  geom_point(aes(y = rent_50p_int, size = record_count_int), 
             col = "#00AFBB", alpha = 0.3) +
  # geom_point(aes(y = adr_50p_int, size = n_listings_int), 
  #            col = "#E7B800", alpha = 0.33) +
  theme_minimal() + 
  xlab("") + ylab("Rent / fitted") + 
  facet_wrap(~SA2_NAME16, scales = "free_y")
```

### NSW

```{r}
data %>% 
  filter(SA2_NAME16 %in% 
           c("Broulee - Tomakin", "Jindabyne - Berridale", "Sydney - Haymarket - The Rocks")) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = m3_fit, group = SA2_NAME16), 
            col = "darkorchid4") +
  geom_point(aes(y = rent_50p_int, size = record_count_int), 
             col = "#00AFBB", alpha = 0.3) +
  # geom_point(aes(y = adr_50p_int, size = n_listings_int), 
  #            col = "#E7B800", alpha = 0.33) +
  theme_minimal() + 
  xlab("") + ylab("Rent / fitted") + 
  facet_wrap(~SA2_NAME16, scales = "free_y")
```

# Testing `lme4`

## random region + cat state

```{r}
p_load(lme4, ggeffects, performance)

m1 <- lmer(rent_50p_int ~ adr_50p_int + time + STE_NAME16 +
             (1 | SA2_MAIN16), 
           data = data)

summary(m1)
# confint(m1)
```

## random region + random state

```{r}
m2 <- lmer(rent_50p_int ~ adr_50p_int + time + 
             (1 | STE_NAME16/SA2_MAIN16), 
           data = data)

summary(m2)
# confint(m2)
```

## random time region

```{r}
m3 <- lmer(rent_50p_int ~ adr_50p_int + time + 
             (1 + time | STE_NAME16/SA2_MAIN16), 
           data = data)

summary(m3)
# confint(m3)

anova(m2, m3) 
```

## Comparison

```{r}
tab_model(m2, m3)

performance::compare_performance(m2, m3)
performance::model_performance(m3)

performance::check_singularity(m3)
performance::check_model(m3, panel = FALSE)
performance::r2(m3) 
performance::icc(m2) 
insight::get_variance(m2)

```

# Testing INLA

```{r echo=TRUE, results='hide'}
# ####
# Jeffreys prior 
a1 <- 5e-5
b1 <- 5e-5
lgprior1 <- list(prec = list(param = c(a1, b1)))

# Gelman prior
a2 <- -0.5
b2 <- 5e-5
lgprior2 <- list(prec = list(param = c(a2, b2)))

# iid prior 
# Schrödle & Held 2010 & Blangiardo et al 2013
a0 <- 1
b0 <- 0.1
prior.nu <- list(prec = list(param = c(a0, b0)))

# intercept & fixed
inla.set.control.fixed.default() 

# intercept ~ N(0,0) 
# other fixed effects ~ N(0, 0.001) 
# 
# where the format is N(mean, precision) 
# precision = inverse of the variance. 

# PC prior
U <- 1
hyper.prec = list(theta = list(
  prior = "pc.prec",
  param = c(U, 0.01)
))

# scaling
inla.setOption(scale.model.default = TRUE)

```

## random region

```{r}
# https://becarioprecario.bitbucket.io/inla-gitbook/ch-multilevel.html#multilevel-models-for-longitudinal-data

p_load(INLA, INLAutils)

f1 <- rent_50p_int ~ 1 + adr_50p_int + time +
  f(STE_NAME16, model = "iid") + 
  f(SA2_NAME16, model = "iid") 

m1 <- inla(f1, data = data,
           control.compute = list(dic= TRUE, waic = TRUE))

summary(m1)
# plot(m1)
autoplot(m1)

m1_sa2 <- m1$summary.random$SA2_NAME16
m1_fit <- m1$summary.fitted.values

m1_fit$SA2_NAME16 <- data$SA2_NAME16
m1_fit$x <- data$time
m1_fit$rent_50p_int <- data$rent_50p_int
m1_fit$n_listings <- data$n_listings

ggplot(m1_fit, aes(x = rent_50p_int)) +
  geom_line(aes(y = rent_50p_int), col = "darkorchid4") +
  geom_point(aes(y = `0.5quant`, size = n_listings), alpha = 0.3) +
  theme_minimal() + ylab("Predicted") + xlab("Rent")

m1_fit %>% 
  # filter(SA2_NAME16 == "Byron Bay") %>% 
  filter(SA2_NAME16 %in% c("Busselton", "Margaret River", "City Beach")) %>% 
  ggplot(aes(x = x)) +
  geom_ribbon(aes(ymin = `0.025quant`, ymax = `0.975quant`, group = SA2_NAME16), alpha=0.3) +
  geom_line(aes(y = `0.5quant`, group = SA2_NAME16), color = "purple") +
  geom_point(aes(y = rent_50p_int, col = SA2_NAME16, size = n_listings), 
             alpha = 0.5) +
  theme_minimal() + ylab("Rent") + xlab("Time")
```


## random time region

```{r}
f2 <- rent_50p_int ~ 1 + adr_50p_int +
  f(STE_NAME16, model = "iid") + 
  f(SA2_NAME16, time, model = "iid") 

m2 <- inla(f2, data = data,
           control.compute = list(dic= TRUE, waic = TRUE))

summary(m2)
# plot(m2)
autoplot(m2)

m2_sa2 <- m2$summary.random$SA2_NAME16
m2_fit <- m2$summary.fitted.values

m2_fit$SA2_NAME16 <- data$SA2_NAME16
m2_fit$x <- data$time
m2_fit$rent_50p_int <- data$rent_50p_int
m2_fit$n_listings <- data$n_listings

ggplot(m2_fit, aes(x = rent_50p_int)) +
  geom_line(aes(y = rent_50p_int), col = "darkorchid4") +
  geom_point(aes(y = `0.5quant`, size = n_listings), alpha = 0.3) +
  theme_minimal() + ylab("Predicted") + xlab("Rent")

m2_fit %>% 
  # filter(SA2_NAME16 == "Byron Bay") %>% 
  filter(SA2_NAME16 %in% c("Busselton", "Margaret River", "City Beach")) %>% 
  ggplot(aes(x = x)) +
  geom_ribbon(aes(ymin = `0.025quant`, ymax = `0.975quant`, group = SA2_NAME16), alpha=0.3) +
  geom_line(aes(y = `0.5quant`, group = SA2_NAME16), color = "purple") +
  geom_point(aes(y = rent_50p_int, col = SA2_NAME16, size = n_listings), 
             alpha = 0.5) +
  theme_minimal() + ylab("Rent") + xlab("Time")
```


## random region, smooth adr

```{r}
f3 <- rent_50p_int ~ 1 + time +
  f(adr_50p_int, model = "rw1", hyper = hyper.prec) +
  f(STE_NAME16, model = "iid") + 
  f(SA2_NAME16, model = "iid") 

m3 <- inla(f3, data = data,
           control.compute = list(dic= TRUE, waic = TRUE))

summary(m3)
# plot(m3)
autoplot(m3)

m3_sa2 <- m3$summary.random$SA2_NAME16
m3_fit <- m3$summary.fitted.values

m3_fit$SA2_NAME16 <- data$SA2_NAME16
m3_fit$x <- data$time
m3_fit$rent_50p_int <- data$rent_50p_int
m3_fit$n_listings <- data$n_listings

ggplot(m3_fit, aes(x = rent_50p_int)) +
  geom_line(aes(y = rent_50p_int), col = "darkorchid4") +
  geom_point(aes(y = `0.5quant`, size = n_listings), alpha = 0.3) +
  theme_minimal() + ylab("Predicted") + xlab("Rent")

m3_fit %>% 
  # filter(SA2_NAME16 == "Byron Bay") %>% 
  filter(SA2_NAME16 %in% c("Busselton", "Margaret River", "City Beach")) %>% 
  ggplot(aes(x = x)) +
  geom_ribbon(aes(ymin = `0.025quant`, ymax = `0.975quant`, group = SA2_NAME16), alpha=0.3) +
  geom_line(aes(y = `0.5quant`, group = SA2_NAME16), color = "purple") +
  geom_point(aes(y = rent_50p_int, col = SA2_NAME16, size = n_listings), 
             alpha = 0.5) +
  theme_minimal() + ylab("Rent") + xlab("Time")
```


## random region time, smooth adr

```{r}
f4 <- rent_50p_int ~ 1 + time +
  f(adr_50p_int, model = "rw1", hyper = hyper.prec) +
  f(STE_NAME16, model = "iid") + 
  f(SA2_NAME16, time, model = "iid") 

m4 <- inla(f4, data = data,
           control.compute = list(dic= TRUE, waic = TRUE))

summary(m4)
# plot(m4)
autoplot(m4)

m4_sa2 <- m4$summary.random$SA2_NAME16
m4_fit <- m4$summary.fitted.values

m4_fit$SA2_NAME16 <- data$SA2_NAME16
m4_fit$x <- data$time
m4_fit$rent_50p_int <- data$rent_50p_int
m4_fit$n_listings <- data$n_listings

ggplot(m4_fit, aes(x = rent_50p_int)) +
  geom_line(aes(y = rent_50p_int), col = "darkorchid4") +
  geom_point(aes(y = `0.5quant`, size = n_listings), alpha = 0.3) +
  theme_minimal() + ylab("Predicted") + xlab("Rent")

m4_fit %>% 
  # filter(SA2_NAME16 == "Byron Bay") %>% 
  filter(SA2_NAME16 %in% c("Busselton", "Margaret River", "City Beach")) %>% 
  ggplot(aes(x = x)) +
  geom_ribbon(aes(ymin = `0.025quant`, ymax = `0.975quant`, group = SA2_NAME16), alpha=0.3) +
  geom_line(aes(y = `0.5quant`, group = SA2_NAME16), color = "purple") +
  geom_point(aes(y = rent_50p_int, col = SA2_NAME16, size = n_listings), 
             alpha = 0.5) +
  theme_minimal() + ylab("Rent") + xlab("Time")
```


## random region, smooth adr, smooth time

```{r}
f5 <- rent_50p_int ~ 1 + 
  f(time, model = "rw1", hyper = hyper.prec) +
  f(adr_50p_int, model = "rw1", hyper = hyper.prec) +
  f(STE_NAME16, model = "iid") + 
  f(SA2_NAME16, model = "iid") 

m5 <- inla(f5, data = data,
           control.compute = list(dic= TRUE, waic = TRUE))

summary(m5)
# plot(m5)
autoplot(m5)

m5_sa2 <- m5$summary.random$SA2_NAME16
m5_fit <- m5$summary.fitted.values

m5_fit$SA2_NAME16 <- data$SA2_NAME16
m5_fit$x <- data$time
m5_fit$rent_50p_int <- data$rent_50p_int
m5_fit$n_listings <- data$n_listings

m5_fit$adr_50p_int <- data$adr_50p_int
m5_fit$record_count <- data$record_count

ggplot(m5_fit, aes(x = rent_50p_int)) +
  geom_line(aes(y = rent_50p_int), col = "darkorchid4") +
  geom_point(aes(y = `0.5quant`, size = n_listings), alpha = 0.3) +
  theme_minimal() + ylab("Predicted") + xlab("Rent")


m5_fit$diff <- (m5_fit$rent_50p_int - m5_fit$`0.5quant`) / m5_fit$rent_50p_int

m5_fit %>% 
  # filter(SA2_NAME16 == "Byron Bay") %>% 
  filter(SA2_NAME16 %in% c("Wembley Downs - Churchlands - Woodlands", 
                           "Floreat", "City Beach")) %>% 
  # filter(SA2_NAME16 %in% c("Busselton", "Margaret River", "City Beach")) %>% 
  ggplot(aes(x = x)) +
  geom_ribbon(aes(ymin = `0.025quant`, ymax = `0.975quant`, group = SA2_NAME16), alpha=0.3) +
  geom_line(aes(y = `0.5quant`, group = SA2_NAME16), color = "purple") +
  geom_point(aes(y = rent_50p_int, col = SA2_NAME16, size = n_listings), 
             alpha = 0.5) +
  # geom_point(aes(y = adr_50p_int, col = SA2_NAME16, size = record_count), 
  #            alpha = 0.5) +
  theme_minimal() + ylab("Rent") + xlab("Time")

m5_fit %>% 
  filter(SA2_NAME16 %in% c("City Beach")) %>% 
  ggplot(aes(x = x)) +
  geom_ribbon(aes(ymin = `0.025quant`, ymax = `0.975quant`, group = SA2_NAME16), alpha=0.3) +
  geom_line(aes(y = `0.5quant`, group = SA2_NAME16), color = "purple") +
  geom_point(aes(y = rent_50p_int, col = SA2_NAME16, size = n_listings), 
             alpha = 0.5) +
  geom_point(aes(y = adr_50p_int, col = SA2_NAME16, size = record_count), 
             alpha = 0.5) +
  theme_minimal() + ylab("Rent") + xlab("Time")

m5_fit %>% 
  filter(SA2_NAME16 %in% c("Floreat")) %>% 
  ggplot(aes(x = x)) +
  geom_ribbon(aes(ymin = `0.025quant`, ymax = `0.975quant`, group = SA2_NAME16), alpha=0.3) +
  geom_line(aes(y = `0.5quant`, group = SA2_NAME16), color = "purple") +
  geom_point(aes(y = rent_50p_int, col = SA2_NAME16, size = n_listings), 
             alpha = 0.5) +
  geom_point(aes(y = adr_50p_int, col = SA2_NAME16, size = record_count), 
             alpha = 0.5) +
  theme_minimal() + ylab("Rent") + xlab("Time")

m5_fit %>% 
  filter(SA2_NAME16 %in% c("Wembley Downs - Churchlands - Woodlands")) %>% 
  ggplot(aes(x = x)) +
  geom_ribbon(aes(ymin = `0.025quant`, ymax = `0.975quant`, group = SA2_NAME16), alpha=0.3) +
  geom_line(aes(y = `0.5quant`, group = SA2_NAME16), color = "purple") +
  geom_point(aes(y = rent_50p_int, col = SA2_NAME16, size = n_listings), 
             alpha = 0.5) +
  geom_point(aes(y = adr_50p_int, col = SA2_NAME16, size = record_count), 
             alpha = 0.5) +
  theme_minimal() + ylab("Rent") + xlab("Time")
```

## Comparison

```{r}
dotchart(c(m1$dic$dic, m2$dic$dic, m3$dic$dic, m4$dic$dic, m5$dic$dic),
         labels = c("mod1", "mod2", "mod3", "mod4", "mod5"), 
         main = "DIC")

dotchart(c(m1$waic$waic, m2$waic$waic, m3$waic$waic, m4$waic$waic, m5$waic$waic),
         labels = c("mod1", "mod2", "mod3", "mod4", "mod5"), 
         main = "WAIC")

```


<!-- ------------------------------------------------------------ --> 

# Session info

```{r}
sessionInfo()
```